<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš°ë¦¬ë°˜ ê°ì •ì¼ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* [ìˆ˜ì •] Noto Sans KR ëŒ€ì‹  Gowun Batang (ê³ ìš´ë°”íƒ•) í°íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤. */
        @import url('https://fonts.googleapis.com/css2?family=Gowun+Batang:wght@400;700&display=swap');
        
        /* [ìˆ˜ì •] bodyì˜ ê¸°ë³¸ í°íŠ¸ë¥¼ 'Gowun Batang'ìœ¼ë¡œ ë³€ê²½í•©ë‹ˆë‹¤. */
        body { font-family: 'Gowun Batang', serif; }
        
        .emotion-card:hover { transform: translateY(-2px); }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .floating-emotion {
            position: absolute;
            font-size: 2.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            animation: float 6s ease-in-out infinite;
            z-index: 10;
        }

        .floating-emotion:hover {
            transform: scale(1.3);
            z-index: 20;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            25% { transform: translateY(-10px) rotate(2deg); }
            50% { transform: translateY(-5px) rotate(-1deg); }
            75% { transform: translateY(-15px) rotate(1deg); }
        }

        /* [ìˆ˜ì •] íˆ´íŒ ë””ìì¸ ë³€ê²½: ë‘¥ê·¼ ì§ì‚¬ê°í˜• ì°½ìœ¼ë¡œ ë³€ê²½, ì‚ì¹¨ ì œê±° */
        .tooltip {
            position: fixed; /* íˆ´íŒì´ í™”ë©´ì— ê³ ì •ë˜ë„ë¡ ìˆ˜ì • */
            background: rgba(255, 255, 255, 0.95); /* í°ìƒ‰ ê¸°ë°˜ìœ¼ë¡œ ë³€ê²½ */
            color: #333; /* í…ìŠ¤íŠ¸ ìƒ‰ìƒ ë³€ê²½ */
            padding: 12px 16px;
            border-radius: 12px; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ */
            border: 1px solid #ddd; /* ê²½ê³„ì„  ì¶”ê°€ */
            font-size: 14px;
            white-space: normal;
            max-width: 300px;
            z-index: 30;
            pointer-events: none;
            opacity: 0;
            transform: translateY(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: opacity 0.3s, transform 0.3s;
        }

        .tooltip.show {
            opacity: 1;
            transform: translateY(0);
        }

        .tooltip::after {
            content: none; /* ì‚ì¹¨ ë¶€ë¶„ ì œê±° */
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .tab-button {
            transition: all 0.3s ease;
        }

        .tab-button.active {
            background-color: #fff;
            color: #4c51bf;
            border-color: #e0e7ff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        /* Loading spinner style */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #667eea; /* Blue */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* [ìˆ˜ì •] ì´ëª¨í‹°ì½˜ ë–¨ì–´ì§€ëŠ” ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes fallAndSettle {
            0% { 
                opacity: 0;
                /* [ìˆ˜ì •] ì‹œì‘ ë†’ì´ë¥¼ -500pxë¡œ ë³€ê²½ */
                transform: translateY(-500px) rotate(-180deg); 
            }
            60% {
                opacity: 1;
                transform: translateY(0) rotate(var(--final-rotate)); /* 1ì°¨ ë°”ìš´ìŠ¤ */
            }
            75% {
                transform: translateY(-10px) rotate(var(--final-rotate)); /* 2ì°¨ ë°”ìš´ìŠ¤ */
            }
            95% {
                transform: translateY(0) rotate(var(--final-rotate)); /* 3ì°¨ ë°”ìš´ìŠ¤ */
            }
            100% { 
                opacity: 1;
                transform: translateY(0) rotate(var(--final-rotate)); /* ìµœì¢… ìœ„ì¹˜ ê³ ì • */
            }
        }

        .falling-candy {
            /* [ìˆ˜ì •] ì• ë‹ˆë©”ì´ì…˜ ì‹œê°„ì„ 3ì´ˆì—ì„œ 6ì´ˆë¡œ ëŠ˜ë ¤ 2ë°° ëŠë¦¬ê²Œ í•¨ */
            animation: fallAndSettle 6s ease-out forwards; 
        }
    </style>


    <script>
    // --- ì´ˆê¸° ì„¤ì • ë° ë°ì´í„° ---
    // â­ 1. Google Apps Script ì›¹ ì•± URL
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwXACgqFbq9KL6VV0C5mrY2z9buQ1EIo8sXggck9RcdcLQkrad646ccx5WdaOJPoLsjIA/exec"; // ğŸ‘ˆ [ì¤‘ìš”] ì´ ë¶€ë¶„ì„ ì„ ìƒë‹˜ì˜ ìƒˆ GAS URLë¡œ êµì²´í•˜ì…”ì•¼ í•©ë‹ˆë‹¤.

    // â­ 2. ë°ì´í„° ìºì‹œ ë³€ìˆ˜
    let allDataCache = [];
    let dataLoaded = false; // ë°ì´í„° ë¡œë“œ ì™„ë£Œ í”Œë˜ê·¸

    const DB_NAME = 'emotionDiaryDB_v2'; // [ìˆ˜ì •] LocalStorage fallback nameì— ë²„ì „ ì¶”ê°€
    // const SHARE_LINK_DB_NAME = 'emotionDiaryShareLinks'; // [ì‚­ì œë¨]
    const SAMPLE_DATA_FLAG = 'sampleDataGenerated_v5_NoSample'; // [ìˆ˜ì •ë¨] ìƒ˜í”Œ ë°ì´í„° í”Œë˜ê·¸
    const TEACHER_PASSWORD = 'teacher572';
    const API_KEY = "AIzaSyDnAn0avxLdzICLBYitlpUMErEqB2jB97s"; // âœ¨ Gemini API í‚¤ [ìˆ˜ì •ë¨]
    const PENDING_DELETES = 'emotionDiary_pendingDeletes'; // [ì¶”ê°€ë¨]

    // â­ [ìˆ˜ì •] í•™ìƒ ì´ë¦„ ì œê±°
    const STUDENT_NUMBERS = ["2", "3", "4", "5", "6", "7", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "30"];
    
    const EMOTIONS = {positive:{'ê¸°ì¨':'ğŸ˜Š','ì„¤ë ˜':'ğŸ¤—','ë§Œì¡±':'ğŸ™‚','í‰ì˜¨í•¨':'ğŸ˜‡','ê°ì‚¬':'ğŸ¥°','ìì‹ ê°':'ğŸ˜','í¬ë§':'ğŸ˜Œ','ì¦ê±°ì›€':'ğŸ˜„','ì‚¬ë‘':'ğŸ˜','ë¿Œë“¯í•¨':'ğŸ¤©'},negative:{'ìŠ¬í””':'ğŸ˜¢','ë¶„ë…¸':'ğŸ˜ ','ì¢Œì ˆ':'ğŸ˜','ë‘ë ¤ì›€':'ğŸ˜¨','ë¶ˆì•ˆ':'ğŸ˜°','ì™¸ë¡œì›€':'ğŸ˜”','ì‹¤ë§':'ğŸ˜•','í›„íšŒ':'ğŸ˜£','ì§ˆíˆ¬':'ğŸ˜’','ì§œì¦':'ğŸ˜¤'},neutral:{'í˜¼ë€':'ğŸ˜µ','ë†€ëŒ':'ğŸ˜²','ê¸´ì¥':'ğŸ˜¬','ë¬´ê¸°ë ¥':'ğŸ˜‘','ë‹µë‹µí•¨':'ğŸ˜–','ì–µìš¸í•¨':'ğŸ˜¤','ë¶€ë„ëŸ¬ì›€':'ğŸ˜³','ì˜ì‹¬':'ğŸ¤”','í”¼ê³¤í•¨':'ğŸ˜´','ì„œìš´í•¨':'ğŸ™'}};
    const DEFAULT_EMOJIS = { positive: 'ğŸ˜Š', negative: 'ğŸ˜Ÿ', neutral: 'ğŸ˜' };

    let chartInstances = {};
    let currentStudentForReport = null; // í•™ìƒ ë²ˆí˜¸
    let pendingCustomEmotion = {};

    // [ìˆ˜ì •] 'studentLogin', 'noteToTeacherPage' í˜ì´ì§€ ì¶”ê°€
    const pages = ['mainPage', 'studentPage', 'friendsPage', 'teacherLogin', 'teacherDashboard', 'studentReportPage', 'studentLogin', 'noteToTeacherPage']; 
    const tooltip = document.getElementById('tooltip');
    const toastEl = document.getElementById('toast');
    
    // â­ [ìˆ˜ì •] ë˜ëŒë¦¬ê¸° ê¸°ëŠ¥ìš© ë³€ìˆ˜
    let toastTimeout = null;
    let undoTimeout = null;
    let lastDeletedEntry = null; // â­ ì‚­ì œëœ í•­ëª© ì„ì‹œ ì €ì¥


     // â­ [ìˆ˜ì •] ì‚­ì œ ê¸°ëŠ¥ (ë˜ëŒë¦¬ê¸° ì¶”ê°€)
     async function deleteEntry(id) {
        const idStr = String(id); 

        if (!idStr) {
            console.error("Invalid ID for deletion:", id);
            showToast("ì‚­ì œ ì˜¤ë¥˜: IDê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");
            return;
        }
        
        // [ì‚­ì œ] íŒì—…ì°½ ì°¨ë‹¨ ì˜¤ë¥˜ë¡œ ì¸í•´ confirm ì œê±°
        // if (!confirm('ì •ë§ë¡œ ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        const btn = document.querySelector(`button[data-id="${idStr}"]`);
        if (btn) { btn.disabled = true; btn.textContent = '...'; }

        const entryIndex = allDataCache.findIndex(e => String(e.id) === idStr);
        if (entryIndex === -1) {
            showToast('ì‚­ì œ ì˜¤ë¥˜: í•´ë‹¹ ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            if (btn) { btn.disabled = false; btn.textContent = 'ì‚­ì œ'; }
            return;
        }

        // 1. UIì—ì„œ ì¦‰ì‹œ ìˆ¨ê¸°ê¸° (ë¡œì»¬ ìºì‹œì—ì„œ ì œê±°)
        lastDeletedEntry = allDataCache.splice(entryIndex, 1)[0];
        saveDataLocally(allDataCache);
        refreshAfterDelete();

        // 2. "ë˜ëŒë¦¬ê¸°" í† ìŠ¤íŠ¸ í‘œì‹œ
        showToast(
            'ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 
            'ë˜ëŒë¦¬ê¸°', 
            () => undoDelete(), // "ë˜ëŒë¦¬ê¸°" ëˆŒë €ì„ ë•Œ ì‹¤í–‰í•  í•¨ìˆ˜
            () => confirmDelete()  // 5ì´ˆ í›„ ìë™ìœ¼ë¡œ ì‹¤í–‰í•  í•¨ìˆ˜
        );
    }
    
    // â­ [ì¶”ê°€] ì‚­ì œ ë˜ëŒë¦¬ê¸° í•¨ìˆ˜
    function undoDelete() {
        if (!lastDeletedEntry) return;
        
        allDataCache.push(lastDeletedEntry);
        // [ìˆ˜ì •] ë‚ ì§œìˆœìœ¼ë¡œ ë‹¤ì‹œ ì •ë ¬
        allDataCache.sort((a, b) => a.date.localeCompare(b.date));
        
        saveDataLocally(allDataCache);
        refreshAfterDelete();
        showToast('ì‚­ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        lastDeletedEntry = null; // ë˜ëŒë¦¬ê¸° ì™„ë£Œ
        clearTimeout(undoTimeout); // 5ì´ˆ í›„ ì‹¤í–‰ë  confirmDelete ì·¨ì†Œ
    }

    // â­ [ì¶”ê°€] 5ì´ˆ í›„ ì‹¤ì œ ì‚­ì œ ì‹¤í–‰ í•¨ìˆ˜
    async function confirmDelete() {
        if (!lastDeletedEntry) return; // ì´ë¯¸ ë˜ëŒë¦¬ê¸°ê°€ ì‹¤í–‰ë¨

        const entryToDelete = lastDeletedEntry;
        lastDeletedEntry = null; // ë˜ëŒë¦¬ê¸° ê¸°íšŒ ë§Œë£Œ

        // 1. ë¡œì»¬ ë°ì´í„°(synced: false)ëŠ” ì´ë¯¸ ì‚­ì œë˜ì—ˆìœ¼ë¯€ë¡œ ì¶”ê°€ ì‘ì—… ì—†ìŒ
        if (entryToDelete.synced !== true) {
            console.log("Local-only data permanently deleted.");
            return;
        }

        // 2. ì„œë²„ ë™ê¸°í™”ëœ ë°ì´í„°(synced: true)ëŠ” GASì— ì‚­ì œ ìš”ì²­
        console.log("Attempting to delete synced data from server...");
        try {
            const res = await fetch(GAS_URL, {
                method: 'POST',
                mode: 'cors',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // ğŸ” text/plain
                body: JSON.stringify({ 
                    action: 'delete', 
                    id: entryToDelete.id, // idëŠ” ë¬¸ìì—´ì´ì–´ì•¼ í•¨
                    id_numeric: (String(entryToDelete.id).match(/\d+/)?.[0] ?? null) 
                }) 
            });

            const txt = await res.text();
            let result;
            try { 
                if (!txt) throw new Error("EMPTY_RESPONSE");
                result = JSON.parse(txt); 
            } catch { 
                result = {}; 
            }

            if (res.ok && result.status === 'success') {
                console.log('Server delete successful.');
            } else {
                console.warn("Server delete failed:", result);
                enqueuePendingDelete(entryToDelete.id); // (ì„ íƒ)
            }
        } catch (err) {
            console.error('Delete fetch error:', err);
            enqueuePendingDelete(entryToDelete.id); // (ì„ íƒ)
        }
    }
    
    // â­ [ì¶”ê°€] ì‚­ì œ í›„ í™”ë©´ ìƒˆë¡œê³ ì¹¨ í•¨ìˆ˜
    function refreshAfterDelete() {
        if (!document.getElementById('teacherDashboard').classList.contains('hidden') &&
            document.getElementById('dailyTab').classList.contains('active')) {
            renderDailyReport();
            renderStudentListForDashboard();
        } else if (!document.getElementById('studentReportPage').classList.contains('hidden') && currentStudentForReport) {
             renderStudentReport(currentStudentForReport); // Re-render the report
        }
    }
    
    // â­ [ì¶”ê°€] ì˜¤í”„ë¼ì¸ ì‚­ì œ í
    function enqueuePendingDelete(idStr) {
      try {
       const q = JSON.parse(localStorage.getItem(PENDING_DELETES) || '[]');
       if (!q.includes(idStr)) q.push(idStr);
       localStorage.setItem(PENDING_DELETES, JSON.stringify(q));
      } catch {}
    }

    async function flushPendingDeletes() {
      const q = JSON.parse(localStorage.getItem(PENDING_DELETES) || '[]');
      if (!q.length) return;
      console.log(`Flushing ${q.length} pending deletes...`);
      const remains = [];
      for (const idStr of q) {
        try {
          const res = await fetch(GAS_URL, {
            method: 'POST',
            mode: 'cors',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // ğŸ” ìˆ˜ì •
            body: JSON.stringify({ 
                action: 'delete', 
                id: idStr,
                id_numeric: (idStr.match(/\d+/)?.[0] ?? null) 
            })
           });
           const result = await res.json();
           const ok = res.ok && result.status === 'success';
           if (!ok) {
             // ì„œë²„ì— IDê°€ ì—†ë‹¤ê³  í•´ë„(ì´ë¯¸ ì§€ì›Œì§) ì„±ê³µìœ¼ë¡œ ê°„ì£¼
               if (result.message && result.message.includes("ì‚­ì œí•  IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")) {
                 console.log(`Pending delete for ${idStr} already processed on server.`);
               } else {
                 remains.push(idStr); // ì§„ì§œ ì‹¤íŒ¨í•œ ê²½ìš°ë§Œ ë‹¤ì‹œ íì— ë„£ìŒ
               }
           }
        } catch {
           remains.push(idStr); // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë“±
        }
      }
      localStorage.setItem(PENDING_DELETES, JSON.stringify(remains));
      console.log(`Flush complete, ${remains.length} deletes remaining.`);
    }


    // --- ìœ í‹¸ë¦¬í‹° ë° ë°ì´í„° ê´€ë¦¬ ---
    // â­ [ìˆ˜ì •] ë¡œì»¬ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ YYYY-MM-DDë¥¼ ì •í™•íˆ ë°˜í™˜í•˜ë„ë¡ ìˆ˜ì •
    const getTodayDateString = () => {
        const d = new Date();
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };
    
    // â­ [ìˆ˜ì •] getAllData í•¨ìˆ˜ (IDë¥¼ í•­ìƒ ë¬¸ìì—´ë¡œ ì²˜ë¦¬)
    const getAllData = () => {
      if (dataLoaded) {
        return allDataCache.map(entry => ({
          ...entry,
          id: String(entry.id),     // ğŸ” í•­ìƒ ë¬¸ìì—´ë¡œ
          synced: entry.synced === true,
          // â­ [FIX] Add normalization
          date: (entry.date || (entry.timestamp ? entry.timestamp.split('T')[0] : getTodayDateString())),
          studentNumber: (entry.studentNumber || entry.name),
          reason: (entry.reason || entry.content),
          category: (entry.category || entry.tag)
        }));
      }
      console.warn("Using localStorage fallback for getAllData as cache is not loaded yet.");
      const localData = localStorage.getItem(DB_NAME);
      return localData ? JSON.parse(localData).map(entry => ({
        ...entry,
        id: String(entry.id),       // ğŸ” ë¬¸ìì—´ ìœ ì§€
        synced: entry.synced === true,
        // â­ [FIX] Add normalization here too
        date: (entry.date || (entry.timestamp ? entry.timestamp.split('T')[0] : getTodayDateString())),
        studentNumber: (entry.studentNumber || entry.name),
        reason: (entry.reason || entry.content),
        category: (entry.category || entry.tag)
      })) : [];
    };

    // â­ [ìˆ˜ì •] saveDataLocally í•¨ìˆ˜ (IDë¥¼ í•­ìƒ ë¬¸ìì—´ë¡œ ì €ì¥)
    const saveDataLocally = (data) => {
      const dataToSave = data.map(entry => ({
        //...entry, // ...entryë¥¼ ë¨¼ì € ì“°ë©´ id, syncedê°€ ë®ì–´ì”Œì›Œì§ˆ ìˆ˜ ìˆìŒ
        id: String(entry.id),       // ğŸ” ë¬¸ìì—´ë¡œ ì €ì¥
        synced: entry.synced === true,
        date: (entry.date || (entry.timestamp ? entry.timestamp.split('T')[0] : getTodayDateString())),
        studentNumber: (entry.studentNumber || entry.name),
        emotion: entry.emotion,
        emoji: entry.emoji,
        reason: (entry.reason || entry.content),
        category: (entry.category || entry.tag)
      }));
      localStorage.setItem(DB_NAME, JSON.stringify(dataToSave));
      allDataCache = dataToSave;
      dataLoaded = true;
    };


    // [ì‚­ì œë¨]
    // const getShareLinks / saveShareLinks

    // â­ [ìˆ˜ì •] getEmotionType í•¨ìˆ˜
    const getEmotionType = (emotion, entry = null) => {
        if (entry && entry.category) return entry.category;  
        for (const type in EMOTIONS) {  
            if (EMOTIONS[type][emotion]) return type;  
        }
        return 'neutral';
    };

    // â­ [ìˆ˜ì •] ë˜ëŒë¦¬ê¸° ê¸°ëŠ¥ì´ í¬í•¨ëœ showToast
    function showToast(message, actionText = null, actionCallback = null, expiryCallback = null) {
        clearTimeout(toastTimeout);
        clearTimeout(undoTimeout);
        
        const toastContent = `<span>${message}</span>`;
        const undoButton = actionText && actionCallback ? `<button id="undoButton" class="ml-4 font-bold underline text-blue-800">${actionText}</button>` : '';
        
        toastEl.innerHTML = toastContent + undoButton;
        toastEl.classList.remove('hidden', 'opacity-0');
        
        if (actionCallback) {
            document.getElementById('undoButton')?.addEventListener('click', () => {
                clearTimeout(toastTimeout);
                clearTimeout(undoTimeout);
                actionCallback(); // ë˜ëŒë¦¬ê¸° ì‹¤í–‰
            });

            // 5ì´ˆ í›„ ë§Œë£Œ ì½œë°± (ì‹¤ì œ ì‚­ì œ) ì‹¤í–‰
            undoTimeout = setTimeout(() => {
                if (expiryCallback) {
                    expiryCallback();  
                }
            }, 5000); // 5 seconds
        }

        // 5.5ì´ˆ(ë˜ëŒë¦¬ê¸°) ë˜ëŠ” 3ì´ˆ(ì¼ë°˜) í›„ì— í† ìŠ¤íŠ¸ ìˆ¨ê¸°ê¸°
        const hideDelay = actionCallback ? 5500 : 3000;
        toastTimeout = setTimeout(() => {
            toastEl.classList.add('opacity-0');
            setTimeout(() => toastEl.classList.add('hidden'), 300);
        }, hideDelay);
    }


    // --- Gemini API ---
    async function callGeminiAPI(prompt) {
        if (!API_KEY) { console.log("Gemini API key is not set."); return null; }
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        try {
            let response;
            let delay = 1000;
            for (let i = 0; i < 5; i++) {
                response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                if (response.ok) break;
                if (response.status === 429 || response.status >= 500) {
                    console.warn(`API call failed with status ${response.status}. Retrying in ${delay / 1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                } else {
                    console.error("API Error:", await response.json());
                    return null;
                }
            }
            if (!response.ok) { console.error("API call failed after multiple retries."); return null; }
            const result = await response.json();
            return result.candidates?.[0]?.content?.parts?.[0]?.text.trim() || null;
        } catch (error) { console.error("Fetch Error:", error); return null; }
    }


    // --- í˜ì´ì§€ ê´€ë¦¬ ---
    function showPage(pageId) {
        pages.forEach(p => {
            const el = document.getElementById(p);
            // [ì•ˆì •í™”] ëª¨ë“  í˜ì´ì§€ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ìˆ¨ê¹€
            if(el) {
                 el.classList.add('hidden');
                 // [FIX] ìˆ¨ê¸¸ ë•Œ fade-in í´ë˜ìŠ¤ ì œê±°
                 el.classList.remove('fade-in'); 
            }
        });
        
        const targetPage = document.getElementById(pageId);
        if (targetPage) {
            targetPage.classList.remove('hidden');
            // [FIX] ë³´ì—¬ì¤„ ë•Œ fade-in í´ë˜ìŠ¤ ì¶”ê°€
            targetPage.classList.add('fade-in'); 
        } else {
             console.error("Target page element not found for:", pageId);
             return;
        }

        window.scrollTo(0, 0);
        
        if (pageId === 'friendsPage') {
            // â­ [ìˆ˜ì •] ì¹œêµ¬ë“¤ ê°ì • í™•ì¸ í˜ì´ì§€ ì§„ì… ì‹œ ìµœì‹  ë°ì´í„° ë™ê¸°í™” í›„ ë Œë”ë§
            syncDataFromGAS(true).then(() => {
                renderFloatingEmotions();
            });
        }
        if (pageId === 'teacherDashboard') renderTeacherDashboard();
        // [ì‹ ê·œ] í•™ìƒ ë¡œê·¸ì¸/ì¼ê¸°/ìª½ì§€ í˜ì´ì§€ ë³´ì¼ ë•Œ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
        if (pageId === 'studentLogin' || pageId === 'studentPage' || pageId === 'noteToTeacherPage') {
            populateForms(); 
        }
    }

    // --- ì°¨íŠ¸ ---
    function renderChart(canvasId, type, data, options) {
        let canvasElement = null;
        if (typeof canvasId === 'string') {
             canvasElement = document.getElementById(canvasId);
             if (!canvasElement && document.querySelector(canvasId)) {
                 canvasElement = document.querySelector(canvasId);
             }
        } else if (canvasId instanceof HTMLCanvasElement) {
            canvasElement = canvasId;
        }

        if (!canvasElement) { console.error("Canvas element not found for:", canvasId); return; }

        const chartKey = canvasElement.id ? canvasElement.id : canvasElement.dataset.chartId || (canvasElement.dataset.chartId = `chart-${Math.random()}`);
        if (chartInstances[chartKey]) chartInstances[chartKey].destroy();
        const ctx = canvasElement.getContext('2d');
        chartInstances[chartKey] = new Chart(ctx, { type, data, options });
    }


    // --- í•™ìƒ í˜ì´ì§€ ---
    // [ìˆ˜ì •] populateStudentDropdowns -> populateForms
    function populateForms() {
        // 1. ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
        const numSelect = document.getElementById('studentNumber'); // ê°ì •ì¼ê¸° ì‘ì„±
        const loginNumSelect = document.getElementById('studentLoginNumber'); // í•™ìƒ ë¡œê·¸ì¸
        const noteNumSelect = document.getElementById('noteStudentNumber'); // ìª½ì§€ ë³´ë‚´ê¸°

        const options = ['<option value="">ë²ˆí˜¸ ì„ íƒ</option>']
            .concat(STUDENT_NUMBERS.map(num => `<option value="${num}">${num}ë²ˆ</option>`)
        ).join('');
            
        if (numSelect) numSelect.innerHTML = options;
        if (loginNumSelect) loginNumSelect.innerHTML = options;
        if (noteNumSelect) noteNumSelect.innerHTML = options; // â­ [ì‹ ê·œ] ìª½ì§€ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°

        // 2. [ë³µêµ¬] ì´ëª¨í‹°ì½˜ ì±„ìš°ê¸°
        Object.entries(EMOTIONS).forEach(([category, emotions]) => {
            const container = document.getElementById(`${category}Emotions`);
            // [ì¶”ê°€] containerê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸  
            if (container) {  
                container.innerHTML = '';
                const bgColor = category === 'positive' ? 'bg-green-50 hover:bg-green-100' : category === 'negative' ? 'bg-red-50 hover:bg-red-100' : 'bg-gray-50 hover:bg-gray-100';
                for (const [emotion, emoji] of Object.entries(emotions)) {
                    container.innerHTML += `<div class="emotion-card ${bgColor} p-3 rounded-lg cursor-pointer text-center text-xs" onclick="selectEmotion('${emotion}', '${emoji}', '${category}', this)"><div class="text-2xl mb-1">${emoji}</div><div class="font-medium">${emotion}</div></div>`;
                }
            }
        });
    }

    function selectEmotion(emotion, emoji, category, element) {
        document.querySelectorAll('.emotion-card').forEach(el => el.classList.remove('ring-2', 'ring-blue-500'));
        if (element) element.classList.add('ring-2', 'ring-blue-500');
        document.getElementById('selectedEmotion').value = emotion;
        document.getElementById('selectedEmoji').value = emoji;
        document.getElementById('selectedCategory').value = category;
    }
    function showCustomEmotionInput() { document.getElementById('customEmotionContainer').classList.remove('hidden'); }
    function hideCustomEmotionInput() { document.getElementById('customEmotionContainer').classList.add('hidden'); }

    async function setCustomCategory(category) {
        const customEmotionText = pendingCustomEmotion.text;
        let finalEmoji = pendingCustomEmotion.emoji;

        if (!finalEmoji) {
            const emojiPrompt = `ë‹¤ìŒ í•œêµ­ì–´ ê°ì •ì— ê°€ì¥ ì–´ìš¸ë¦¬ëŠ” ëŒ€í‘œ ì–¼êµ´ í‘œì • ì´ëª¨ì§€(emoji) í•˜ë‚˜ë§Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”. ë‹¤ë¥¸ ì„¤ëª… ì—†ì´ ì´ëª¨ì§€ë§Œ ì‘ë‹µí•´ì•¼ í•©ë‹ˆë‹¤.\n\nê°ì •: "${customEmotionText}"`;
            const recommendedEmoji = await callGeminiAPI(emojiPrompt);
            if (recommendedEmoji && /\p{Emoji}/u.test(recommendedEmoji)) {
                finalEmoji = recommendedEmoji.slice(0, 2);
            } else {
                finalEmoji = DEFAULT_EMOJIS[category];
            }
        }

        selectEmotion(customEmotionText, finalEmoji, category, null);
        showToast(`'${customEmotionText} ${finalEmoji}' ê°ì •ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.`);
        hideCustomEmotionInput();
        document.getElementById('categoryModal').classList.add('hidden');
        pendingCustomEmotion = {};
    }

    async function handleCustomEmotion() {
        const inputEl = document.getElementById('customEmotionInput');
        const customEmotionText = inputEl.value.trim();
        if (!customEmotionText) return showToast('ê°ì •ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        const confirmButton = inputEl.nextElementSibling;
        confirmButton.disabled = true; confirmButton.textContent = '...';

        pendingCustomEmotion = { text: customEmotionText, emoji: null };

        const prompt = `ë‹¤ìŒ í•œêµ­ì–´ ê°ì •ì„ ë¶„ì„í•´ì„œ ê°€ì¥ ì–´ìš¸ë¦¬ëŠ” ëŒ€í‘œ ì–¼êµ´ í‘œì • ì´ëª¨ì§€(emoji)ì™€ ê°ì •ì˜ ê¸ì •/ë¶€ì •/ì¤‘ë¦½ ë¶„ë¥˜ë¥¼ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ ì£¼ì„¸ìš”. categoryëŠ” 'positive', 'negative', 'neutral' ì¤‘ í•˜ë‚˜ì—¬ì•¼ í•©ë‹ˆë‹¤. ë‹¤ë¥¸ ì„¤ëª… ì—†ì´ JSON ê°ì²´ë§Œ ì‘ë‹µí•´ì•¼ í•©ë‹ˆë‹¤. í˜•ì‹: {"emoji": "...", "category": "..."}\n\nê°ì •: "${customEmotionText}"`;
        const responseText = await callGeminiAPI(prompt);
        confirmButton.disabled = false; confirmButton.textContent = 'í™•ì¸';

        if (responseText) {
            try {
                const cleanedResponse = responseText.replace(/```json\n?/, '').replace(/```$/, '');
                const result = JSON.parse(cleanedResponse);
                if (result.emoji && result.category && /\p{Emoji}/u.test(result.emoji)) {
                    pendingCustomEmotion.emoji = result.emoji.slice(0, 2);
                    setCustomCategory(result.category);
                    return;
                }
            } catch (e) {
                console.error("Error parsing AI response:", e, responseText);
            }
        }

        document.getElementById('fallbackEmotionText').textContent = `"${customEmotionText}"`;
        document.getElementById('categoryModal').classList.remove('hidden');
    }

    // â­ [ìˆ˜ì •] 'submit' ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ - ì„œë²„ í†µì‹  ì˜¤ë¥˜ ì²˜ë¦¬ ê°•í™”
    document.getElementById('emotionForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const today = getTodayDateString();
        const studentNumber = document.getElementById('studentNumber').value;
        if (!studentNumber) { // ë²ˆí˜¸ ì„ íƒ ìœ íš¨ì„± ê²€ì‚¬
             return showToast('ë²ˆí˜¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
        }
        if (!document.getElementById('selectedEmotion').value) { // ê°ì • ì„ íƒ ìœ íš¨ì„± ê²€ì‚¬
            return showToast('ê°ì •ì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
        }
        if (!document.getElementById('emotionReason').value.trim()) { // ì´ìœ  ì…ë ¥ ìœ íš¨ì„± ê²€ì‚¬
            return showToast('ê°ì •ì˜ ì´ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
        }


        // ìºì‹œì—ì„œ í™•ì¸ (getAllData()ëŠ” ì´ë¯¸ ë‚´ë¶€ í˜•ì‹ì„ ë°˜í™˜)
        if (getAllData().find(d => d.date === today && d.studentNumber === studentNumber)) {
             return showToast('ì´ë¯¸ ì˜¤ëŠ˜ ê°ì •ì¼ê¸°ë¥¼ ì‘ì„±í–ˆì–´ìš”!');
        }

        // â­ 1. [ìˆ˜ì •] GASë¡œ ë³´ë‚¼ ë°ì´í„° ê°ì²´ ìƒì„± (GAS ì‹œíŠ¸ í—¤ë” 7ê°œ ê¸°ì¤€)
        // ì‹œíŠ¸ í—¤ë”: id, timestamp, name, emotion, tag, content, emoji
        const newEntryForGAS = {
            id: Date.now(),
            timestamp: new Date().toISOString(), // 'timestamp'
            name: studentNumber, // 'name'
            emotion: document.getElementById('selectedEmotion').value, // 'emotion'
            tag: document.getElementById('selectedCategory').value || 'neutral', // 'tag'
            content: document.getElementById('emotionReason').value, // 'content'
            emoji: document.getElementById('selectedEmoji').value // â­ 'emoji' ì¶”ê°€
        };
        
        // â­ 2. [ìˆ˜ì •] ë¡œì»¬ ìºì‹œì— ì €ì¥í•  ë‚´ë¶€ìš© ê°ì²´ (ì•± ë‚´ë¶€ ê¸°ì¤€ - ì´ˆê¸°ì—ëŠ” ë™ê¸°í™” ì‹¤íŒ¨ ê°€ëŠ¥ì„±ì„ ì—´ì–´ë‘ )
        const newEntryInternal = {
            id: newEntryForGAS.id,
            date: today, // date
            studentNumber: studentNumber, // studentNumber
            emotion: newEntryForGAS.emotion,
            emoji: newEntryForGAS.emoji, // emoji (ë‚´ë¶€ìš©)
            reason: newEntryForGAS.content, // reason
            category: newEntryForGAS.tag, // category
            synced: false // â­ ì´ˆê¸°ì—ëŠ” falseë¡œ ì„¤ì •í•˜ì—¬, ì„œë²„ ì‘ë‹µ í›„ trueë¡œ ë³€ê²½
        };


        // â­ 3. GASë¡œ ë°ì´í„° ì „ì†¡ (action: "create")
        const submitButton = e.target.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.textContent = 'ì €ì¥ ì¤‘...';
        let serverSuccess = false;

        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                mode: 'cors',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // ğŸ” [ìˆ˜ì •ë¨] text/plain
                body: JSON.stringify({ 
                    action: "create", 
                    data: newEntryForGAS // ì‹œíŠ¸ í˜•ì‹ì— ë§ì¶˜ 'newEntryForGAS' ì „ì†¡
                })
            });
            
            const txt = await response.text();
            let result;
            try { 
                if (!txt) throw new Error("EMPTY_RESPONSE");
                result = JSON.parse(txt); 
            } catch (err) {
                 console.error("GAS ì‘ë‹µ JSON íŒŒì‹± ì‹¤íŒ¨:", err, txt);
                 result = { status: "error", message: "ì‘ë‹µ íŒŒì‹± ì˜¤ë¥˜" };
            }


            if (response.ok && result.status === "success") {
                // âœ… ì„œë²„ê°€ ëŒë ¤ì¤€ ì§„ì§œ IDë¡œ êµì²´í•˜ê³  ë™ê¸°í™” ì„±ê³µ ì²˜ë¦¬
                const serverId = String(result.id ?? newEntryForGAS.id); // ğŸ” [ìˆ˜ì •] ë¬¸ìì—´ë¡œ ë°›ìŒ
                const entryWithServerId = { ...newEntryInternal, id: serverId, synced: true };
                allDataCache.push(entryWithServerId);
                serverSuccess = true;

                const feedbackMessages = ["ì˜¤ëŠ˜ë„ í˜ë‚´ì„¸ìš”! ë©‹ì§„ í•˜ë£¨ê°€ ë  ê±°ì˜ˆìš”. í™”ì´íŒ…!", "ì•„ì¹¨ë¶€í„° ê¸°ë¡í•˜ëŠ” ë‹¹ì‹ , ì •ë§ ë©‹ì ¸ìš”! ì‘ì›í•©ë‹ˆë‹¤!", "ì¢‹ì€ ì‹œì‘ì´ì—ìš”! ì˜¤ëŠ˜ í•˜ë£¨ë„ ê¸ì • ì—ë„ˆì§€ ê°€ë“í•˜ê¸¸!", "ê°ì‚¬í•©ë‹ˆë‹¤! ë‹¹ì‹ ì˜ í•˜ë£¨ë¥¼ ì‘ì›í• ê²Œìš”. í™”ì´íŒ…!", "ê¸°ë¡ ì™„ë£Œ! ì˜¤ëŠ˜ í•˜ë£¨ë„ ë°˜ì§ë°˜ì§ ë¹›ë‚˜ê¸¸ ë°”ë¼ìš”."];
                showToast(feedbackMessages[Math.floor(Math.random() * feedbackMessages.length)]);
                
            } else {
                // ğŸ›‘ ì„œë²„ì—ì„œ ì‹¤íŒ¨ ì‘ë‹µì„ ë³´ëƒ„ (GAS ìŠ¤í¬ë¦½íŠ¸ ë‚´ë¶€ ì˜¤ë¥˜ ê°€ëŠ¥ì„±)
                console.error("GAS ì“°ê¸° ì˜¤ë¥˜:", result.message);
                
                // â­ ì„œë²„ ì“°ê¸° ì‹¤íŒ¨ ì‹œ ë¡œì»¬ì—ë§Œ ì„ì‹œ ì €ì¥ (synced: false ìƒíƒœ ìœ ì§€)
                allDataCache.push(newEntryInternal);
                
                showToast(`ì €ì¥ ì‹¤íŒ¨: ${result.message || 'ì„œë²„ ì˜¤ë¥˜. êµì‚¬ì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.'}`);
                // ì„œë²„ ì“°ê¸° ì‹¤íŒ¨ ì‹œ ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì§€ ì•ŠìŒ
            }

        } catch (error) {
            // ğŸ›‘ ë„¤íŠ¸ì›Œí¬ í†µì‹  ìì²´ ì˜¤ë¥˜ (Fetch Error)
            console.error("Fetch Error (Create):", error);
            
            // â­ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œ ë¡œì»¬ì—ë§Œ ì„ì‹œ ì €ì¥ (synced: false ìƒíƒœ ìœ ì§€)
            allDataCache.push(newEntryInternal);
            
            showToast("ì„œë²„ í†µì‹  ì˜¤ë¥˜! ê¸°ë¡ì„ ë¡œì»¬ì— ì„ì‹œ ì €ì¥í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
            // í†µì‹  ì˜¤ë¥˜ ì‹œ ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì§€ ì•ŠìŒ
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'ğŸ’¾ ê°ì •ì¼ê¸° ì €ì¥í•˜ê¸°';
            
            saveDataLocally(allDataCache); // ìºì‹œë¥¼ ì„œë²„ ìƒíƒœì™€ ê´€ê³„ì—†ì´ ì—…ë°ì´íŠ¸
            
            e.target.reset();
            document.querySelectorAll('.emotion-card').forEach(el => el.classList.remove('ring-2', 'ring-blue-500'));
            
            // ì„œë²„ ì„±ê³µ ì‹œì—ë§Œ ë©”ì¸ìœ¼ë¡œ ì´ë™ (ì‹¤íŒ¨ ì‹œ ì‘ì„± í˜ì´ì§€ ìœ ì§€)
            if (serverSuccess) {
                 showPage('mainPage');
            }
        }
    });
    
    // â­ [ì‹ ê·œ] ìª½ì§€ ì „ì†¡ í•¸ë“¤ëŸ¬
    document.getElementById('noteForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const studentNumber = document.getElementById('noteStudentNumber').value;
        const noteContent = document.getElementById('noteContent').value;

        if (!studentNumber || !noteContent.trim()) {
            return showToast('ë²ˆí˜¸ ì„ íƒê³¼ ìª½ì§€ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        }

        const noteEntry = {
            timestamp: new Date().toISOString(),
            name: studentNumber,
            content: noteContent.trim()
        };

        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = 'ì „ì†¡ ì¤‘...';

        try {
            // â­ [ìˆ˜ì •] action: "sendNote"ìœ¼ë¡œ GASì— ìš”ì²­
            const response = await fetch(GAS_URL, {
                method: 'POST',
                mode: 'cors',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ 
                    action: "sendNote", 
                    data: noteEntry 
                })
            });
            
            const txt = await response.text();
            let result;
            try { 
                if (!txt) throw new Error("EMPTY_RESPONSE");
                result = JSON.parse(txt); 
            } catch (err) {
                 console.error("GAS ì‘ë‹µ JSON íŒŒì‹± ì‹¤íŒ¨:", err, txt);
                 result = { status: "error", message: "ì‘ë‹µ íŒŒì‹± ì˜¤ë¥˜" };
            }


            if (response.ok && result.status === "success") {
                showToast("ìª½ì§€ê°€ ì„ ìƒë‹˜ê»˜ ì„±ê³µì ìœ¼ë¡œ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤! (ë¹„ë°€ ë³´ì¥)");
                e.target.reset();
                showPage('mainPage');
            } else {
                console.error("Note send failed:", result);
                showToast("ìª½ì§€ ì „ì†¡ ì‹¤íŒ¨: ì„œë²„ ì˜¤ë¥˜. GAS ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
            }
        } catch (error) {
            console.error("Note Fetch Error:", error);
            showToast("ì„œë²„ í†µì‹  ì˜¤ë¥˜ë¡œ ìª½ì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'ğŸ’Œ ìª½ì§€ ì „ì†¡í•˜ê¸°';
        }
    });


    // [ì‹ ê·œ] í•™ìƒ ë¡œê·¸ì¸ ì²˜ë¦¬
    async function handleStudentLogin(e) {
        e.preventDefault();
        
        const studentNumber = document.getElementById('studentLoginNumber').value;
        const inputPw = document.getElementById('studentLoginPassword').value;
        const errorEl = document.getElementById('studentLoginError');

        if (!studentNumber || !inputPw) {
            errorEl.textContent = 'ë²ˆí˜¸ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            errorEl.classList.remove('hidden');
            return;
        }

        // ë¹„ë°€ë²ˆí˜¸ ìƒì„± ê³µì‹
        const SECRET = 572;
        const MULTIPLIER = 17;
        const expectedPw = ((Number(studentNumber) * MULTIPLIER) + SECRET).toString().slice(-4).padStart(4, '0');

        if (inputPw === expectedPw) {
            // ë¡œê·¸ì¸ ì„±ê³µ
            errorEl.classList.add('hidden');
            document.getElementById('studentLoginForm').reset();
            
            // [ìˆ˜ì •] renderStudentReport í˜¸ì¶œ ì‹œ isTeacherView=false ì „ë‹¬
            renderStudentReport(studentNumber, false); 
        } else {
            // ë¡œê·¸ì¸ ì‹¤íŒ¨
            errorEl.textContent = 'ë²ˆí˜¸ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
            errorEl.classList.remove('hidden');
        }
    }


    // --- ì¹œêµ¬ë“¤ í˜ì´ì§€ ---
    function renderFloatingEmotions() {
        const container = document.getElementById('floatingEmotions');
        
        // â­ [ìˆ˜ì •] ë¡œë”© í™”ë©´ì„ ì—¬ê¸°ì„œ í‘œì‹œí•˜ë„ë¡ ë³€ê²½
        container.innerHTML = `<div class="text-center py-10"><div class="loader mx-auto"></div><p class="text-gray-600 mt-4">ì¹œêµ¬ë“¤ì˜ ê°ì • ê¸°ë¡ì„ ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>`;


        const todaysData = getAllData().filter(d => d.date === getTodayDateString());
        
        if (todaysData.length === 0) {
            // â­ [ìˆ˜ì •] ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¡œë”© í™”ë©´ ì œê±° í›„ ë©”ì‹œì§€ í‘œì‹œ
            container.innerHTML = `<div class="text-center text-gray-500 py-20">ì•„ì§ ì¼ê¸°ë¥¼ ì“´ ì¹œêµ¬ê°€ ì—†ì–´ìš”.</div>`;
            return;
        }
        
        // â­ [ìˆ˜ì •] ë°ì´í„°ê°€ ìˆì„ ë•Œ ë¡œë”© í™”ë©´ ì œê±° í›„ ì´ëª¨í‹°ì½˜ ë Œë”ë§
        container.innerHTML = ''; 

        const positions = [];
        const emojiSize = 48;
        const containerWidth = container.offsetWidth;
        const containerHeight = container.offsetHeight;

        todaysData.forEach(entry => {
            const el = document.createElement('div');
            el.className = 'floating-emotion';
            el.textContent = entry.emoji; // Use internal emoji

            let left, top, overlaps;
            let attempts = 0;
            do {
                overlaps = false;
                left = Math.random() * (containerWidth - emojiSize);
                top = Math.random() * (containerHeight - emojiSize);

                for (const pos of positions) {
                    if (left < pos.right && left + emojiSize > pos.left && top < pos.bottom && top + emojiSize > pos.top) {
                        overlaps = true;
                        break;
                    }
                }
                attempts++;
            } while (overlaps && attempts < 100);

            positions.push({ left: left, top: top, right: left + emojiSize, bottom: top + emojiSize });

            el.style.left = `${left}px`;
            el.style.top = `${top}px`;
            el.style.animationDelay = `${Math.random() * 5}s`;

            // [ìˆ˜ì •] íˆ´íŒ ìœ„ì¹˜ ê³„ì‚° ë¡œì§ (í„°ì¹˜/í´ë¦­ ì´ë²¤íŠ¸ ëŒ€ë¹„)
            const showDetail = (e) => {
                const targetRect = e.target.getBoundingClientRect();

                tooltip.innerHTML = `<strong>${entry.studentNumber}ë²ˆ (${entry.emotion})</strong><br><span class="text-sm">${entry.reason}</span>`;
                tooltip.classList.add('show');
                
                // íˆ´íŒì´ ë Œë”ë§ëœ í›„ í¬ê¸°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìœ„ì¹˜ ì¡°ì •
                let tooltipWidth = tooltip.offsetWidth;
                let tooltipHeight = tooltip.offsetHeight;

                // ì¤‘ì•™ ìƒë‹¨ì— ë°°ì¹˜
                let tooltipLeft = targetRect.left + targetRect.width / 2 - tooltipWidth / 2;
                let tooltipTop = targetRect.top - tooltipHeight - 10;
                
                // ë·°í¬íŠ¸ ê²½ê³„ ì²´í¬ ë° ì¡°ì • (ì™¼ìª½/ì˜¤ë¥¸ìª½)
                if (tooltipLeft < 10) tooltipLeft = 10;
                if (tooltipLeft + tooltipWidth > window.innerWidth - 10) {
                    tooltipLeft = window.innerWidth - tooltipWidth - 10;
                }
                // ë·°í¬íŠ¸ ê²½ê³„ ì²´í¬ ë° ì¡°ì • (ìƒë‹¨)
                 if (tooltipTop < 10) tooltipTop = 10;
                
                tooltip.style.left = `${tooltipLeft}px`;
                tooltip.style.top = `${tooltipTop}px`;
            };

            const hideDetail = () => tooltip.classList.remove('show');

            // â­ [ìˆ˜ì •] ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ (PC): ë§ˆìš°ìŠ¤ê°€ ì˜¬ë¼ê°€ ìˆëŠ” ë™ì•ˆ ìœ ì§€
            el.onmouseenter = showDetail;
            el.onmouseleave = hideDetail;

            // â­ [ìˆ˜ì •] í„°ì¹˜ ì´ë²¤íŠ¸ (ëª¨ë°”ì¼): í„°ì¹˜í•˜ëŠ” ë™ì•ˆ ìœ ì§€
            let touchTimer = null;
            el.addEventListener('touchstart', (e) => {
                e.preventDefault(); // ê¸°ë³¸ ìŠ¤í¬ë¡¤/ì¤Œ ë°©ì§€
                // í„°ì¹˜ ì´ë²¤íŠ¸ëŠ” touches[0]ì˜ ì¢Œí‘œë¥¼ ì‚¬ìš©í•´ì•¼ ì •í™•í•¨
                const fakeEvent = { 
                    target: el, 
                    getBoundingClientRect: () => el.getBoundingClientRect(),
                    touches: e.touches
                };
                 showDetail(fakeEvent);
                 
                 // 1.5ì´ˆ í›„ ìë™ìœ¼ë¡œ íˆ´íŒ ìˆ¨ê¸°ê¸° (í˜¹ì‹œ í„°ì¹˜ ì´ë²¤íŠ¸ë¥¼ ë†“ì¹  ê²½ìš° ëŒ€ë¹„)
                 touchTimer = setTimeout(hideDetail, 3000); 
            });
            // í„°ì¹˜ ë, í„°ì¹˜ ì·¨ì†Œ ì‹œ ìˆ¨ê¹€
            el.addEventListener('touchend', () => {
                clearTimeout(touchTimer);
                hideDetail();
            });
            el.addEventListener('touchcancel', () => {
                clearTimeout(touchTimer);
                hideDetail();
            });


            container.appendChild(el);
        });
    }

    // --- êµì‚¬ í˜ì´ì§€ ---
    // [FIX] DOMContentLoadedë¡œ ì´ë™í•˜ê¸° ìœ„í•´ ì´ ë¸”ë¡ì—ì„œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì œê±°í•˜ê³  í•¨ìˆ˜ë¡œ ë¶„ë¦¬í–ˆìŠµë‹ˆë‹¤.
    function handleTeacherLogin(e) { 
        e.preventDefault(); // [FIX] í¼ ì œì¶œ ì‹œ ìƒˆë¡œê³ ì¹¨ ë°©ì§€
        const pw = document.getElementById('teacherPassword'); 
        if (pw.value === TEACHER_PASSWORD) { 
            document.getElementById('loginError').classList.add('hidden'); 
            pw.value = ''; 
            showPage('teacherDashboard'); 
        } else { 
            document.getElementById('loginError').classList.remove('hidden'); 
        } 
    }
    function logoutTeacher() { showPage('mainPage'); }
    
    // â­ [ìˆ˜ì •] ë¡œì»¬ ë°ì´í„° ìºì‹œ ì‚­ì œ í•¨ìˆ˜
    async function clearLocalCache() {
        // confirm()ì„ ì‚¬ìš©í•˜ì§€ ì•Šê³  ë°”ë¡œ ì‚­ì œí•˜ê³  í† ìŠ¤íŠ¸ ë©”ì‹œì§€ë¡œ ì•Œë¦¼
        localStorage.removeItem(DB_NAME);
        localStorage.removeItem(PENDING_DELETES);
        allDataCache = [];
        dataLoaded = false;
        
        // â­ ìƒˆë¡œê³ ì¹¨ ê¸°ëŠ¥ê³¼ ë™ì¼í•˜ê²Œ GASì—ì„œ ê°•ì œë¡œ ë°ì´í„° ë™ê¸°í™”
        showToast("ë¸Œë¼ìš°ì € ìºì‹œë¥¼ ì‚­ì œí•˜ê³  ì„œë²„ì—ì„œ ìµœì‹  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤...");
        await syncDataFromGAS(true); // ê°•ì œ ë™ê¸°í™” (í† ìŠ¤íŠ¸ ë©”ì‹œì§€ëŠ” syncDataFromGAS ë‚´ë¶€ì—ì„œ ì²˜ë¦¬)
        
        // í˜„ì¬ ë³´ê³  ìˆë˜ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ (ëŒ€ì‹œë³´ë“œ ë˜ëŠ” ë©”ì¸)
        if (document.getElementById('teacherDashboard').classList.contains('hidden')) {
            showPage('mainPage');
        } else {
            renderTeacherDashboard();
        }
    }


    function renderTeacherDashboard() {
        const datePicker = document.getElementById('dashboardDate');
        const monthPicker = document.getElementById('dashboardMonth');
        datePicker.value = datePicker.value || getTodayDateString();
        const today = new Date();
        monthPicker.value = monthPicker.value || `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;

        if (!datePicker.dataset.listenerAttached) {
             datePicker.addEventListener('change', () => {
                 renderDailyReport();
                 renderStudentListForDashboard();
             });
             datePicker.dataset.listenerAttached = 'true';
        }
        if (!monthPicker.dataset.listenerAttached) {
            monthPicker.addEventListener('change', renderMonthlyReport);
            monthPicker.dataset.listenerAttached = 'true';
        }


        switchDashboardTab(document.querySelector('.tab-button.active')?.id === 'monthlyTab' ? 'monthly' : 
                             document.querySelector('.tab-button.active')?.id === 'notesTab' ? 'notes' : 'daily');
        // â­ [ìˆ˜ì •] í•™ìƒë³„ ë¦¬í¬íŠ¸ ì„¹ì…˜ì´ ì œê±°ë˜ì—ˆì§€ë§Œ, ì¼ë³„ íƒ­ì—ì„œ ë¦¬í¬íŠ¸ ë²„íŠ¼ì„ ìœ„í•´ ì´ í•¨ìˆ˜ëŠ” í˜¸ì¶œí•´ì•¼ í•¨
        if (document.querySelector('.tab-button.active')?.id !== 'notesTab') {
             renderStudentListForDashboard();
        }
    }

    function switchDashboardTab(tab) {
        document.getElementById('dailyTab').classList.toggle('active', tab === 'daily');
        document.getElementById('monthlyTab').classList.toggle('active', tab === 'monthly');
        document.getElementById('notesTab').classList.toggle('active', tab === 'notes'); // â­ íƒ­ í™œì„±í™”

        document.getElementById('dailyReportContent').classList.toggle('hidden', tab !== 'daily');
        document.getElementById('monthlyReportContent').classList.toggle('hidden', tab !== 'monthly');
        document.getElementById('notesContent').classList.toggle('hidden', tab !== 'notes'); // â­ ë‚´ìš© í‘œì‹œ

        document.getElementById('dashboardDate').classList.toggle('hidden', tab !== 'daily');
        document.getElementById('dashboardMonth').classList.toggle('hidden', tab !== 'monthly');

        if (tab === 'daily') {
             renderDailyReport();
             renderStudentListForDashboard();
        }
        if (tab === 'monthly') renderMonthlyReport();
        if (tab === 'notes') renderTeacherNotes(); // â­ ìª½ì§€í•¨ ë Œë”ë§
    }

      // Event delegation handler for the list container
    function handleListClick(e) {
        if (e.target.classList.contains('delete-btn')) {
            const rawId = e.target.dataset.id; // (B) Get raw string ID
            deleteEntry(rawId); // (B) Pass raw string ID
        }
    }


    function renderDailyReport() {
        const selectedDate = document.getElementById('dashboardDate').value;
        document.getElementById('dailyDistributionTitle').textContent = `${selectedDate} ê°ì • ë¶„í¬`;
        document.getElementById('dailyEntriesTitle').textContent = `${selectedDate}ì˜ ê¸°ë¡`;

        const dailyData = getAllData().filter(d => d.date === selectedDate);
        const categoryCounts = { positive: 0, negative: 0, neutral: 0 };
        dailyData.forEach(entry => categoryCounts[getEmotionType(entry.emotion, entry)]++);

        // â­ [FIX] todayNegativeCount IDê°€ HTMLì— ë³µêµ¬ë˜ì—ˆìœ¼ë¯€ë¡œ ì •ìƒ ì‘ë™
        document.getElementById('todaySubmissionCount').textContent = `${dailyData.length} / ${STUDENT_NUMBERS.length}`;
        document.getElementById('todayPositiveCount').textContent = categoryCounts.positive;
        document.getElementById('todayNegativeCount').textContent = categoryCounts.negative;

        renderChart('dailyDistributionChart', 'pie', { labels: ['ê¸ì •', 'ë¶€ì •', 'ì¤‘ë¦½'], datasets: [{ data: Object.values(categoryCounts), backgroundColor: ['#4CAF50', '#F44336', '#FFC107'] }] }, { responsive: true, maintainAspectRatio: false });

        const listContainer = document.getElementById('dailyEntriesList');
        listContainer.innerHTML = dailyData.length ? '' : '<p class="text-gray-500">ì„ íƒí•œ ë‚ ì§œì— ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        dailyData.forEach(entry => {
            // (A) ë¦¬ìŠ¤íŠ¸ ë Œë”ë§: data-id ì›ë³¸ ìœ ì§€ (String()ë¡œ ë³€ê²½)
            listContainer.innerHTML += `
             <div class="border-b pb-3 flex items-center">
               <div class="flex-grow">
                 <p class="font-bold">${entry.emoji} ${entry.studentNumber}ë²ˆ - <span class="font-medium">${entry.emotion}</span></p>
                 <p class="text-sm text-gray-600 pl-7">${entry.reason}</p>
               </div>
               <button data-id="${String(entry.id)}"
                       class="delete-btn bg-red-100 text-red-600 hover:bg-red-200 text-xs font-bold py-1 px-2 rounded-md">
                 ì‚­ì œ
               </button>
             </div>`;
        });

        // Use event delegation on the list container
        listContainer.removeEventListener('click', handleListClick); // Remove previous listener first
        listContainer.addEventListener('click', handleListClick);

        renderStudentListForDashboard();
    }

    function renderMonthlyReport() {
        const monthString = document.getElementById('dashboardMonth').value;
        const [year, month] = monthString.split('-').map(Number);
        const monthData = getAllData().filter(d => d.date.startsWith(monthString));

        const daysInMonth = new Date(year, month, 0).getDate();
        const categoryCounts = { positive: 0, negative: 0, neutral: 0 };
        monthData.forEach(entry => categoryCounts[getEmotionType(entry.emotion, entry)]++);

        document.getElementById('monthlyPositiveCount').textContent = categoryCounts.positive;
        document.getElementById('monthlyNeutralCount').textContent = categoryCounts.neutral;
        document.getElementById('monthlyNegativeCount').textContent = categoryCounts.negative;

        renderChart('monthlyDistributionChart', 'doughnut', { labels: ['ê¸ì •', 'ë¶€ì •', 'ì¤‘ë¦½'], datasets: [{ data: Object.values(categoryCounts), backgroundColor: ['#4CAF50', '#F44336', '#FFC107'] }] }, { responsive: true, maintainAspectRatio: false });

        const dailyTrends = Array(daysInMonth).fill(null).map((_, i) => {
            const dayStr = `${monthString}-${String(i + 1).padStart(2, '0')}`;
            const dayData = monthData.filter(d => d.date === dayStr);
            if (!dayData) return null;
            const category = getEmotionType(dayData.emotion, dayData);
            if (category === 'positive') return 1;
            if (category === 'negative') return -1;
            return 0;
        });

        renderChart('monthlyTrendChart', 'bar', {
            labels: Array(daysInMonth).fill(null).map((_, i) => i + 1),
            datasets: [
                { label: 'ê¸ì •', data: dailyTrends.map(d => d.positive), backgroundColor: '#4CAF50' },
                { label: 'ì¤‘ë¦½', data: dailyTrends.map(d => d.neutral), backgroundColor: '#FFC107' },
                { label: 'ë¶€ì •', data: dailyTrends.map(d => d.negative), backgroundColor: '#F44336' }
            ]
        }, { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true, title: { display: true, text: `${month}ì›”` } }, y: { stacked: true, max: 100, ticks: { callback: (value) => value + '%' } } } });
    }

    // â­ [FIX] í•™ìƒ ì…ë ¥ ì‹œ ìƒ‰ê¹” ë°”ë€ŒëŠ” ë¡œì§ì„ ìœ„í•´ ì»¨í…Œì´ë„ˆ ID ë³µêµ¬ í›„ ì¬ì‘ì„±
    function renderStudentListForDashboard() {
        const studentLinksContainer = document.getElementById('studentReportLinks');
        // [FIX] studentReportLinks ì»¨í…Œì´ë„ˆê°€ ì—†ìœ¼ë©´ í•¨ìˆ˜ ì¢…ë£Œ (HTMLì— ë³µêµ¬ë¨)
        if (!studentLinksContainer) return;

        studentLinksContainer.innerHTML = '';
        const selectedDate = document.getElementById('dashboardDate').value;
        const submittedStudents = getAllData()
            .filter(d => d.date === selectedDate)
            .map(d => d.studentNumber); // Get numbers of students who submitted

        STUDENT_NUMBERS.sort((a,b) => parseInt(a) - parseInt(b)).forEach(num => { // Sort numbers correctly
             const submitted = submittedStudents.includes(num);
             const buttonClass = submitted
                 ? 'bg-blue-200 hover:bg-blue-300 text-blue-800'
                 : 'bg-gray-100 hover:bg-gray-200 text-gray-700';
             // [FIX] renderStudentReport(num, true)ë¡œ êµì‚¬ ë·° ëª…ì‹œ
             studentLinksContainer.innerHTML += `<button onclick="renderStudentReport('${num}', true)" class="${buttonClass} font-medium py-2 px-3 rounded-lg transition">${num}ë²ˆ</button>`;
        });
    }

    // â­ [ì‹ ê·œ] GASì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™€ ìºì‹œë¥¼ ì—…ë°ì´íŠ¸í•˜ê³  í˜„ì¬ ë·°ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ëŠ” í•¨ìˆ˜
    async function syncDataFromGAS(isForce = false) {
        if (!isForce && dataLoaded) return true; // ì´ë¯¸ ë¡œë“œë˜ì—ˆìœ¼ë©´ ì‹¤í–‰ ì•ˆ í•¨ (ê°•ì œ ì‹¤í–‰ì´ ì•„ë‹ ê²½ìš°)

        // ë¡œë”© ì‹œì‘
        const btn = document.getElementById('refreshDataBtn');
        if (btn) { btn.disabled = true; btn.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...'; }
        
        try {
            const response = await fetch(GAS_URL + '?action=readAll', { mode: 'cors' });
            const result = await response.json();

            if (response.ok && Array.isArray(result)) {
                const normalizedData = result.map(entry => ({
                    id: String(entry.id), 
                    date: entry.timestamp ? entry.timestamp.split('T')[0] : getTodayDateString(),
                    studentNumber: String(entry.name),
                    emotion: entry.emotion,
                    emoji: entry.emoji,
                    reason: entry.content,
                    category: entry.tag,
                    synced: true // ì„œë²„ì—ì„œ ì½ì–´ì˜¨ ë°ì´í„°ëŠ” í•­ìƒ true
                }));
                
                // â­ ë¡œì»¬ ë°ì´í„°ì™€ ì„œë²„ ë°ì´í„°ë¥¼ ë³‘í•© (ì—¬ê¸°ì„œëŠ” ì„œë²„ ë°ì´í„°ë¡œ ì™„ì „íˆ ë®ì–´ì”Œì›€)
                saveDataLocally(normalizedData);
                
                await flushPendingDeletes(); // ë™ê¸°í™” ì„±ê³µ í›„ ë‚¨ì•„ìˆëŠ” ì‚­ì œ í ì²˜ë¦¬
                
                // [ìˆ˜ì •] í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ì œê±° (ì¼ë°˜ì ì¸ ë™ê¸°í™” ë©”ì‹œì§€ ì œì™¸)
                console.log(isForce ? "Forced sync complete." : "Initial data loaded."); 
                return true; // Success signal

            } else {
                console.error("GAS ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", result);
                showToast("ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ! ë¡œì»¬ ìºì‹œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.");
                
                // â­ GAS ë¡œë“œ ì‹¤íŒ¨ ì‹œ ë¡œì»¬ ìºì‹œë¥¼ ë°ì´í„°ë¡œ ê°„ì£¼ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
                allDataCache = getAllData(); // getAllData()ê°€ localStorageì—ì„œ ì½ì–´ì˜´
                dataLoaded = true;
                return false; // Failure signal
            }
        } catch (error) {
            console.error("Fetch Error (Read All):", error);
            showToast("ì„œë²„ í†µì‹  ì˜¤ë¥˜ë¡œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¡œì»¬ ìºì‹œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.");
            
            // â­ Fetch ì‹¤íŒ¨ ì‹œ ë¡œì»¬ ìºì‹œë¥¼ ë°ì´í„°ë¡œ ê°„ì£¼ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
            allDataCache = getAllData();
            dataLoaded = true;
            return false; // Failure signal
        } finally {
            // ë¡œë”© ë
            if (btn) { btn.disabled = false; btn.textContent = 'ìƒˆë¡œê³ ì¹¨'; }
        }
    }

    // [ìˆ˜ì •] ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬: GASì—ì„œ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ë¶ˆëŸ¬ì™€ í™”ë©´ ì—…ë°ì´íŠ¸
    async function refreshDashboardData() {
        const success = await syncDataFromGAS(true); // ê°•ì œ ë™ê¸°í™” ì‹¤í–‰
        if (success) {
            renderTeacherDashboard(); // ë™ê¸°í™” í›„ ëŒ€ì‹œë³´ë“œ í™”ë©´ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
            showToast("ëŒ€ì‹œë³´ë“œê°€ ìµœì‹  ê¸°ë¡ìœ¼ë¡œ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤."); // Specific success message
        }
    }
    
    // --- êµì‚¬ ëŒ€ì‹œë³´ë“œ ìª½ì§€í•¨ ë Œë”ë§ ---
    async function renderTeacherNotes() {
        const listContainer = document.getElementById('notesList');
        const errorEl = document.getElementById('notesLoadingError');
        listContainer.innerHTML = '<div class="text-center py-10"><div class="loader mx-auto"></div><p class="text-gray-600 mt-4">ìª½ì§€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>';
        errorEl.classList.add('hidden');

        try {
            // GASì— 'readNotes' ì•¡ì…˜ì„ ìš”ì²­í•©ë‹ˆë‹¤.
            const response = await fetch(GAS_URL + '?action=readNotes', { mode: 'cors' });
            const result = await response.json();

            if (response.ok && Array.isArray(result)) {
                listContainer.innerHTML = '';
                
                if (result.length === 0) {
                    listContainer.innerHTML = '<p class="text-gray-500 text-center py-10">ë„ì°©í•œ ìª½ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                // ìª½ì§€ ë°ì´í„°ëŠ” ì„œë²„ì—ì„œ ë‚ ì§œ/ì‹œê°„ ìˆœìœ¼ë¡œ ê°€ì ¸ì™”ë‹¤ê³  ê°€ì •í•˜ê³  ìµœì‹ ìˆœ(ì—­ìˆœ)ìœ¼ë¡œ ë Œë”ë§í•©ë‹ˆë‹¤.
                result.slice().reverse().forEach(note => {
                    const timestamp = new Date(note.timestamp).toLocaleString('ko-KR', { 
                        year: '2-digit', 
                        month: '2-digit', 
                        day: '2-digit', 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });

                    listContainer.innerHTML += `
                        <div class="bg-gray-50 p-4 rounded-xl shadow-md border border-gray-200">
                            <div class="flex justify-between items-start mb-2 border-b pb-2">
                                <span class="font-bold text-lg text-gray-800">ğŸ’Œ ${note.name}ë²ˆ í•™ìƒ</span>
                                <span class="text-xs text-gray-500">${timestamp}</span>
                            </div>
                            <p class="text-gray-700 whitespace-pre-wrap">${note.content}</p>
                        </div>
                    `;
                });
            } else {
                console.error("Note load error:", result);
                listContainer.innerHTML = '';
                errorEl.classList.remove('hidden');
            }

        } catch (error) {
            console.error("Note Fetch Error:", error);
            listContainer.innerHTML = '';
            errorEl.classList.remove('hidden');
            errorEl.textContent = "ì„œë²„ í†µì‹  ì˜¤ë¥˜: ìª½ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        }
    }


    // --- í•™ìƒ ë¦¬í¬íŠ¸ (êµì‚¬ ë·° ë° ê³µìœ  ë·° ê³µí†µ ë¡œì§) ---
    async function renderStudentReportContent(containerSelector, studentNumber, monthString) {
        const container = document.querySelector(containerSelector);
        if (!container) { console.error("Container not found:", containerSelector); return; }

        const studentAllData = getAllData().filter(d => d.studentNumber === studentNumber);
        const studentMonthData = studentAllData.filter(d => d.date.startsWith(monthString));
        
        // [ìˆ˜ì •ëœ ë¶€ë¶„]: ì›” í‘œì‹œë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
        const yearMonth = monthString.split('-').map(s => parseInt(s));
        const monthTitle = `${yearMonth[0]}ë…„ ${yearMonth[1]}ì›”`;
        container.querySelector('#candyJarTitle').textContent = `ğŸ¬ ê°ì • ì‚¬íƒ• ë³‘ (${monthTitle})`;
        container.querySelector('#monthlyRecordsTitle').textContent = `${monthTitle}ì˜ ì „ì²´ ê¸°ë¡`;

        const total = studentAllData.length;
        const categoryCounts = { positive: 0, negative: 0, neutral: 0 };
        studentMonthData.forEach(entry => categoryCounts[getEmotionType(entry.emotion, entry)]++);

        container.querySelector('#myTotalRecords').textContent = total;
        container.querySelector('#myPositiveCount').textContent = categoryCounts.positive;
        container.querySelector('#myNeutralCount').textContent = categoryCounts.neutral;
        container.querySelector('#myNegativeCount').textContent = categoryCounts.negative;

        renderChart(container.querySelector('#myEmotionChart'), 'doughnut', { labels: ['ê¸ì •', 'ë¶€ì •', 'ì¤‘ë¦½'], datasets: [{ data: Object.values(categoryCounts), backgroundColor: ['#4CAF50', '#F44336', '#FFC107'] }] }, { responsive: true, maintainAspectRatio: false });

        const [year, month] = monthString.split('-').map(Number);
        const daysInMonth = new Date(year, month, 0).getDate();
        const dailyTrends = Array(daysInMonth).fill(null).map((_, i) => {
            const dayStr = `${monthString}-${String(i + 1).padStart(2, '0')}`;
            const dayData = studentMonthData.filter(d => d.date === dayStr);
            if (!dayData) return null;
            const category = getEmotionType(dayData.emotion, dayData);
            if (category === 'positive') return 1;
            if (category === 'negative') return -1;
            return 0;
        });

        renderChart(container.querySelector('#myTrendChart'), 'line', {
            labels: Array(daysInMonth).fill(null).map((_, i) => i + 1),
            datasets: [{
                label: 'ê°ì • ë³€í™”', data: dailyTrends, borderColor: '#667eea', backgroundColor: '#667eea20', fill: true, tension: 0.1, spanGaps: true
            }]
        }, { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: `${month}ì›”` } }, y: { ticks: { callback: (v) => { if (v === 1) return 'ê¸ì •'; if (v === -1) return 'ë¶€ì •'; if (v === 0) return 'ì¤‘ë¦½'; return null; } }, min: -1.5, max: 1.5 } } });

        // [ë³µì›] ìì£¼ ëŠë¼ëŠ” ê°ì • TOP 5
        const topEmotionsContainer = container.querySelector('#myTopEmotions');
        topEmotionsContainer.innerHTML = '';
        // [ë³µì›] 'studentAllData'ë¥¼ ì‚¬ìš©í•˜ì—¬ ì „ì²´ ê¸°ê°„ Top 5 ì§‘ê³„
        const emotionCounts = studentAllData.reduce((acc, curr) => { acc[curr.emotion] = (acc[curr.emotion] || 0) + 1; return acc; }, {});
        const sortedEmotions = Object.entries(emotionCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);

        if (sortedEmotions.length > 0) {
            sortedEmotions.forEach(([emotion, count], index) => {
                const emoji = studentAllData.find(d => d.emotion === emotion)?.emoji || DEFAULT_EMOJIS[getEmotionType(emotion)];
                topEmotionsContainer.innerHTML += `<div class="flex items-center justify-between text-gray-700 border-b pb-2"><span>${index + 1}. ${emoji} ${emotion}</span><span class="font-bold">${count}íšŒ</span></div>`;
            });
        } else {
            topEmotionsContainer.innerHTML = '<p class="text-gray-500">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        }

        // [ì‹ ê·œ] ê°ì • ì‚¬íƒ• ë³‘ (ì „ì²´ ê¸°ë¡)
        const candyContainer = container.querySelector('#candyContainer');
        candyContainer.innerHTML = ''; // Clear previous candies
        
        if (studentMonthData.length > 0) {
            // Jar dimensions (approx w-80, h-80 in pixels)
            // [ìˆ˜ì •] ìœ ë¦¬ë³‘ ì´ë¯¸ì§€ ìŠ¤ì¼€ì¼ 1.09ì— ë§ì¶° ì»¨í…Œì´ë„ˆì˜ í¬ê¸°ë¥¼ ê³ ë ¤í•œ ì‹¤ì œ ìœ ë¦¬ë³‘ ë‚´ë¶€ ê³µê°„ ì¶”ì •
            const jarVisualWidth = 400 * 1.09; // ì›ë˜ w-full (max-w-4xl)ì—ì„œ ëŒ€ëµ 400px ê°€ì • * 1.09
            const jarVisualHeight = 500 * 1.09; // ì›ë˜ h-[45rem]ì—ì„œ ëŒ€ëµ 500px ê°€ì • * 1.09

            // â­ [ìˆ˜ì •] ì´ëª¨í‹°ì½˜ í¬ê¸° 50% ì¶”ê°€ í™•ëŒ€ (ê¸°ì¡´ 84pxì—ì„œ * 1.5 = 126px)
            const candySize = 126; 

            // ì´ëª¨í‹°ì½˜ì´ ë†“ì¼ ìˆ˜ ìˆëŠ” ìœ íš¨ ì˜ì—­ì„ ìœ ë¦¬ë³‘ ì´ë¯¸ì§€ ì¤‘ì•™ ê¸°ì¤€ìœ¼ë¡œ ì¡°ì •
            // (ì»¨í…Œì´ë„ˆ í¬ê¸° - ìœ ë¦¬ë³‘ ì‹¤ì œ í¬ê¸°) / 2 ë§Œí¼ì˜ ì˜¤í”„ì…‹
            const offsetX = (candyContainer.offsetWidth - jarVisualWidth) / 2;
            const offsetY = (candyContainer.offsetHeight - jarVisualHeight) / 2;

            // [ì‹ ê·œ] ê²¹ì¹˜ì§€ ì•ŠëŠ” ìŒ“ê¸° ë¡œì§
            // í•œ ì¤„ì— 70%ì”© ê²¹ì³ì„œ ëª‡ ê°œê°€ ë“¤ì–´ê°ˆ ìˆ˜ ìˆëŠ”ì§€ ê³„ì‚°
            const stackWidth = candySize * 0.7; 
            const maxCandiesPerRow = Math.floor((jarVisualWidth * 0.8) / stackWidth); // 80% ë„ˆë¹„
            // ìœ„ë¡œ ìŒ“ì¼ ë•Œ 30% ë†’ì´ë§Œí¼ë§Œ ë³´ì´ê²Œ
            const stackHeight = candySize * 0.3;

            studentMonthData.forEach((entry, index) => {
                const candy = document.createElement('div');
                
                // â­ [ìˆ˜ì •] ì´ëª¨í‹°ì½˜ 50% ì¶”ê°€ í™•ëŒ€ (w-28, h-28, text-7xl)
                candy.className = `w-28 h-28 rounded-full flex items-center justify-center text-7xl absolute falling-candy`; 
                
                candy.textContent = entry.emoji;
                candy.title = `${entry.date}: ${entry.emotion}`;

                // [ìˆ˜ì •] ê²¹ì¹˜ì§€ ì•Šê²Œ ìŒ“ê¸° ìœ„í•œ ìœ„ì¹˜ ê³„ì‚°
                const row = Math.floor(index / maxCandiesPerRow);
                const col = index % maxCandiesPerRow;

                // [ìˆ˜ì •] ë³‘ ë°”ë‹¥(offsetY) + ìŒ“ì´ëŠ” ë†’ì´ + ì•½ê°„ì˜ ë¬´ì‘ìœ„
                let finalBottom = offsetY + (row * stackHeight) + (Math.random() * 5 - 2.5); 
                
                // [ìˆ˜ì •] 10% ì—¬ë°± + ìŒ“ì´ëŠ” ë„ˆë¹„ + ì§/í™€ìˆ˜ ì¤„ ì§€ê·¸ì¬ê·¸ + ì•½ê°„ì˜ ë¬´ì‘ìœ„
                let finalLeft = offsetX + (jarVisualWidth * 0.1) + (col * stackWidth) 
                              + (row % 2 === 1 ? stackWidth / 2 : 0) // ì§€ê·¸ì¬ê·¸
                              + (Math.random() * 10 - 5);

                // ì§€ê·¸ì¬ê·¸ë¡œ ì¸í•´ ë³‘ ë°–ìœ¼ë¡œ ë‚˜ê°€ëŠ” ê²ƒ ë°©ì§€
                if (finalLeft + candySize > offsetX + jarVisualWidth * 0.9) {
                    finalLeft -= stackWidth / 2;
                }

                // [ìˆ˜ì •] JSì—ì„œ ìµœì¢… ìœ„ì¹˜(left, bottom)ë¥¼ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘ ì „ì— ë°”ë¡œ ì„¤ì •
                candy.style.left = `${finalLeft}px`;
                candy.style.bottom = `${finalBottom}px`; 
                
                /* [ìˆ˜ì •] ì• ë‹ˆë©”ì´ì…˜ ì§€ì—° ì‹œê°„ì„ ê°œë³„ì ìœ¼ë¡œ ì„¤ì • */
                candy.style.animationDelay = `${index * 0.15}s`; 
                candy.style.setProperty('--final-rotate', `${Math.random() * 360}deg`); // ìµœì¢… íšŒì „ ê°ë„

                // [ìˆ˜ì •] íˆ´íŒ ì¶”ê°€
                candy.onmouseenter = (e) => {
                    tooltip.innerHTML = `<strong>${entry.date}</strong><br><span>${entry.emotion} ${entry.emoji}</span><br><span class="text-sm">${entry.reason}</span>`;
                    tooltip.classList.add('show');
                    // íˆ´íŒ ìœ„ì¹˜ ì¡°ì • (ì‚¬íƒ• ìœ„ì— í‘œì‹œ)
                    const rect = e.target.getBoundingClientRect();
                    tooltip.style.left = `${rect.left + rect.width / 2 - tooltip.offsetWidth / 2}px`;
                    tooltip.style.top = `${rect.top - tooltip.offsetHeight - 5}px`;
                };
                candy.onmouseleave = () => tooltip.classList.remove('show');

                candyContainer.appendChild(candy);
            });
        } else {
            candyContainer.innerHTML = '<p class="text-gray-500">ì„ íƒí•œ ë‹¬ì— ê¸°ë¡ëœ ê°ì • ì‚¬íƒ•ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        }


        // [ë³µì›] ì„ íƒí•œ ë‹¬ì˜ ì „ì²´ ê¸°ë¡
        const recordsContainer = container.querySelector('#myRecentRecords');
        recordsContainer.innerHTML = '';
        if (studentMonthData.length > 0) {
            // [ìˆ˜ì •] ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ í‘œì‹œ
            studentMonthData.slice().sort((a, b) => b.date.localeCompare(a.date)).forEach(entry => {
                recordsContainer.innerHTML += `
                    <div class="bg-gray-50 p-4 rounded-xl shadow-sm border-l-4 ${entry.category === 'positive' ? 'border-green-500' : entry.category === 'negative' ? 'border-red-500' : 'border-gray-500'}">
                        <p class="font-semibold text-gray-800">${entry.date} &middot; ${entry.emotion} ${entry.emoji}</p>
                        <p class="text-sm text-gray-600 mt-1 whitespace-pre-wrap">${entry.reason}</p>
                    </div>
                `;
            });
        } else {
            recordsContainer.innerHTML = '<p class="text-gray-500">ì„ íƒí•œ ë‹¬ì˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        }
    }


    function renderStudentReport(studentNumber, isTeacherView = true) {
        currentStudentForReport = studentNumber;
        showPage('studentReportPage');

        // 1. í—¤ë” ë° ì›” ì„ íƒê¸° ì„¤ì •
        document.getElementById('studentReportNumber').textContent = `${studentNumber}ë²ˆ í•™ìƒì˜ ë¦¬í¬íŠ¸`;
        
        const monthPicker = document.getElementById('studentReportMonth');
        if (!monthPicker.dataset.listenerAttached) {
             monthPicker.addEventListener('change', () => renderStudentReport(studentNumber, isTeacherView));
             monthPicker.dataset.listenerAttached = 'true';
        }
        
        // í˜„ì¬ ì›”ì´ ì„¤ì •ë˜ì–´ ìˆì§€ ì•Šìœ¼ë©´ ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì„¤ì •
        const today = new Date();
        const defaultMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
        monthPicker.value = monthPicker.value || defaultMonth;
        
        const selectedMonth = monthPicker.value;

        // 2. ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¸°ê¸°
        document.getElementById('dashboardButton').classList.toggle('hidden', !isTeacherView);
        document.getElementById('mainPageButton').classList.toggle('hidden', isTeacherView);
        
        // 3. ë°ì´í„° ë Œë”ë§
        // [ìˆ˜ì •] renderStudentReportContent í•¨ìˆ˜ í˜¸ì¶œ
        renderStudentReportContent('#studentReportPage', studentNumber, selectedMonth);

        // 4. AI ì¡°ì–¸ ì„¹ì…˜ ì´ˆê¸°í™” (í•™ìƒ ë·°ì—ì„œë§Œ ì‚¬ìš©)
        const aiAdviceEl = document.getElementById('aiAdvice');
        const generateAdviceBtn = document.getElementById('generateAdviceBtn');
        // [FIX] í•™ìƒ ë¦¬í¬íŠ¸ í˜ì´ì§€ ë‚´ì˜ ë§ˆì§€ë§‰ p-6.mb-6 ì—˜ë¦¬ë¨¼íŠ¸ê°€ AI ì¡°ì–¸ ì„¹ì…˜ ì»¨í…Œì´ë„ˆì„
        const adviceContainer = document.querySelector('#studentReportPage > .max-w-4xl > .bg-white.rounded-2xl.shadow-lg.p-6.mb-6:last-child');
        
        // [ì•ˆì •í™”] ì»¨í…Œì´ë„ˆê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ í›„ ë¡œì§ ì‹¤í–‰
        if (adviceContainer) {
            if (isTeacherView) {
                // êµì‚¬ ë·°ì—ì„œëŠ” AI ì¡°ì–¸ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
                adviceContainer.classList.add('hidden');
            } else {
                // í•™ìƒ ë·°ì—ì„œëŠ” AI ì¡°ì–¸ ì„¹ì…˜ í‘œì‹œ
                adviceContainer.classList.remove('hidden');
                if (aiAdviceEl) aiAdviceEl.innerHTML = '<p class="text-sm text-gray-500">ë²„íŠ¼ì„ ëˆŒëŸ¬ ì„ ìƒë‹˜ì˜ ê²©ë ¤ ë©”ì‹œì§€ë¥¼ ìƒì„±í•´ ë³´ì„¸ìš”.</p>';
                if (generateAdviceBtn) {
                     generateAdviceBtn.disabled = false;
                     generateAdviceBtn.textContent = 'ì¡°ì–¸ ìƒì„±í•˜ê¸°';
                }
            }
        }
    }


    // [ë³µì›] AI ì¡°ì–¸ ìƒì„± í•¨ìˆ˜
    async function fetchAIAdvice() {
        const studentNumber = currentStudentForReport;
        if (!studentNumber) return showToast('í•™ìƒ ë²ˆí˜¸ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        if (!API_KEY) return showToast('ì„ ìƒë‹˜! Gemini API í‚¤ë¥¼ ì„¤ì •í•´ì•¼ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ìš”.');

        const btn = document.getElementById('generateAdviceBtn');
        const aiAdviceEl = document.getElementById('aiAdvice');
        
        btn.disabled = true;
        btn.textContent = 'ì¡°ì–¸ ë¶„ì„ ì¤‘...';
        aiAdviceEl.innerHTML = '<div class="loader mx-auto"></div><p class="text-center text-purple-700 mt-2">í•™ìƒì˜ ê°ì • ê¸°ë¡ì„ ë¶„ì„í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>';

        const studentData = getAllData().filter(d => d.studentNumber === studentNumber);
        
        if (studentData.length === 0) {
             aiAdviceEl.innerHTML = '<p class="text-red-600 font-semibold">ì•„ì§ ì´ í•™ìƒì˜ ê¸°ë¡ì´ ì—†ì–´ ì¡°ì–¸ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
             btn.disabled = false;
             btn.textContent = 'ì¡°ì–¸ ìƒì„±í•˜ê¸°';
             return;
        }
        
        // ìµœê·¼ ê¸°ë¡ 5ê°œì™€ ì „ì²´ í†µê³„ ë°ì´í„°ë¥¼ ìš”ì•½
        const recentRecords = studentData.slice(-5).map(e => `[${e.date} ${e.emotion}] ${e.reason}`).join('\n');
        const totalCounts = studentData.reduce((acc, curr) => { acc[getEmotionType(curr.emotion, curr)]++; return acc; }, { positive: 0, negative: 0, neutral: 0 });
        
        const prompt = `ë‹¹ì‹ ì€ ì´ˆë“±í•™ìƒì˜ ë‹´ì„ ì„ ìƒë‹˜ì…ë‹ˆë‹¤. ì•„ë˜ëŠ” ${studentNumber}ë²ˆ í•™ìƒì˜ ìµœê·¼ ê°ì •ì¼ê¸° ê¸°ë¡ê³¼ ì „ì²´ì ì¸ ê°ì • í†µê³„ì…ë‹ˆë‹¤. ì´ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•™ìƒì—ê²Œ í˜ì´ ë˜ê³  ê²©ë ¤ê°€ ë˜ëŠ” ê¸ì •ì ì´ê³  ë”°ëœ»í•œ **ì§§ì€ ì¡°ì–¸** í•œ ë§ˆë””ë¥¼ í•œêµ­ì–´ë¡œ ì‘ì„±í•´ ì£¼ì„¸ìš”. ì¡°ì–¸ì€ ë°˜ë“œì‹œ 3ë¬¸ì¥ ì´ë‚´ë¡œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

<í•™ìƒ ê°ì • í†µê³„>
- ì „ì²´ ê¸°ë¡: ${studentData.length}ê±´
- ê¸ì •: ${totalCounts.positive}íšŒ, ë¶€ì •: ${totalCounts.negative}íšŒ, ì¤‘ë¦½: ${totalCounts.neutral}íšŒ

<ìµœê·¼ 5ì¼ê°„ì˜ ê¸°ë¡ (ìµœì‹ ìˆœ)>
${recentRecords}

ì„ ìƒë‹˜ì˜ ì¡°ì–¸:`;

        const advice = await callGeminiAPI(prompt);

        if (advice) {
            aiAdviceEl.innerHTML = `<p class="whitespace-pre-wrap">${advice}</p>`;
        } else {
            aiAdviceEl.innerHTML = '<p class="text-red-600 font-semibold">AI ì¡°ì–¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</p>';
        }

        btn.disabled = false;
        btn.textContent = 'ì¡°ì–¸ ë‹¤ì‹œ ìƒì„±í•˜ê¸°';
    }


    document.addEventListener('DOMContentLoaded', async () => {
        document.getElementById('currentDate').textContent = getTodayDateString();
        // í¼ ë“œë¡­ë‹¤ìš´ê³¼ ì´ëª¨í‹°ì½˜ ì±„ìš°ê¸° (í˜ì´ì§€ ë¡œë“œ ì‹œ ë¯¸ë¦¬ ì‹¤í–‰)
        populateForms(); 

        // 1. ë°ì´í„° ë¡œë“œ ì‹œë„
        // â­ [ìˆ˜ì •] í˜ì´ì§€ ë¡œë“œ ì‹œ GAS ë°ì´í„° ë™ê¸°í™” ì‹œë„ (ì„±ê³µ ì—¬ë¶€ ë°˜í™˜)
        const loadSuccess = await syncDataFromGAS(); 

        // 2. ì´ˆê¸° í˜ì´ì§€ í‘œì‹œ
        // [FIX] ì´ˆê¸° í˜ì´ì§€ë¥¼ í™•ì‹¤í•˜ê²Œ í‘œì‹œ
        showPage('mainPage');
        
        // 3. [FIX] í¼ ì œì¶œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ DOMContentLoaded ë‚´ë¶€ë¡œ ì´ë™ ë° ì—°ê²°
        
        // í•™ìƒ ë¡œê·¸ì¸ í¼
        const studentLoginForm = document.getElementById('studentLoginForm');
        if (studentLoginForm) {
            studentLoginForm.addEventListener('submit', handleStudentLogin);
        }
        
        // êµì‚¬ ë¡œê·¸ì¸ í¼
        const teacherLoginForm = document.getElementById('teacherLoginForm');
        if (teacherLoginForm) {
            teacherLoginForm.addEventListener('submit', handleTeacherLogin); // ë¶„ë¦¬ëœ í•¨ìˆ˜ ì—°ê²°
        }

        // [ì¶”ê°€] ì´ˆê¸° ëŒ€ì‹œë³´ë“œ ë‚ ì§œ ì„¤ì •
        const dashboardDate = document.getElementById('dashboardDate');
        if (dashboardDate) dashboardDate.value = getTodayDateString();
        const today = new Date();
        const dashboardMonth = document.getElementById('dashboardMonth');
        if (dashboardMonth) dashboardMonth.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
    });
    </script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-purple-50 min-h-screen">

    <div id="appContainer">

        <div id="mainPage" class="container mx-auto px-4 pt-24 pb-16">
            <div class="text-center mb-12 fade-in">
                <h1 class="text-4xl font-bold text-gray-800 mb-4">ğŸ“ ìš°ë¦¬ë°˜ ê°ì •ì¼ê¸°</h1>
                <p class="text-lg text-gray-600">ë§¤ì¼ë§¤ì¼ ë‚´ ë§ˆìŒì„ ê¸°ë¡í•´ë³´ì„¸ìš”</p>
                <div class="text-sm text-gray-500 mt-2" id="currentDate"></div>
            </div>

            <div class="max-w-md mx-auto space-y-6">
                <button onclick="showPage('studentPage')" class="w-full bg-gradient-to-r from-blue-100 to-indigo-100 hover:from-blue-200 hover:to-indigo-200 text-indigo-700 font-semibold py-6 px-8 rounded-2xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
                    <div class="text-3xl mb-2">ğŸ§¸</div>
                    <div class="text-xl">í•™ìƒìš©</div>
                    <div class="text-sm opacity-90 mt-1">ê°ì •ì¼ê¸° ì‘ì„±í•˜ê¸°</div>
                </button>

                <button onclick="showPage('friendsPage')" class="w-full bg-gradient-to-r from-green-100 to-emerald-100 hover:from-green-200 hover:to-emerald-200 text-green-800 font-semibold py-6 px-8 rounded-2xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
                    <div class="text-3xl mb-2">ğŸ‘«</div>
                    <div class="text-xl">ì¹œêµ¬ë“¤ ê°ì • í™•ì¸í•˜ê¸°</div>
                    <div class="text-sm opacity-90 mt-1">ì˜¤ëŠ˜ ì¹œêµ¬ë“¤ì˜ ê¸°ë¶„ì€?</div>
                </button>
                
                </div>
            
            <p class="text-center text-sm text-gray-500 mt-20">
                made by í•´ì†”ì´ˆ ì‹¬ìŒ¤ ğŸ’œ ì˜¤ìƒ‰ì¹ ë°˜
            </p>

            <button onclick="showPage('studentLogin')" class="fixed bottom-40 right-6 bg-gradient-to-br from-blue-300 to-indigo-400 text-white w-16 h-16 rounded-full shadow-lg hover:shadow-xl transform hover:scale-110 transition-all duration-200 z-50 flex items-center justify-center">
                <div class="text-2xl">ğŸ“Š</div>
            </button>
            
            <button onclick="showPage('noteToTeacherPage')" class="fixed right-6 bg-gradient-to-br from-yellow-200 to-gray-300 text-gray-700 w-16 h-16 rounded-full shadow-lg hover:shadow-xl transform hover:scale-110 transition-all duration-200 z-50 flex items-center justify-center" style="bottom: 92px;">
                <div class="text-2xl">ğŸ’Œ</div>
            </button>


            <button onclick="showPage('teacherLogin')" class="fixed bottom-6 right-6 bg-gradient-to-br from-purple-300 to-pink-400 text-white w-16 h-16 rounded-full shadow-lg hover:shadow-xl transform hover:scale-110 transition-all duration-200 z-50 flex items-center justify-center">
                <div class="text-2xl">ğŸ‘©â€ğŸ«</div>
            </button>
        </div>

        <div id="studentPage" class="hidden container mx-auto px-4 py-8">
            <div class="max-w-2xl mx-auto">
                <div class="bg-white rounded-3xl shadow-xl p-8 fade-in">
                    <div class="flex items-center justify-between mb-8">
                        <h2 class="text-3xl font-bold text-gray-800">ğŸ“ ê°ì •ì¼ê¸° ì‘ì„±</h2>
                        <button onclick="showPage('mainPage')" class="text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
                    </div>

                    <form id="emotionForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ë²ˆí˜¸</label>
                            <select id="studentNumber" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white">
                                <option value="">ë²ˆí˜¸ ì„ íƒ</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-4">ì˜¤ëŠ˜ì˜ ê°ì •</label>

                            <div class="mb-6"><h4 class="text-sm font-semibold text-green-700 mb-3 flex items-center"><span class="mr-2">ğŸŒ¿</span>ê¸ì •ì ì¸ ê°ì •</h4><div id="positiveEmotions" class="grid grid-cols-5 gap-2"></div></div>
                            <div class="mb-6"><h4 class="text-sm font-semibold text-red-700 mb-3 flex items-center"><span class="mr-2">ğŸŒ§</span>ë¶€ì •ì ì¸ ê°ì •</h4><div id="negativeEmotions" class="grid grid-cols-5 gap-2"></div></div>
                            <div class="mb-6"><h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center"><span class="mr-2">ğŸŒ—</span>ì¤‘ë¦½Â·ë³µí•© ê°ì •</h4><div id="neutralEmotions" class="grid grid-cols-5 gap-2"></div></div>

                            <div class="mb-4"><button type="button" onclick="showCustomEmotionInput()" class="w-full bg-blue-50 hover:bg-blue-100 border-2 border-dashed border-blue-300 text-blue-700 font-medium py-3 px-4 rounded-xl transition-all duration-200">âœï¸ ì§ì ‘ ì…ë ¥í•˜ê¸°</button></div>
                            <div id="customEmotionContainer" class="hidden mb-4"><div class="flex gap-2"><input type="text" id="customEmotionInput" placeholder="ê°ì •ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì‹ ë‚¨)" class="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500"><button type="button" onclick="handleCustomEmotion()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-xl">í™•ì¸</button><button type="button" onclick="hideCustomEmotionInput()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-xl">ì·¨ì†Œ</button></div></div>

                            <input type="hidden" id="selectedEmotion" required><input type="hidden" id="selectedEmoji" required><input type="hidden" id="selectedCategory">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ê°ì •ì˜ ì´ìœ </label>
                            <textarea id="emotionReason" rows="4" required placeholder="ì˜¤ëŠ˜ ì´ëŸ° ê°ì •ì„ ëŠë‚€ ì´ìœ ë¥¼ ìì„¸íˆ ì ì–´ì£¼ì„¸ìš”..." class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
                        </div>

                        <div class="space-y-3">
                            <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 text-white font-semibold py-4 px-6 rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">ğŸ’¾ ê°ì •ì¼ê¸° ì €ì¥í•˜ê¸°</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div id="noteToTeacherPage" class="hidden container mx-auto px-4 py-8">
            <div class="max-w-2xl mx-auto">
                <div class="bg-white rounded-3xl shadow-xl p-8 fade-in">
                    <div class="flex items-center justify-between mb-8">
                        <h2 class="text-3xl font-bold text-gray-800">ğŸ’Œ ì„ ìƒë‹˜ê»˜ ìª½ì§€ ë³´ë‚´ê¸°</h2>
                        <button onclick="showPage('mainPage')" class="text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
                    </div>
                    <p class="text-gray-600 mb-6">ì„ ìƒë‹˜ê»˜ í•˜ê³  ì‹¶ì€ ì´ì•¼ê¸°, ë¹„ë°€ìŠ¤ëŸ¬ìš´ ê³ ë¯¼ ë“±ì„ ì ì–´ì£¼ì„¸ìš”. ì„ ìƒë‹˜ë§Œ ë³¼ ìˆ˜ ìˆì–´ìš”!</p>

                    <form id="noteForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ë²ˆí˜¸</label>
                            <select id="noteStudentNumber" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent bg-white">
                                <option value="">ë²ˆí˜¸ ì„ íƒ</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ìª½ì§€ ë‚´ìš©</label>
                            <textarea id="noteContent" rows="6" required placeholder="ì„ ìƒë‹˜ê»˜ ì „í•  ìª½ì§€ ë‚´ìš©ì„ ì‘ì„±í•´ì£¼ì„¸ìš”..." class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 resize-none"></textarea>
                        </div>

                        <div class="space-y-3">
                            <button type="submit" class="w-full bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 text-white font-semibold py-4 px-6 rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">ğŸ’Œ ìª½ì§€ ì „ì†¡í•˜ê¸°</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div id="friendsPage" class="hidden container mx-auto px-4 py-8">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white rounded-3xl shadow-xl p-8 fade-in">
                    <div class="flex items-center justify-between mb-8">
                        <h2 class="text-3xl font-bold text-gray-800">ğŸ‘« ì¹œêµ¬ë“¤ ê°ì • í™•ì¸í•˜ê¸°</h2>
                        <button onclick="showPage('mainPage')" class="text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
                    </div>
                    <div class="relative bg-gradient-to-br from-blue-100 to-purple-100 rounded-3xl p-8 min-h-[24rem] overflow-hidden">
                        <div class="text-center mb-6">
                            <h3 class="text-xl font-bold text-gray-800">ğŸŒˆ ìš°ë¦¬ë°˜ ì¹œêµ¬ë“¤ì˜ ê°ì •</h3>
                            <p class="text-sm text-gray-600 mt-2">ì´ëª¨í‹°ì½˜ì„ í„°ì¹˜í•´ë³´ì„¸ìš”! </p>
                        </div>
                        <div id="floatingEmotions" class="relative w-full h-80"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="studentLogin" class="hidden container mx-auto px-4 py-8">
            <div class="flex items-center justify-center min-h-screen">
                <div class="max-w-md w-full">
                    <div class="bg-white rounded-3xl shadow-xl p-8 fade-in">
                        <div class="flex items-center justify-between mb-8">
                            <h2 class="text-2xl font-bold text-gray-800">ğŸ“Š ë‚´ ê°ì • ë¦¬í¬íŠ¸</h2>
                            <button onclick="showPage('mainPage')" class="text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
                        </div>
                        <form id="studentLoginForm" class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ë²ˆí˜¸</label>
                                <select id="studentLoginNumber" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white">
                                    <option value="">ë²ˆí˜¸ ì„ íƒ</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ë¹„ë°€ë²ˆí˜¸ (4ìë¦¬)</label>
                                <input type="password" id="studentLoginPassword" required maxlength="4" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500" placeholder="ì„ ìƒë‹˜ê»˜ ë°›ì€ 4ìë¦¬ ìˆ«ì">
                            </div>
                            <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 text-white font-semibold py-4 px-6 rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition">ë¡œê·¸ì¸</button>
                        </form>
                        <div id="studentLoginError" class="hidden mt-4 p-3 bg-red-100 border border-red-300 text-red-700 rounded-xl text-sm text-center">ë²ˆí˜¸ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="teacherLogin" class="hidden container mx-auto px-4 py-8"><div class="flex items-center justify-center min-h-screen"><div class="max-w-md w-full"><div class="bg-white rounded-3xl shadow-xl p-8 fade-in"><div class="flex items-center justify-between mb-8"><h2 class="text-2xl font-bold text-gray-800">ğŸ” êµì‚¬ ë¡œê·¸ì¸</h2><button onclick="showPage('mainPage')" class="text-gray-500 hover:text-gray-700 text-2xl">âœ•</button></div><form id="teacherLoginForm" class="space-y-6"><div><label class="block text-sm font-medium text-gray-700 mb-2">ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="teacherPassword" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500"></div><button type="submit" class="w-full bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 text-white font-semibold py-4 px-6 rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition">ë¡œê·¸ì¸</button></form><div id="loginError" class="hidden mt-4 p-3 bg-red-100 border border-red-300 text-red-700 rounded-xl text-sm text-center">ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</div></div></div></div></div>

        <div id="teacherDashboard" class="hidden container mx-auto px-4 py-8">
            <div class="max-w-7xl mx-auto">
                <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <h1 class="text-3xl font-bold text-gray-800">ğŸ‘©â€ğŸ« êµì‚¬ ëŒ€ì‹œë³´ë“œ</h1>
                    <div class="flex items-center gap-4">
                        <input type="date" id="dashboardDate" class="px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <input type="month" id="dashboardMonth" class="hidden px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <button onclick="refreshDashboardData()" id="refreshDataBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">ìƒˆë¡œê³ ì¹¨</button>
                        <button onclick="clearLocalCache()" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">ë¡œì»¬ ìºì‹œ ì‚­ì œ</button>
                        <button onclick="logoutTeacher()" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">ë¡œê·¸ì•„ì›ƒ</button>
                    </div>
                </div>

                <div class="border-b border-gray-200 mb-6">
                    <nav class="-mb-px flex gap-4" aria-label="Tabs">
                        <button onclick="switchDashboardTab('daily')" id="dailyTab" class="tab-button whitespace-nowrap py-3 px-5 font-semibold text-gray-500 hover:text-indigo-600 border-b-2 border-transparent">ì¼ë³„ ë¦¬í¬íŠ¸</button>
                        <button onclick="switchDashboardTab('monthly')" id="monthlyTab" class="tab-button whitespace-nowrap py-3 px-5 font-semibold text-gray-500 hover:text-indigo-600 border-b-2 border-transparent">ì›”ë³„ ë¦¬í¬íŠ¸</button>
                        <button onclick="switchDashboardTab('notes')" id="notesTab" class="tab-button whitespace-nowrap py-3 px-5 font-semibold text-gray-500 hover:text-indigo-600 border-b-2 border-transparent">í•™ìƒ ìª½ì§€í•¨</button>
                    </nav>
                </div>

                <div id="dailyReportContent">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <h3 class="font-bold text-gray-600">ê¸°ë¡í•œ í•™ìƒ</h3>
                            <p id="todaySubmissionCount" class="text-3xl font-bold text-blue-600"></p>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <h3 class="font-bold text-gray-600">ê¸ì • ê°ì •</h3>
                            <p id="todayPositiveCount" class="text-3xl font-bold text-green-600"></p>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <h3 class="font-bold text-gray-600">ë¶€ì • ê°ì •</h3>
                            <p id="todayNegativeCount" class="text-3xl font-bold text-red-600"></p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <h2 id="dailyDistributionTitle" class="text-xl font-bold mb-4"></h2>
                            <div class="chart-container"><canvas id="dailyDistributionChart"></canvas></div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <h2 id="dailyEntriesTitle" class="text-xl font-bold mb-4"></h2>
                            <div id="dailyEntriesList" class="space-y-4 max-h-96 overflow-y-auto pr-2"></div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-lg mt-8">
                        <h2 class="text-xl font-bold mb-4">í•™ìƒë³„ ë¦¬í¬íŠ¸ (í•™ìƒ í´ë¦­í•˜ì—¬ ì´ë™)</h2>
                        <div id="studentReportLinks" class="grid grid-cols-6 gap-2"> 
                            </div>
                    </div>
                </div>

                <div id="monthlyReportContent" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                           <div class="bg-white p-6 rounded-2xl shadow-lg"><h3 class="font-bold text-gray-600">ì›” ê¸ì • ê°ì •</h3><p id="monthlyPositiveCount" class="text-3xl font-bold text-green-600"></p></div>
                           <div class="bg-white p-6 rounded-2xl shadow-lg"><h3 class="font-bold text-gray-600">ì›” ì¤‘ë¦½ ê°ì •</h3><p id="monthlyNeutralCount" class="text-3xl font-bold text-yellow-600"></p></div>
                           <div class="bg-white p-6 rounded-2xl shadow-lg"><h3 class="font-bold text-gray-600">ì›” ë¶€ì • ê°ì •</h3><p id="monthlyNegativeCount" class="text-3xl font-bold text-red-600"></p></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div class="bg-white p-6 rounded-2xl shadow-lg"><h2 class="text-xl font-bold mb-4">ì›”ë³„ ê°ì • ë¶„í¬</h2><div class="chart-container"><canvas id="monthlyDistributionChart"></canvas></div></div><div class="bg-white p-6 rounded-2xl shadow-lg"><h2 class="text-xl font-bold mb-4">ì¼ë³„ ê°ì • ì¶”ì´</h2><div class="chart-container"><canvas id="monthlyTrendChart"></canvas></div></div></div>
                </div>
                
                <div id="notesContent" class="hidden">
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-xl font-bold mb-4">ğŸ“® ë„ì°©í•œ ìª½ì§€ (ìµœì‹ ìˆœ)</h2>
                        <div id="notesList" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                            <div class="text-center text-gray-500 py-10">ë¡œë”© ì¤‘...</div>
                        </div>
                        <div id="notesLoadingError" class="hidden text-red-500 text-center mt-4">ìª½ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.</div>
                    </div>
                </div>
                </div>
        </div>

        <div id="studentReportPage" class="hidden container mx-auto px-4 py-8">
            <div class="max-w-4xl mx-auto">
                   <div id="studentReportHeader">
                    <div class="flex flex-wrap justify-between items-center mb-8 gap-4">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ“Š í•™ìƒ ê°ì • ë¦¬í¬íŠ¸</h1>
                            <p id="studentReportNumber" class="text-xl text-gray-600"></p>
                        </div>
                        <div class="flex items-center gap-4">
                            <input type="month" id="studentReportMonth" class="px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <div id="reportActionButtons" class="flex gap-2">
                                <button id="dashboardButton" onclick="showPage('teacherDashboard')" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">ëŒ€ì‹œë³´ë“œë¡œ</button>
                                <button id="mainPageButton" onclick="showPage('mainPage')" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg">ë©”ì¸ìœ¼ë¡œ</button>
                            </div>
                         </div>
                    </div>
                   </div>
                <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-blue-50 rounded-xl p-4 text-center">
                            <div class="text-sm text-gray-600">ì´ ê¸°ë¡ ìˆ˜</div>
                            <div id="myTotalRecords" class="text-2xl font-bold text-blue-600">0</div>
                        </div>
                        <div class="bg-green-50 rounded-xl p-4 text-center">
                            <div class="text-sm text-gray-600">ê¸ì •</div>
                            <div id="myPositiveCount" class="text-2xl font-bold text-green-600">0</div>
                        </div>
                        <div class="bg-gray-100 rounded-xl p-4 text-center">
                            <div class="text-sm text-gray-600">ì¤‘ë¦½</div>
                            <div id="myNeutralCount" class="text-2xl font-bold text-gray-600">0</div>
                        </div>
                        <div class="bg-red-50 rounded-xl p-4 text-center">
                            <div class="text-sm text-gray-600">ë¶€ì •</div>
                            <div id="myNegativeCount" class="text-2xl font-bold text-red-600">0</div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-lg p-6 mt-6">
                    <h3 id="candyJarTitle" class="text-xl font-bold text-gray-800 mb-6">ğŸ¬ ê°ì • ì‚¬íƒ• ë³‘ (ì„ íƒí•œ ë‹¬)</h3>
                    <div class="relative w-full h-[45rem] flex items-center justify-center bg-gray-50 rounded-2xl p-4 overflow-hidden">
                        
                        <div class="absolute inset-0 bg-contain bg-no-repeat bg-center" 
                              style="background-image: url('jar.png'); 
                                     transform: scale(1.09);"></div>

                        <div id="candyContainer" class="w-full h-full relative overflow-hidden pt-10">
                            </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-2xl shadow-lg p-6 mt-6">
                    <h3 id="monthlyRecordsTitle" class="text-xl font-bold text-gray-800 mb-6">ì„ íƒí•œ ë‹¬ì˜ ì „ì²´ ê¸°ë¡</h3>
                    <div id="myRecentRecords" class="space-y-4 max-h-96 overflow-y-auto"></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6 mt-6">
                    <div class="bg-white rounded-2xl shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">ì„ íƒí•œ ë‹¬ì˜ ê°ì • ë¶„í¬</h3>
                        <div class="chart-container"><canvas id="myEmotionChart"></canvas></div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">ì„ íƒí•œ ë‹¬ì˜ ê°ì • ë³€í™”</h3>
                        <div class="chart-container"><canvas id="myTrendChart"></canvas></div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-6">ğŸ† ìì£¼ ëŠë¼ëŠ” ê°ì • TOP 5 (ì „ì²´)</h3>
                    <div id="myTopEmotions" class="space-y-3"></div>
                </div>

                <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-6">ğŸ’– ì„ ìƒë‹˜ì˜ í•œ ë§ˆë””</h3>
                    <div class="mb-4">
                        <button id="generateAdviceBtn" onclick="fetchAIAdvice()" class="w-full bg-gradient-to-r from-purple-500 to-indigo-500 text-white font-semibold py-3 px-5 rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
                            ì¡°ì–¸ ìƒì„±í•˜ê¸°
                        </button>
                    </div>
                    <div id="aiAdvice" class="p-4 bg-purple-50 rounded-lg text-purple-800 min-h-[50px]">
                        <p class="text-sm text-gray-500">ë²„íŠ¼ì„ ëˆŒëŸ¬ ì„ ìƒë‹˜ì˜ ê²©ë ¤ ë©”ì‹œì§€ë¥¼ ìƒì„±í•´ ë³´ì„¸ìš”.</p>
                    </div>
                </div>
                
                </div>
        </div>

        <div id="sharedReportPage" class="hidden"></div>

    </div>

    <div id="categoryModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[1001]">
        <div class="bg-white p-8 rounded-2xl shadow-xl text-center w-full max-w-sm m-4">
            <h3 class="font-bold text-xl mb-4">ì´ ê°ì •ì€ ì–´ë–¤ ì¢…ë¥˜ì¸ê°€ìš”?</h3>
            <p id="fallbackEmotionText" class="mb-6 text-gray-600"></p>
            <div class="flex justify-center gap-3">
                <button onclick="setCustomCategory('positive')" class="flex-1 bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg font-semibold transition">ê¸ì •</button>
                <button onclick="setCustomCategory('negative')" class="flex-1 bg-red-500 hover:bg-red-600 text-white px-4 py-3 rounded-lg font-semibold transition">ë¶€ì •</button>
                <button onclick="setCustomCategory('neutral')" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-lg font-semibold transition">ì¤‘ë¦½</button>
            </div>
        </div>
    </div>
    <div id="tooltip" class="tooltip"></div>
    <div id="toast" class="hidden fixed bottom-5 left-1/2 -translate-x-1/2 bg-yellow-400 text-gray-800 font-semibold py-3 px-6 rounded-lg shadow-xl transform transition-all duration-300 opacity-0"></div>
</body>
</html>