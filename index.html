<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ìš°ë¦¬ë°˜ ê°ì •ì¼ê¸°</title>

  <!-- Tailwind & Chart.js -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Gowun+Batang:wght@400;700&display=swap');
    body { font-family: 'Gowun Batang', serif; }
    .emotion-card:hover { transform: translateY(-2px); }
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} }
    .floating-emotion{ position:absolute; font-size:2.5rem; cursor:pointer; transition:all .3s ease; animation:float 6s ease-in-out infinite; z-index:10;}
    .floating-emotion:hover{ transform:scale(1.3); z-index:20; }
    @keyframes float{0%,100%{transform:translateY(0) rotate(0)}25%{transform:translateY(-10px) rotate(2deg)}50%{transform:translateY(-5px) rotate(-1deg)}75%{transform:translateY(-15px) rotate(1deg)}}
    .tooltip{ position:fixed; background:rgba(255,255,255,.95); color:#333; padding:12px 16px; border-radius:12px; border:1px solid #ddd; font-size:14px; white-space:normal; max-width:300px; z-index:30; pointer-events:none; opacity:0; transform:translateY(10px); box-shadow:0 4px 15px rgba(0,0,0,.1); transition:opacity .3s, transform .3s;}
    .tooltip.show{ opacity:1; transform:translateY(0); }
    .tooltip::after{ content:none; }
    .chart-container{ position:relative; height:300px; width:100%; }
    .tab-button{ transition:all .3s ease; }
    .tab-button.active{ background:#fff; color:#4c51bf; border-color:#e0e7ff; box-shadow:0 2px 4px rgba(0,0,0,.05); }
    .loader{ border:4px solid #f3f3f3; border-top:4px solid #667eea; border-radius:50%; width:30px; height:30px; animation:spin 1s linear infinite; margin:20px auto; }
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    @keyframes fallAndSettle{
      0%{opacity:0; transform:translateY(-500px) rotate(-180deg)}
      60%{opacity:1; transform:translateY(0) rotate(var(--final-rotate))}
      75%{transform:translateY(-10px) rotate(var(--final-rotate))}
      95%{transform:translateY(0) rotate(var(--final-rotate))}
      100%{opacity:1; transform:translateY(0) rotate(var(--final-rotate))}
    }
    .falling-candy{ animation:fallAndSettle 6s ease-out forwards; }
  </style>
</head>

<body class="bg-gradient-to-br from-blue-50 to-purple-50 min-h-screen">
  <div id="appContainer">
    <!-- ë©”ì¸ -->
    <div id="mainPage" class="container mx-auto px-4 pt-24 pb-16">
      <div class="text-center mb-12 fade-in">
        <h1 class="text-4xl font-bold text-gray-800 mb-4">ğŸ“ ìš°ë¦¬ë°˜ ê°ì •ì¼ê¸°</h1>
        <p class="text-lg text-gray-600">ë§¤ì¼ë§¤ì¼ ë‚´ ë§ˆìŒì„ ê¸°ë¡í•´ë³´ì„¸ìš”</p>
        <div class="text-sm text-gray-500 mt-2" id="currentDate"></div>
      </div>

      <div class="max-w-md mx-auto space-y-6">
        <button onclick="showPage('studentPage')" class="w-full bg-gradient-to-r from-blue-100 to-indigo-100 hover:from-blue-200 hover:to-indigo-200 text-indigo-700 font-semibold py-6 px-8 rounded-2xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
          <div class="text-3xl mb-2">ğŸ§¸</div>
          <div class="text-xl">í•™ìƒìš©</div>
          <div class="text-sm opacity-90 mt-1">ê°ì •ì¼ê¸° ì‘ì„±í•˜ê¸°</div>
        </button>

        <button onclick="showPage('friendsPage')" class="w-full bg-gradient-to-r from-green-100 to-emerald-100 hover:from-green-200 hover:to-emerald-200 text-green-800 font-semibold py-6 px-8 rounded-2xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
          <div class="text-3xl mb-2">ğŸ‘«</div>
          <div class="text-xl">ì¹œêµ¬ë“¤ ê°ì • í™•ì¸í•˜ê¸°</div>
          <div class="text-sm opacity-90 mt-1">ì˜¤ëŠ˜ ì¹œêµ¬ë“¤ì˜ ê¸°ë¶„ì€?</div>
        </button>
      </div>

      <p class="text-center text-sm text-gray-500 mt-20">made by í•´ì†”ì´ˆ ì‹¬ìŒ¤ ğŸ’œ ì˜¤ìƒ‰ì¹ ë°˜</p>

      <!-- FABs -->
      <button onclick="showPage('studentLogin')" class="fixed bottom-40 right-6 bg-gradient-to-br from-blue-300 to-indigo-400 text-white w-16 h-16 rounded-full shadow-lg hover:shadow-xl transform hover:scale-110 transition-all duration-200 z-50 flex items-center justify-center">
        <div class="text-2xl">ğŸ“Š</div>
      </button>

      <button onclick="showPage('noteToTeacherPage')" class="fixed right-6 bg-gradient-to-br from-yellow-200 to-gray-300 text-gray-700 w-16 h-16 rounded-full shadow-lg hover:shadow-xl transform hover:scale-110 transition-all duration-200 z-50 flex items-center justify-center" style="bottom:92px;">
        <div class="text-2xl">ğŸ’Œ</div>
      </button>

      <button onclick="showPage('teacherLogin')" class="fixed bottom-6 right-6 bg-gradient-to-br from-purple-300 to-pink-400 text-white w-16 h-16 rounded-full shadow-lg hover:shadow-xl transform hover:scale-110 transition-all duration-200 z-50 flex items-center justify-center">
        <div class="text-2xl">ğŸ‘©â€ğŸ«</div>
      </button>
    </div>

    <!-- í•™ìƒ ì‘ì„± -->
    <div id="studentPage" class="hidden container mx-auto px-4 py-8">
      <div class="max-w-2xl mx-auto">
        <div class="bg-white rounded-3xl shadow-xl p-8 fade-in">
          <div class="flex items-center justify-between mb-8">
            <h2 class="text-3xl font-bold text-gray-800">ğŸ“ ê°ì •ì¼ê¸° ì‘ì„±</h2>
            <button onclick="showPage('mainPage')" class="text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
          </div>

          <form id="emotionForm" class="space-y-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ë²ˆí˜¸</label>
              <select id="studentNumber" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white">
                <option value="">ë²ˆí˜¸ ì„ íƒ</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-4">ì˜¤ëŠ˜ì˜ ê°ì •</label>

              <div class="mb-6">
                <h4 class="text-sm font-semibold text-green-700 mb-3 flex items-center"><span class="mr-2">ğŸŒ¿</span>ê¸ì •ì ì¸ ê°ì •</h4>
                <div id="positiveEmotions" class="grid grid-cols-5 gap-2"></div>
              </div>

              <div class="mb-6">
                <h4 class="text-sm font-semibold text-red-700 mb-3 flex items-center"><span class="mr-2">ğŸŒ§</span>ë¶€ì •ì ì¸ ê°ì •</h4>
                <div id="negativeEmotions" class="grid grid-cols-5 gap-2"></div>
              </div>

              <div class="mb-6">
                <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center"><span class="mr-2">ğŸŒ—</span>ì¤‘ë¦½Â·ë³µí•© ê°ì •</h4>
                <div id="neutralEmotions" class="grid grid-cols-5 gap-2"></div>
              </div>

              <div class="mb-4">
                <button type="button" onclick="showCustomEmotionInput()" class="w-full bg-blue-50 hover:bg-blue-100 border-2 border-dashed border-blue-300 text-blue-700 font-medium py-3 px-4 rounded-xl transition-all duration-200">âœï¸ ì§ì ‘ ì…ë ¥í•˜ê¸°</button>
              </div>

              <div id="customEmotionContainer" class="hidden mb-4">
                <div class="flex gap-2">
                  <input type="text" id="customEmotionInput" placeholder="ê°ì •ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì‹ ë‚¨)" class="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500">
                  <button type="button" onclick="handleCustomEmotion()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-xl">í™•ì¸</button>
                  <button type="button" onclick="hideCustomEmotionInput()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-xl">ì·¨ì†Œ</button>
                </div>
              </div>

              <input type="hidden" id="selectedEmotion" required>
              <input type="hidden" id="selectedEmoji" required>
              <input type="hidden" id="selectedCategory">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ê°ì •ì˜ ì´ìœ </label>
              <textarea id="emotionReason" rows="4" required placeholder="ì˜¤ëŠ˜ ì´ëŸ° ê°ì •ì„ ëŠë‚€ ì´ìœ ë¥¼ ìì„¸íˆ ì ì–´ì£¼ì„¸ìš”..." class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
            </div>

            <div class="space-y-3">
              <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 text-white font-semibold py-4 px-6 rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">ğŸ’¾ ê°ì •ì¼ê¸° ì €ì¥í•˜ê¸°</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- ìª½ì§€ ë³´ë‚´ê¸° -->
    <div id="noteToTeacherPage" class="hidden container mx-auto px-4 py-8">
      <div class="max-w-2xl mx-auto">
        <div class="bg-white rounded-3xl shadow-xl p-8 fade-in">
          <div class="flex items-center justify-between mb-8">
            <h2 class="text-3xl font-bold text-gray-800">ğŸ’Œ ì„ ìƒë‹˜ê»˜ ìª½ì§€ ë³´ë‚´ê¸°</h2>
            <button onclick="showPage('mainPage')" class="text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
          </div>
          <p class="text-gray-600 mb-6">ì„ ìƒë‹˜ê»˜ í•˜ê³  ì‹¶ì€ ì´ì•¼ê¸°, ë¹„ë°€ìŠ¤ëŸ¬ìš´ ê³ ë¯¼ ë“±ì„ ì ì–´ì£¼ì„¸ìš”. ì„ ìƒë‹˜ë§Œ ë³¼ ìˆ˜ ìˆì–´ìš”!</p>

          <form id="noteForm" class="space-y-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ë²ˆí˜¸</label>
              <select id="noteStudentNumber" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent bg-white">
                <option value="">ë²ˆí˜¸ ì„ íƒ</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ìª½ì§€ ë‚´ìš©</label>
              <textarea id="noteContent" rows="6" required placeholder="ì„ ìƒë‹˜ê»˜ ì „í•  ìª½ì§€ ë‚´ìš©ì„ ì‘ì„±í•´ì£¼ì„¸ìš”..." class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 resize-none"></textarea>
            </div>

            <div class="space-y-3">
              <button type="submit" class="w-full bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 text-white font-semibold py-4 px-6 rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">ğŸ’Œ ìª½ì§€ ì „ì†¡í•˜ê¸°</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- ì¹œêµ¬ë“¤ ê°ì • -->
    <div id="friendsPage" class="hidden container mx-auto px-4 py-8">
      <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-3xl shadow-xl p-8 fade-in">
          <div class="flex items-center justify-between mb-8">
            <h2 class="text-3xl font-bold text-gray-800">ğŸ‘« ì¹œêµ¬ë“¤ ê°ì • í™•ì¸í•˜ê¸°</h2>
            <button onclick="showPage('mainPage')" class="text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
          </div>
          <div class="relative bg-gradient-to-br from-blue-100 to-purple-100 rounded-3xl p-8 min-h-[24rem] overflow-hidden">
            <div class="text-center mb-6">
              <h3 class="text-xl font-bold text-gray-800">ğŸŒˆ ìš°ë¦¬ë°˜ ì¹œêµ¬ë“¤ì˜ ê°ì •</h3>
              <p class="text-sm text-gray-600 mt-2">ì´ëª¨í‹°ì½˜ì„ í„°ì¹˜í•´ë³´ì„¸ìš”!</p>
            </div>
            <div id="floatingEmotions" class="relative w-full h-80"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- í•™ìƒ ë¡œê·¸ì¸ -->
    <div id="studentLogin" class="hidden container mx-auto px-4 py-8">
      <div class="flex items-center justify-center min-h-screen">
        <div class="max-w-md w-full">
          <div class="bg-white rounded-3xl shadow-xl p-8 fade-in">
            <div class="flex items-center justify-between mb-8">
              <h2 class="text-2xl font-bold text-gray-800">ğŸ“Š ë‚´ ê°ì • ë¦¬í¬íŠ¸</h2>
              <button onclick="showPage('mainPage')" class="text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
            </div>
            <form id="studentLoginForm" class="space-y-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ë²ˆí˜¸</label>
                <select id="studentLoginNumber" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white">
                  <option value="">ë²ˆí˜¸ ì„ íƒ</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ë¹„ë°€ë²ˆí˜¸ (4ìë¦¬)</label>
                <input type="password" id="studentLoginPassword" required maxlength="4" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500" placeholder="ì„ ìƒë‹˜ê»˜ ë°›ì€ 4ìë¦¬ ìˆ«ì">
              </div>
              <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 text-white font-semibold py-4 px-6 rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition">ë¡œê·¸ì¸</button>
            </form>
            <div id="studentLoginError" class="hidden mt-4 p-3 bg-red-100 border border-red-300 text-red-700 rounded-xl text-sm text-center">ë²ˆí˜¸ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- êµì‚¬ ë¡œê·¸ì¸ -->
    <div id="teacherLogin" class="hidden container mx-auto px-4 py-8">
      <div class="flex items-center justify-center min-h-screen">
        <div class="max-w-md w-full">
          <div class="bg-white rounded-3xl shadow-xl p-8 fade-in">
            <div class="flex items-center justify-between mb-8">
              <h2 class="text-2xl font-bold text-gray-800">ğŸ” êµì‚¬ ë¡œê·¸ì¸</h2>
              <button onclick="showPage('mainPage')" class="text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
            </div>
            <form id="teacherLoginForm" class="space-y-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="teacherPassword" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500">
              </div>
              <button type="submit" class="w-full bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 text-white font-semibold py-4 px-6 rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition" onclick="handleTeacherLogin(event)">ë¡œê·¸ì¸</button>
            </form>
            <div id="loginError" class="hidden mt-4 p-3 bg-red-100 border border-red-300 text-red-700 rounded-xl text-sm text-center">ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- êµì‚¬ ëŒ€ì‹œë³´ë“œ -->
    <div id="teacherDashboard" class="hidden container mx-auto px-4 py-8">
      <div class="max-w-7xl mx-auto">
        <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
          <h1 class="text-3xl font-bold text-gray-800">ğŸ‘©â€ğŸ« êµì‚¬ ëŒ€ì‹œë³´ë“œ</h1>
          <div class="flex items-center gap-4">
            <input type="date" id="dashboardDate" class="px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <input type="month" id="dashboardMonth" class="hidden px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <button onclick="refreshDashboardData()" id="refreshDataBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">ìƒˆë¡œê³ ì¹¨</button>
            <button onclick="clearLocalCache()" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">ë¡œì»¬ ìºì‹œ ì‚­ì œ</button>
            <button onclick="logoutTeacher()" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">ë¡œê·¸ì•„ì›ƒ</button>
          </div>
        </div>

        <div class="border-b border-gray-200 mb-6">
          <nav class="-mb-px flex gap-4" aria-label="Tabs">
            <button onclick="switchDashboardTab('daily')" id="dailyTab" class="tab-button whitespace-nowrap py-3 px-5 font-semibold text-gray-500 hover:text-indigo-600 border-b-2 border-transparent">ì¼ë³„ ë¦¬í¬íŠ¸</button>
            <button onclick="switchDashboardTab('monthly')" id="monthlyTab" class="tab-button whitespace-nowrap py-3 px-5 font-semibold text-gray-500 hover:text-indigo-600 border-b-2 border-transparent">ì›”ë³„ ë¦¬í¬íŠ¸</button>
            <button onclick="switchDashboardTab('notes')" id="notesTab" class="tab-button whitespace-nowrap py-3 px-5 font-semibold text-gray-500 hover:text-indigo-600 border-b-2 border-transparent">í•™ìƒ ìª½ì§€í•¨</button>
          </nav>
        </div>

        <div id="dailyReportContent">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-2xl shadow-lg">
              <h3 class="font-bold text-gray-600">ê¸°ë¡í•œ í•™ìƒ</h3>
              <p id="todaySubmissionCount" class="text-3xl font-bold text-blue-600"></p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-lg">
              <h3 class="font-bold text-gray-600">ê¸ì • ê°ì •</h3>
              <p id="todayPositiveCount" class="text-3xl font-bold text-green-600"></p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-lg">
              <h3 class="font-bold text-gray-600">ë¶€ì • ê°ì •</h3>
              <p id="todayNegativeCount" class="text-3xl font-bold text-red-600"></p>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-2xl shadow-lg">
              <h2 id="dailyDistributionTitle" class="text-xl font-bold mb-4"></h2>
              <div class="chart-container"><canvas id="dailyDistributionChart"></canvas></div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-lg">
              <h2 id="dailyEntriesTitle" class="text-xl font-bold mb-4"></h2>
              <div id="dailyEntriesList" class="space-y-4 max-h-96 overflow-y-auto pr-2"></div>
            </div>
          </div>

          <div class="bg-white p-6 rounded-2xl shadow-lg mt-8">
            <h2 class="text-xl font-bold mb-4">í•™ìƒë³„ ë¦¬í¬íŠ¸ (í•™ìƒ í´ë¦­í•˜ì—¬ ì´ë™)</h2>
            <div id="studentReportLinks" class="grid grid-cols-6 gap-2"></div>
          </div>
        </div>

        <div id="monthlyReportContent" class="hidden">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-2xl shadow-lg">
              <h3 class="font-bold text-gray-600">ì›” ê¸ì • ê°ì •</h3>
              <p id="monthlyPositiveCount" class="text-3xl font-bold text-green-600"></p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-lg">
              <h3 class="font-bold text-gray-600">ì›” ì¤‘ë¦½ ê°ì •</h3>
              <p id="monthlyNeutralCount" class="text-3xl font-bold text-yellow-600"></p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-lg">
              <h3 class="font-bold text-gray-600">ì›” ë¶€ì • ê°ì •</h3>
              <p id="monthlyNegativeCount" class="text-3xl font-bold text-red-600"></p>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-2xl shadow-lg">
              <h2 class="text-xl font-bold mb-4">ì›”ë³„ ê°ì • ë¶„í¬</h2>
              <div class="chart-container"><canvas id="monthlyDistributionChart"></canvas></div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-lg">
              <h2 class="text-xl font-bold mb-4">ì¼ë³„ ê°ì • ì¶”ì´</h2>
              <div class="chart-container"><canvas id="monthlyTrendChart"></canvas></div>
            </div>
          </div>
        </div>

        <div id="notesContent" class="hidden">
          <div class="bg-white p-6 rounded-2xl shadow-lg">
            <h2 class="text-xl font-bold mb-4">ğŸ“® ë„ì°©í•œ ìª½ì§€ (ìµœì‹ ìˆœ)</h2>
            <div id="notesList" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
              <div class="text-center text-gray-500 py-10">ë¡œë”© ì¤‘...</div>
            </div>
            <div id="notesLoadingError" class="hidden text-red-500 text-center mt-4">ìª½ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- í•™ìƒ ë¦¬í¬íŠ¸ -->
    <div id="studentReportPage" class="hidden container mx-auto px-4 py-8">
      <div class="max-w-4xl mx-auto">
        <div id="studentReportHeader">
          <div class="flex flex-wrap justify-between items-center mb-8 gap-4">
            <div>
              <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ“Š í•™ìƒ ê°ì • ë¦¬í¬íŠ¸</h1>
              <p id="studentReportNumber" class="text-xl text-gray-600"></p>
            </div>
            <div class="flex items-center gap-4">
              <input type="month" id="studentReportMonth" class="px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
              <div id="reportActionButtons" class="flex gap-2">
                <button id="dashboardButton" onclick="showPage('teacherDashboard')" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">ëŒ€ì‹œë³´ë“œë¡œ</button>
                <button id="mainPageButton" onclick="showPage('mainPage')" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg">ë©”ì¸ìœ¼ë¡œ</button>
              </div>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-blue-50 rounded-xl p-4 text-center">
              <div class="text-sm text-gray-600">ì´ ê¸°ë¡ ìˆ˜</div>
              <div id="myTotalRecords" class="text-2xl font-bold text-blue-600">0</div>
            </div>
            <div class="bg-green-50 rounded-xl p-4 text-center">
              <div class="text-sm text-gray-600">ê¸ì •</div>
              <div id="myPositiveCount" class="text-2xl font-bold text-green-600">0</div>
            </div>
            <div class="bg-gray-100 rounded-xl p-4 text-center">
              <div class="text-sm text-gray-600">ì¤‘ë¦½</div>
              <div id="myNeutralCount" class="text-2xl font-bold text-gray-600">0</div>
            </div>
            <div class="bg-red-50 rounded-xl p-4 text-center">
              <div class="text-sm text-gray-600">ë¶€ì •</div>
              <div id="myNegativeCount" class="text-2xl font-bold text-red-600">0</div>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg p-6 mt-6">
          <h3 id="candyJarTitle" class="text-xl font-bold text-gray-800 mb-6">ğŸ¬ ê°ì • ì‚¬íƒ• ë³‘ (ì„ íƒí•œ ë‹¬)</h3>
          <div class="relative w-full h-[45rem] flex items-center justify-center bg-gray-50 rounded-2xl p-4 overflow-hidden">
            <div class="absolute inset-0 bg-contain bg-no-repeat bg-center" style="background-image:url('jar.png'); transform:scale(1.09);"></div>
            <div id="candyContainer" class="w-full h-full relative overflow-hidden pt-10"></div>
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg p-6 mt-6">
          <h3 id="monthlyRecordsTitle" class="text-xl font-bold text-gray-800 mb-6">ì„ íƒí•œ ë‹¬ì˜ ì „ì²´ ê¸°ë¡</h3>
          <div id="myRecentRecords" class="space-y-4 max-h-96 overflow-y-auto"></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6 mt-6">
          <div class="bg-white rounded-2xl shadow-lg p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">ì„ íƒí•œ ë‹¬ì˜ ê°ì • ë¶„í¬</h3>
            <div class="chart-container"><canvas id="myEmotionChart"></canvas></div>
          </div>
          <div class="bg-white rounded-2xl shadow-lg p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">ì„ íƒí•œ ë‹¬ì˜ ê°ì • ë³€í™”</h3>
            <div class="chart-container"><canvas id="myTrendChart"></canvas></div>
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
          <h3 class="text-xl font-bold text-gray-800 mb-6">ğŸ† ìì£¼ ëŠë¼ëŠ” ê°ì • TOP 5 (ì „ì²´)</h3>
          <div id="myTopEmotions" class="space-y-3"></div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
          <h3 class="text-xl font-bold text-gray-800 mb-6">ğŸ’– ì„ ìƒë‹˜ì˜ í•œ ë§ˆë””</h3>
          <div class="mb-4">
            <button id="generateAdviceBtn" onclick="fetchAIAdvice()" class="w-full bg-gradient-to-r from-purple-500 to-indigo-500 text-white font-semibold py-3 px-5 rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
              ì¡°ì–¸ ìƒì„±í•˜ê¸°
            </button>
          </div>
          <div id="aiAdvice" class="p-4 bg-purple-50 rounded-lg text-purple-800 min-h-[50px]">
            <p class="text-sm text-gray-500">ë²„íŠ¼ì„ ëˆŒëŸ¬ ì„ ìƒë‹˜ì˜ ê²©ë ¤ ë©”ì‹œì§€ë¥¼ ìƒì„±í•´ ë³´ì„¸ìš”.</p>
          </div>
        </div>
      </div>
    </div>

    <div id="sharedReportPage" class="hidden"></div>
  </div>

  <!-- ê¸€ë¡œë²Œ UI ìš”ì†Œ -->
  <div id="categoryModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[1001]">
    <div class="bg-white p-8 rounded-2xl shadow-xl text-center w-full max-w-sm m-4">
      <h3 class="font-bold text-xl mb-4">ì´ ê°ì •ì€ ì–´ë–¤ ì¢…ë¥˜ì¸ê°€ìš”?</h3>
      <p id="fallbackEmotionText" class="mb-6 text-gray-600"></p>
      <div class="flex justify-center gap-3">
        <button onclick="setCustomCategory('positive')" class="flex-1 bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg font-semibold transition">ê¸ì •</button>
        <button onclick="setCustomCategory('negative')" class="flex-1 bg-red-500 hover:bg-red-600 text-white px-4 py-3 rounded-lg font-semibold transition">ë¶€ì •</button>
        <button onclick="setCustomCategory('neutral')" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-lg font-semibold transition">ì¤‘ë¦½</button>
      </div>
    </div>
  </div>
  <div id="tooltip" class="tooltip"></div>
  <div id="toast" class="hidden fixed bottom-5 left-1/2 -translate-x-1/2 bg-yellow-400 text-gray-800 font-semibold py-3 px-6 rounded-lg shadow-xl transform transition-all duration-300 opacity-0"></div>

  <!-- ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸: DOMContentLoaded ë‚´ë¶€ë¡œ ì „ë¶€ ì´ë™ + window.*ë¡œ ê³µê°œ -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    /*** ====== ìƒìˆ˜/ìƒíƒœ ====== ***/
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzQWtHlJzzC_VNpuLD6VTKeliaRRajE3zPY1g9vpDxS2UmjWnCa48xuNoAXUczIJBPm_g/exec"; // â† í•„ìš”ì‹œ êµì²´
    const DB_NAME = 'emotionDiaryDB_v2';
    const SAMPLE_DATA_FLAG = 'sampleDataGenerated_v5_NoSample';
    const TEACHER_PASSWORD = 'teacher572';
    const API_KEY = "AIzaSyDnAn0avxLdzICLBYitlpUMErEqB2jB97s"; // í•„ìš”ì‹œ ì œê±°/êµì²´
    const PENDING_DELETES = 'emotionDiary_pendingDeletes';

    const STUDENT_NUMBERS = ["2","3","4","5","6","7","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","30"];
    const EMOTIONS = {
      positive:{'ê¸°ì¨':'ğŸ˜Š','ì„¤ë ˜':'ğŸ¤—','ë§Œì¡±':'ğŸ™‚','í‰ì˜¨í•¨':'ğŸ˜‡','ê°ì‚¬':'ğŸ¥°','ìì‹ ê°':'ğŸ˜','í¬ë§':'ğŸ˜Œ','ì¦ê±°ì›€':'ğŸ˜„','ì‚¬ë‘':'ğŸ˜','ë¿Œë“¯í•¨':'ğŸ¤©'},
      negative:{'ìŠ¬í””':'ğŸ˜¢','ë¶„ë…¸':'ğŸ˜ ','ì¢Œì ˆ':'ğŸ˜','ë‘ë ¤ì›€':'ğŸ˜¨','ë¶ˆì•ˆ':'ğŸ˜°','ì™¸ë¡œì›€':'ğŸ˜”','ì‹¤ë§':'ğŸ˜•','í›„íšŒ':'ğŸ˜£','ì§ˆíˆ¬':'ğŸ˜’','ì§œì¦':'ğŸ˜¤'},
      neutral:{'í˜¼ë€':'ğŸ˜µ','ë†€ëŒ':'ğŸ˜²','ê¸´ì¥':'ğŸ˜¬','ë¬´ê¸°ë ¥':'ğŸ˜‘','ë‹µë‹µí•¨':'ğŸ˜–','ì–µìš¸í•¨':'ğŸ˜¤','ë¶€ë„ëŸ¬ì›€':'ğŸ˜³','ì˜ì‹¬':'ğŸ¤”','í”¼ê³¤í•¨':'ğŸ˜´','ì„œìš´í•¨':'ğŸ™'}
    };
    const DEFAULT_EMOJIS = { positive:'ğŸ˜Š', negative:'ğŸ˜Ÿ', neutral:'ğŸ˜' };

    let allDataCache = [];
    let dataLoaded = false;
    let chartInstances = {};
    let currentStudentForReport = null;
    let pendingCustomEmotion = {};
    let toastTimeout = null, undoTimeout = null, lastDeletedEntry = null;

    const pages = ['mainPage','studentPage','friendsPage','teacherLogin','teacherDashboard','studentReportPage','studentLogin','noteToTeacherPage'];
    const tooltip = document.getElementById('tooltip');
    const toastEl = document.getElementById('toast');

    /*** ====== ìœ í‹¸ ====== ***/
    const getTodayDateString = () => {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    };

    const getAllData = () => {
      if (dataLoaded) {
        return allDataCache.map(entry => ({
          ...entry,
          id: String(entry.id),
          synced: entry.synced === true,
          date: (entry.date || (entry.timestamp ? entry.timestamp.split('T')[0] : getTodayDateString())),
          studentNumber: (entry.studentNumber || entry.name),
          reason: (entry.reason || entry.content),
          category: (entry.category || entry.tag)
        }));
      }
      const localData = localStorage.getItem(DB_NAME);
      return localData ? JSON.parse(localData).map(entry => ({
        ...entry,
        id: String(entry.id),
        synced: entry.synced === true,
        date: (entry.date || (entry.timestamp ? entry.timestamp.split('T')[0] : getTodayDateString())),
        studentNumber: (entry.studentNumber || entry.name),
        reason: (entry.reason || entry.content),
        category: (entry.category || entry.tag)
      })) : [];
    };

    const saveDataLocally = (data) => {
      const dataToSave = data.map(entry => ({
        id: String(entry.id),
        synced: entry.synced === true,
        date: (entry.date || (entry.timestamp ? entry.timestamp.split('T')[0] : getTodayDateString())),
        studentNumber: (entry.studentNumber || entry.name),
        emotion: entry.emotion,
        emoji: entry.emoji,
        reason: (entry.reason || entry.content),
        category: (entry.category || entry.tag)
      }));
      localStorage.setItem(DB_NAME, JSON.stringify(dataToSave));
      allDataCache = dataToSave;
      dataLoaded = true;
    };

    const getEmotionType = (emotion, entry=null) => {
      if (entry && entry.category) return entry.category;
      for (const type in EMOTIONS) {
        if (EMOTIONS[type][emotion]) return type;
      }
      return 'neutral';
    };

    function showToast(message, actionText=null, actionCallback=null, expiryCallback=null){
      clearTimeout(toastTimeout); clearTimeout(undoTimeout);
      const undoBtn = actionText && actionCallback ? `<button id="undoButton" class="ml-4 font-bold underline text-blue-800">${actionText}</button>` : '';
      toastEl.innerHTML = `<span>${message}</span>${undoBtn}`;
      toastEl.classList.remove('hidden','opacity-0');

      if (actionCallback){
        document.getElementById('undoButton')?.addEventListener('click', ()=>{
          clearTimeout(toastTimeout); clearTimeout(undoTimeout); actionCallback();
        });
        undoTimeout = setTimeout(()=>{ if (expiryCallback) expiryCallback(); }, 5000);
      }
      const hideDelay = actionCallback ? 5500 : 3000;
      toastTimeout = setTimeout(()=>{
        toastEl.classList.add('opacity-0');
        setTimeout(()=>toastEl.classList.add('hidden'), 300);
      }, hideDelay);
    }

    async function callGeminiAPI(prompt){
      if (!API_KEY) { console.log("Gemini API key not set"); return null; }
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
      try{
        let response, delay=1000;
        for (let i=0;i<5;i++){
          response = await fetch(apiUrl,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({contents:[{parts:[{text:prompt}]}]})});
          if (response.ok) break;
          if (response.status===429 || response.status>=500){ await new Promise(r=>setTimeout(r,delay)); delay*=2; }
          else { console.error("API Error:", await response.json()); return null; }
        }
        if (!response.ok) return null;
        const result = await response.json();
        return result.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || null;
      }catch(e){ console.error(e); return null; }
    }

    /*** ====== ì„œë²„ ë™ê¸°í™” ====== ***/
    async function syncDataFromGAS(isForce=false){
      if (!isForce && dataLoaded) return true;
      const btn = document.getElementById('refreshDataBtn');
      if (btn){ btn.disabled = true; btn.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...'; }
      try{
        const res = await fetch(GAS_URL + '?action=readAll', {mode:'cors'});
        const result = await res.json();
        if (res.ok && Array.isArray(result)){
          const normalized = result.map(entry=>({
            id:String(entry.id),
            date: entry.timestamp ? entry.timestamp.split('T')[0] : getTodayDateString(),
            studentNumber: String(entry.name),
            emotion: entry.emotion,
            emoji: entry.emoji,
            reason: entry.content,
            category: entry.tag,
            synced:true
          }));
          saveDataLocally(normalized);
          await flushPendingDeletes();
          return true;
        }else{
          showToast("ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: ë¡œì»¬ ìºì‹œ ì‚¬ìš©í•©ë‹ˆë‹¤.");
          allDataCache = getAllData(); dataLoaded = true;
          return false;
        }
      }catch(e){
        console.error(e);
        showToast("ì„œë²„ í†µì‹  ì˜¤ë¥˜: ë¡œì»¬ ìºì‹œ ì‚¬ìš©í•©ë‹ˆë‹¤.");
        allDataCache = getAllData(); dataLoaded = true;
        return false;
      }finally{
        if (btn){ btn.disabled=false; btn.textContent='ìƒˆë¡œê³ ì¹¨'; }
      }
    }

    function enqueuePendingDelete(idStr){
      try{
        const q = JSON.parse(localStorage.getItem(PENDING_DELETES) || '[]');
        if (!q.includes(idStr)) q.push(idStr);
        localStorage.setItem(PENDING_DELETES, JSON.stringify(q));
      }catch{}
    }

    async function flushPendingDeletes(){
      const q = JSON.parse(localStorage.getItem(PENDING_DELETES) || '[]');
      if (!q.length) return;
      const remains = [];
      for (const idStr of q){
        try{
          const res = await fetch(GAS_URL, {method:'POST', mode:'cors', headers:{'Content-Type':'text/plain;charset=utf-8'}, body:JSON.stringify({action:'delete', id:idStr, id_numeric:(idStr.match(/\d+/)?.[0] ?? null)})});
          let ok=false;
          try{
            const j = await res.json();
            ok = res.ok && j.status==='success';
            if (!ok && j.message && j.message.includes("ì‚­ì œí•  IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")) ok = true;
          }catch{ /* text/empty */ }
          if (!ok) remains.push(idStr);
        }catch{ remains.push(idStr); }
      }
      localStorage.setItem(PENDING_DELETES, JSON.stringify(remains));
    }

    /*** ====== ë Œë”/ì°¨íŠ¸ ====== ***/
    function renderChart(canvas, type, data, options){
      let el = null;
      if (typeof canvas==='string') el = document.getElementById(canvas) || document.querySelector(canvas);
      else if (canvas instanceof HTMLCanvasElement) el = canvas;
      if (!el) return;
      const key = el.id || (el.dataset.chartId = el.dataset.chartId || `chart-${Math.random()}`);
      if (chartInstances[key]) chartInstances[key].destroy();
      const ctx = el.getContext('2d');
      chartInstances[key] = new Chart(ctx, {type, data, options});
    }

    /*** ====== í˜ì´ì§€ ì „í™˜ (ì „ì—­ ê³µê°œ) ====== ***/
    function _showPage(pageId){
      pages.forEach(p=>{
        const el = document.getElementById(p);
        if (!el) return;
        el.classList.add('hidden');
        el.classList.remove('fade-in');
      });
      const target = document.getElementById(pageId);
      if (target){
        target.classList.remove('hidden');
        target.classList.add('fade-in');
      }
      window.scrollTo(0,0);
      if (pageId==='friendsPage'){
        syncDataFromGAS(true).then(()=> renderFloatingEmotions());
      }
      if (pageId==='teacherDashboard') renderTeacherDashboard();
      if (['studentLogin','studentPage','noteToTeacherPage'].includes(pageId)) populateForms();
    }
    window.showPage = _showPage;

    /*** ====== í¼/ì´ëª¨ì§€ ====== ***/
    function populateForms(){
      const numSelect = document.getElementById('studentNumber');
      const loginNumSelect = document.getElementById('studentLoginNumber');
      const noteNumSelect = document.getElementById('noteStudentNumber');

      const options = ['<option value="">ë²ˆí˜¸ ì„ íƒ</option>'].concat(STUDENT_NUMBERS.map(n=>`<option value="${n}">${n}ë²ˆ</option>`)).join('');
      if (numSelect) numSelect.innerHTML = options;
      if (loginNumSelect) loginNumSelect.innerHTML = options;
      if (noteNumSelect) noteNumSelect.innerHTML = options;

      Object.entries(EMOTIONS).forEach(([category, emotions])=>{
        const container = document.getElementById(`${category}Emotions`);
        if (!container) return;
        container.innerHTML = '';
        const bg = category==='positive' ? 'bg-green-50 hover:bg-green-100' : category==='negative' ? 'bg-red-50 hover:bg-red-100' : 'bg-gray-50 hover:bg-gray-100';
        for (const [emotion, emoji] of Object.entries(emotions)){
          container.innerHTML += `<div class="emotion-card ${bg} p-3 rounded-lg cursor-pointer text-center text-xs" onclick="selectEmotion('${emotion}','${emoji}','${category}',this)"><div class="text-2xl mb-1">${emoji}</div><div class="font-medium">${emotion}</div></div>`;
        }
      });
    }

    function _selectEmotion(emotion, emoji, category, element){
      document.querySelectorAll('.emotion-card').forEach(el=>el.classList.remove('ring-2','ring-blue-500'));
      if (element) element.classList.add('ring-2','ring-blue-500');
      document.getElementById('selectedEmotion').value = emotion;
      document.getElementById('selectedEmoji').value = emoji;
      document.getElementById('selectedCategory').value = category;
    }
    window.selectEmotion = _selectEmotion;
    window.showCustomEmotionInput = ()=> document.getElementById('customEmotionContainer').classList.remove('hidden');
    window.hideCustomEmotionInput = ()=> document.getElementById('customEmotionContainer').classList.add('hidden');

    async function _setCustomCategory(category){
      const text = pendingCustomEmotion.text;
      let finalEmoji = pendingCustomEmotion.emoji;
      if (!finalEmoji){
        const emojiPrompt = `ë‹¤ìŒ í•œêµ­ì–´ ê°ì •ì— ê°€ì¥ ì–´ìš¸ë¦¬ëŠ” ëŒ€í‘œ ì–¼êµ´ ì´ëª¨ì§€ í•˜ë‚˜ë§Œ ì‘ë‹µ: "${text}"`;
        const r = await callGeminiAPI(emojiPrompt);
        if (r && /\p{Emoji}/u.test(r)) finalEmoji = r.slice(0,2);
        else finalEmoji = DEFAULT_EMOJIS[category];
      }
      _selectEmotion(text, finalEmoji, category, null);
      showToast(`'${text} ${finalEmoji}' ê°ì •ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.`);
      document.getElementById('categoryModal').classList.add('hidden');
      pendingCustomEmotion = {};
    }
    window.setCustomCategory = _setCustomCategory;

    async function handleCustomEmotion(){
      const inputEl = document.getElementById('customEmotionInput');
      const text = inputEl.value.trim();
      if (!text) return showToast('ê°ì •ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      const confirmBtn = inputEl.nextElementSibling;
      confirmBtn.disabled = true; confirmBtn.textContent = '...';

      pendingCustomEmotion = { text, emoji:null };
      const prompt = `ë‹¤ìŒ í•œêµ­ì–´ ê°ì •ì„ ë¶„ì„í•´ ì´ëª¨ì§€/ë¶„ë¥˜ë¥¼ JSONìœ¼ë¡œ. {"emoji":"...","category":"positive|negative|neutral"}\nê°ì •:"${text}"`;
      const resp = await callGeminiAPI(prompt);
      confirmBtn.disabled=false; confirmBtn.textContent='í™•ì¸';

      if (resp){
        try{
          const cleaned = resp.replace(/```json\n?/,'').replace(/```$/,'');
          const j = JSON.parse(cleaned);
          if (j.emoji && j.category && /\p{Emoji}/u.test(j.emoji)){
            pendingCustomEmotion.emoji = j.emoji.slice(0,2);
            return _setCustomCategory(j.category);
          }
        }catch(e){ console.error(e, resp); }
      }
      document.getElementById('fallbackEmotionText').textContent = `"${text}"`;
      document.getElementById('categoryModal').classList.remove('hidden');
    }
    window.handleCustomEmotion = handleCustomEmotion;

    /*** ====== ì œì¶œ: ê°ì •ì¼ê¸° ====== ***/
    const emotionForm = document.getElementById('emotionForm');
    emotionForm?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const today = getTodayDateString();
      const studentNumber = document.getElementById('studentNumber').value;
      if (!studentNumber) return showToast('ë²ˆí˜¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
      if (!document.getElementById('selectedEmotion').value) return showToast('ê°ì •ì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
      if (!document.getElementById('emotionReason').value.trim()) return showToast('ê°ì •ì˜ ì´ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');

      if (getAllData().find(d=> d.date===today && d.studentNumber===studentNumber)){
        return showToast('ì´ë¯¸ ì˜¤ëŠ˜ ê°ì •ì¼ê¸°ë¥¼ ì‘ì„±í–ˆì–´ìš”!');
      }

      const newEntryForGAS = {
        id: Date.now(),
        timestamp: new Date().toISOString(),
        name: studentNumber,
        emotion: document.getElementById('selectedEmotion').value,
        tag: document.getElementById('selectedCategory').value || 'neutral',
        content: document.getElementById('emotionReason').value,
        emoji: document.getElementById('selectedEmoji').value
      };

      const newEntryInternal = {
        id: newEntryForGAS.id,
        date: today,
        studentNumber,
        emotion: newEntryForGAS.emotion,
        emoji: newEntryForGAS.emoji,
        reason: newEntryForGAS.content,
        category: newEntryForGAS.tag,
        synced:false
      };

      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled=true; submitBtn.textContent='ì €ì¥ ì¤‘...';
      let serverSuccess=false;

      try{
        const res = await fetch(GAS_URL, {
          method:'POST', mode:'cors', headers:{'Content-Type':'text/plain;charset=utf-8'},
          body: JSON.stringify({ action:'create', data:newEntryForGAS })
        });
        const txt = await res.text();
        let result={};
        try{ if (!txt) throw new Error('EMPTY'); result = JSON.parse(txt); }catch{ result={status:'error'}; }

        if (res.ok && result.status==='success'){
          const serverId = String(result.id ?? newEntryForGAS.id);
          const entryWithServerId = { ...newEntryInternal, id:serverId, synced:true };
          allDataCache.push(entryWithServerId);
          serverSuccess = true;
          const msgs = ["ì˜¤ëŠ˜ë„ í˜ë‚´ì„¸ìš”! ë©‹ì§„ í•˜ë£¨ê°€ ë  ê±°ì˜ˆìš”. í™”ì´íŒ…!","ì•„ì¹¨ë¶€í„° ê¸°ë¡í•˜ëŠ” ë‹¹ì‹ , ì •ë§ ë©‹ì ¸ìš”!","ì¢‹ì€ ì‹œì‘ì´ì—ìš”! ì˜¤ëŠ˜ í•˜ë£¨ë„ ê¸ì • ì—ë„ˆì§€ ê°€ë“í•˜ê¸¸!","ê°ì‚¬í•©ë‹ˆë‹¤! ë‹¹ì‹ ì˜ í•˜ë£¨ë¥¼ ì‘ì›í• ê²Œìš”!","ê¸°ë¡ ì™„ë£Œ! ì˜¤ëŠ˜ë„ ë°˜ì§ì´ê¸¸!"];
          showToast(msgs[Math.floor(Math.random()*msgs.length)]);
        }else{
          allDataCache.push(newEntryInternal);
          showToast(`ì €ì¥ ì‹¤íŒ¨: ì„œë²„ ì˜¤ë¥˜. ë‚˜ì¤‘ì— ìë™ ë™ê¸°í™”ë©ë‹ˆë‹¤.`);
        }
      }catch(err){
        console.error(err);
        allDataCache.push(newEntryInternal);
        showToast("ì„œë²„ í†µì‹  ì˜¤ë¥˜! ê¸°ë¡ì„ ë¡œì»¬ì— ì„ì‹œ ì €ì¥í–ˆìŠµë‹ˆë‹¤.");
      }finally{
        submitBtn.disabled=false; submitBtn.textContent='ğŸ’¾ ê°ì •ì¼ê¸° ì €ì¥í•˜ê¸°';
        saveDataLocally(allDataCache);
        e.target.reset();
        document.querySelectorAll('.emotion-card').forEach(el=>el.classList.remove('ring-2','ring-blue-500'));
        if (serverSuccess) _showPage('mainPage');
      }
    });

    /*** ====== ìª½ì§€ ì „ì†¡ ====== ***/
    const noteForm = document.getElementById('noteForm');
    noteForm?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const studentNumber = document.getElementById('noteStudentNumber').value;
      const noteContent = document.getElementById('noteContent').value;
      if (!studentNumber || !noteContent.trim()) return showToast('ë²ˆí˜¸ì™€ ìª½ì§€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      const noteEntry = { timestamp:new Date().toISOString(), name:studentNumber, content:noteContent.trim() };
      const btn = e.target.querySelector('button[type="submit"]'); btn.disabled=true; btn.textContent='ì „ì†¡ ì¤‘...';
      try{
        const res = await fetch(GAS_URL, {method:'POST', mode:'cors', headers:{'Content-Type':'text/plain;charset=utf-8'}, body:JSON.stringify({action:'sendNote', data:noteEntry})});
        const txt = await res.text();
        let result={}; try{ if (!txt) throw 0; result=JSON.parse(txt);}catch{ result={status:'error'};}
        if (res.ok && result.status==='success'){
          showToast("ìª½ì§€ê°€ ì„ ìƒë‹˜ê»˜ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤!"); e.target.reset(); _showPage('mainPage');
        }else showToast("ìª½ì§€ ì „ì†¡ ì‹¤íŒ¨: GAS ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
      }catch(e){ console.error(e); showToast("ì„œë²„ í†µì‹  ì˜¤ë¥˜ë¡œ ìª½ì§€ ì „ì†¡ ì‹¤íŒ¨"); }
      finally{ btn.disabled=false; btn.textContent='ğŸ’Œ ìª½ì§€ ì „ì†¡í•˜ê¸°'; }
    });

    /*** ====== êµì‚¬/í•™ìƒ ë¡œê·¸ì¸ ====== ***/
    function _handleTeacherLogin(ev){
      ev?.preventDefault();
      const pw = document.getElementById('teacherPassword');
      if (pw.value === TEACHER_PASSWORD){ document.getElementById('loginError').classList.add('hidden'); pw.value=''; _showPage('teacherDashboard'); }
      else { document.getElementById('loginError').classList.remove('hidden'); }
      return false;
    }
    window.handleTeacherLogin = _handleTeacherLogin;

    function _logoutTeacher(){ _showPage('mainPage'); }
    window.logoutTeacher = _logoutTeacher;

    async function _clearLocalCache(){
      localStorage.removeItem(DB_NAME);
      localStorage.removeItem(PENDING_DELETES);
      allDataCache=[]; dataLoaded=false;
      showToast("ë¸Œë¼ìš°ì € ìºì‹œ ì‚­ì œ í›„ ì„œë²„ì—ì„œ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤...");
      await syncDataFromGAS(true);
      if (document.getElementById('teacherDashboard').classList.contains('hidden')) _showPage('mainPage');
      else renderTeacherDashboard();
    }
    window.clearLocalCache = _clearLocalCache;

    /*** ====== ì¹œêµ¬ë“¤ ê°ì • ====== ***/
    function renderFloatingEmotions(){
      const container = document.getElementById('floatingEmotions');
      container.innerHTML = `<div class="text-center py-10"><div class="loader mx-auto"></div><p class="text-gray-600 mt-4">ì¹œêµ¬ë“¤ì˜ ê°ì • ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>`;
      const todays = getAllData().filter(d=> d.date===getTodayDateString());
      if (!todays.length){ container.innerHTML = `<div class="text-center text-gray-500 py-20">ì•„ì§ ì¼ê¸°ë¥¼ ì“´ ì¹œêµ¬ê°€ ì—†ì–´ìš”.</div>`; return; }
      container.innerHTML='';
      const positions=[]; const size=48; const W=container.offsetWidth; const H=container.offsetHeight;

      todays.forEach(entry=>{
        const el = document.createElement('div');
        el.className='floating-emotion'; el.textContent = entry.emoji;
        let left, top, overlaps, attempts=0;
        do{
          overlaps=false;
          left = Math.random()*(W-size); top = Math.random()*(H-size);
          for (const pos of positions){
            if (left < pos.right && left+size > pos.left && top < pos.bottom && top+size > pos.top){ overlaps=true; break; }
          }
          attempts++;
        }while(overlaps && attempts<100);
        positions.push({left, top, right:left+size, bottom:top+size});
        el.style.left=`${left}px`; el.style.top=`${top}px`; el.style.animationDelay=`${Math.random()*5}s`;

        const showDetail = (e)=>{
          const r = e.target.getBoundingClientRect();
          tooltip.innerHTML = `<strong>${entry.studentNumber}ë²ˆ (${entry.emotion})</strong><br><span class="text-sm">${entry.reason}</span>`;
          tooltip.classList.add('show');
          let tw = tooltip.offsetWidth, th=tooltip.offsetHeight;
          let L = r.left + r.width/2 - tw/2;
          let T = r.top - th - 10;
          if (L<10) L=10; if (L+tw>window.innerWidth-10) L=window.innerWidth-tw-10;
          if (T<10) T=10;
          tooltip.style.left=`${L}px`; tooltip.style.top=`${T}px`;
        };
        const hideDetail = ()=> tooltip.classList.remove('show');
        el.onmouseenter = showDetail; el.onmouseleave = hideDetail;

        let touchTimer=null;
        el.addEventListener('touchstart',(e)=>{
          e.preventDefault(); showDetail({target:el});
          touchTimer=setTimeout(hideDetail,3000);
        });
        el.addEventListener('touchend',()=>{ clearTimeout(touchTimer); hideDetail(); });
        el.addEventListener('touchcancel',()=>{ clearTimeout(touchTimer); hideDetail(); });

        container.appendChild(el);
      });
    }

    /*** ====== êµì‚¬ ëŒ€ì‹œë³´ë“œ ====== ***/
    function switchDashboardTab(tab){
      document.getElementById('dailyTab').classList.toggle('active', tab==='daily');
      document.getElementById('monthlyTab').classList.toggle('active', tab==='monthly');
      document.getElementById('notesTab').classList.toggle('active', tab==='notes');

      document.getElementById('dailyReportContent').classList.toggle('hidden', tab!=='daily');
      document.getElementById('monthlyReportContent').classList.toggle('hidden', tab!=='monthly');
      document.getElementById('notesContent').classList.toggle('hidden', tab!=='notes');

      document.getElementById('dashboardDate').classList.toggle('hidden', tab!=='daily');
      document.getElementById('dashboardMonth').classList.toggle('hidden', tab!=='monthly');

      if (tab==='daily'){ renderDailyReport(); renderStudentListForDashboard(); }
      if (tab==='monthly') renderMonthlyReport();
      if (tab==='notes') renderTeacherNotes();
    }
    window.switchDashboardTab = switchDashboardTab;

    function handleListClick(e){
      if (e.target.classList.contains('delete-btn')){
        const rawId = e.target.dataset.id;
        deleteEntry(rawId);
      }
    }

    function renderDailyReport(){
      const selectedDate = document.getElementById('dashboardDate').value;
      document.getElementById('dailyDistributionTitle').textContent = `${selectedDate} ê°ì • ë¶„í¬`;
      document.getElementById('dailyEntriesTitle').textContent = `${selectedDate}ì˜ ê¸°ë¡`;

      const daily = getAllData().filter(d=> d.date===selectedDate);
      const counts = {positive:0, negative:0, neutral:0};
      daily.forEach(entry=> counts[getEmotionType(entry.emotion, entry)]++);
      document.getElementById('todaySubmissionCount').textContent = `${daily.length} / ${STUDENT_NUMBERS.length}`;
      document.getElementById('todayPositiveCount').textContent = counts.positive;
      document.getElementById('todayNegativeCount').textContent = counts.negative;

      renderChart('dailyDistributionChart','pie',{labels:['ê¸ì •','ë¶€ì •','ì¤‘ë¦½'], datasets:[{data:Object.values(counts), backgroundColor:['#4CAF50','#F44336','#FFC107']}]},{responsive:true, maintainAspectRatio:false});

      const list = document.getElementById('dailyEntriesList');
      list.innerHTML = daily.length ? '' : '<p class="text-gray-500">ì„ íƒí•œ ë‚ ì§œì— ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
      daily.forEach(entry=>{
        list.innerHTML += `
          <div class="border-b pb-3 flex items-center">
            <div class="flex-grow">
              <p class="font-bold">${entry.emoji} ${entry.studentNumber}ë²ˆ - <span class="font-medium">${entry.emotion}</span></p>
              <p class="text-sm text-gray-600 pl-7">${entry.reason}</p>
            </div>
            <button data-id="${String(entry.id)}" class="delete-btn bg-red-100 text-red-600 hover:bg-red-200 text-xs font-bold py-1 px-2 rounded-md">ì‚­ì œ</button>
          </div>`;
      });
      list.removeEventListener('click', handleListClick);
      list.addEventListener('click', handleListClick);

      renderStudentListForDashboard();
    }

    function renderMonthlyReport(){
      const monthString = document.getElementById('dashboardMonth').value;
      const [year, month] = monthString.split('-').map(Number);
      const monthData = getAllData().filter(d=> d.date.startsWith(monthString));
      const daysInMonth = new Date(year, month, 0).getDate();

      const counts = {positive:0, negative:0, neutral:0};
      monthData.forEach(e=> counts[getEmotionType(e.emotion, e)]++);
      document.getElementById('monthlyPositiveCount').textContent = counts.positive;
      document.getElementById('monthlyNeutralCount').textContent = counts.neutral;
      document.getElementById('monthlyNegativeCount').textContent = counts.negative;

      renderChart('monthlyDistributionChart','doughnut',{labels:['ê¸ì •','ë¶€ì •','ì¤‘ë¦½'], datasets:[{data:Object.values(counts), backgroundColor:['#4CAF50','#F44336','#FFC107']}]},{responsive:true, maintainAspectRatio:false});

      const dailyTrends = Array(daysInMonth).fill(null);
      // (ê°„ë‹¨í™”) ëˆ„ì  ë¹„ìœ¨ìš© ë”ë¯¸ ìŠ¤íƒ ì°¨íŠ¸ ëŒ€ì‹  ì¼ìë³„ null ì²˜ë¦¬
      renderChart('monthlyTrendChart','bar',{
        labels: Array.from({length:daysInMonth},(_,i)=>i+1),
        datasets:[
          {label:'ê¸ì •', data: dailyTrends.map(()=>null), backgroundColor:'#4CAF50'},
          {label:'ì¤‘ë¦½', data: dailyTrends.map(()=>null), backgroundColor:'#FFC107'},
          {label:'ë¶€ì •', data: dailyTrends.map(()=>null), backgroundColor:'#F44336'}
        ]
      }, {responsive:true, maintainAspectRatio:false, scales:{x:{stacked:true, title:{display:true, text:`${month}ì›”`}}, y:{stacked:true, max:100, ticks:{callback:v=>v+'%'}}}});
    }

    function renderStudentListForDashboard(){
      const container = document.getElementById('studentReportLinks');
      if (!container) return;
      container.innerHTML = '';
      const selectedDate = document.getElementById('dashboardDate').value;
      const submitted = getAllData().filter(d=> d.date===selectedDate).map(d=> d.studentNumber);
      STUDENT_NUMBERS.slice().sort((a,b)=>parseInt(a)-parseInt(b)).forEach(num=>{
        const done = submitted.includes(num);
        const cls = done ? 'bg-blue-200 hover:bg-blue-300 text-blue-800' : 'bg-gray-100 hover:bg-gray-200 text-gray-700';
        container.innerHTML += `<button onclick="renderStudentReport('${num}', true)" class="${cls} font-medium py-2 px-3 rounded-lg transition">${num}ë²ˆ</button>`;
      });
    }

    async function refreshDashboardData(){
      const ok = await syncDataFromGAS(true);
      if (ok){ renderTeacherDashboard(); showToast("ëŒ€ì‹œë³´ë“œê°€ ìµœì‹  ê¸°ë¡ìœ¼ë¡œ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤."); }
    }
    window.refreshDashboardData = refreshDashboardData;

    async function renderTeacherNotes(){
      const list = document.getElementById('notesList');
      const err = document.getElementById('notesLoadingError');
      list.innerHTML = '<div class="text-center py-10"><div class="loader mx-auto"></div><p class="text-gray-600 mt-4">ìª½ì§€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>';
      err.classList.add('hidden');
      try{
        const res = await fetch(GAS_URL + '?action=readNotes', {mode:'cors'});
        const result = await res.json();
        if (res.ok && Array.isArray(result)){
          list.innerHTML='';
          if (!result.length){ list.innerHTML='<p class="text-gray-500 text-center py-10">ë„ì°©í•œ ìª½ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
          result.slice().reverse().forEach(note=>{
            const timestamp = new Date(note.timestamp).toLocaleString('ko-KR',{year:'2-digit', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'});
            list.innerHTML += `
              <div class="bg-gray-50 p-4 rounded-xl shadow-md border border-gray-200">
                <div class="flex justify-between items-start mb-2 border-b pb-2">
                  <span class="font-bold text-lg text-gray-800">ğŸ’Œ ${note.name}ë²ˆ í•™ìƒ</span>
                  <span class="text-xs text-gray-500">${timestamp}</span>
                </div>
                <p class="text-gray-700 whitespace-pre-wrap">${note.content}</p>
              </div>`;
          });
        }else{
          list.innerHTML=''; err.classList.remove('hidden');
        }
      }catch(e){
        console.error(e);
        list.innerHTML=''; err.classList.remove('hidden'); err.textContent="ì„œë²„ í†µì‹  ì˜¤ë¥˜: ìª½ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
      }
    }

    /*** ====== ì‚­ì œ(ë˜ëŒë¦¬ê¸°) ====== ***/
    async function deleteEntry(id){
      const idStr = String(id);
      if (!idStr) return showToast("ì‚­ì œ ì˜¤ë¥˜: IDê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");
      const entryIndex = allDataCache.findIndex(e=> String(e.id)===idStr);
      if (entryIndex===-1) return showToast('ì‚­ì œ ì˜¤ë¥˜: ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

      lastDeletedEntry = allDataCache.splice(entryIndex,1)[0];
      saveDataLocally(allDataCache);
      refreshAfterDelete();

      showToast('ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.','ë˜ëŒë¦¬ê¸°', ()=> undoDelete(), ()=> confirmDelete());
    }
    window.deleteEntry = deleteEntry;

    function undoDelete(){
      if (!lastDeletedEntry) return;
      allDataCache.push(lastDeletedEntry);
      allDataCache.sort((a,b)=> a.date.localeCompare(b.date));
      saveDataLocally(allDataCache);
      refreshAfterDelete();
      showToast('ì‚­ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
      lastDeletedEntry=null; clearTimeout(undoTimeout);
    }

    async function confirmDelete(){
      if (!lastDeletedEntry) return;
      const entry = lastDeletedEntry; lastDeletedEntry=null;
      if (entry.synced!==true) return; // ë¡œì»¬ ì „ìš©ì€ ì´ë¯¸ ë
      try{
        const res = await fetch(GAS_URL, {method:'POST', mode:'cors', headers:{'Content-Type':'text/plain;charset=utf-8'}, body:JSON.stringify({action:'delete', id:entry.id, id_numeric:(String(entry.id).match(/\d+/)?.[0] ?? null)})});
        let ok=false; try{ const j=await res.json(); ok = res.ok && j.status==='success'; }catch{}
        if (!ok) enqueuePendingDelete(String(entry.id));
      }catch{ enqueuePendingDelete(String(entry.id)); }
    }

    function refreshAfterDelete(){
      if (!document.getElementById('teacherDashboard').classList.contains('hidden') && document.getElementById('dailyTab').classList.contains('active')){
        renderDailyReport(); renderStudentListForDashboard();
      }else if (!document.getElementById('studentReportPage').classList.contains('hidden') && currentStudentForReport){
        renderStudentReport(currentStudentForReport);
      }
    }

    /*** ====== í•™ìƒ ë¦¬í¬íŠ¸ ====== ***/
    async function renderStudentReportContent(containerSelector, studentNumber, monthString){
      const container = document.querySelector(containerSelector);
      const studentAll = getAllData().filter(d=> d.studentNumber===studentNumber);
      const studentMonth = studentAll.filter(d=> d.date.startsWith(monthString));

      const [year, month] = monthString.split('-').map(Number);
      const monthTitle = `${year}ë…„ ${month}ì›”`;
      container.querySelector('#candyJarTitle').textContent = `ğŸ¬ ê°ì • ì‚¬íƒ• ë³‘ (${monthTitle})`;
      container.querySelector('#monthlyRecordsTitle').textContent = `${monthTitle}ì˜ ì „ì²´ ê¸°ë¡`;

      const totalMonth = studentMonth.length;
      const counts = {positive:0, negative:0, neutral:0};
      studentMonth.forEach(e=> counts[getEmotionType(e.emotion, e)]++);
      container.querySelector('#myTotalRecords').textContent = totalMonth;
      container.querySelector('#myPositiveCount').textContent = counts.positive;
      container.querySelector('#myNeutralCount').textContent = counts.neutral;
      container.querySelector('#myNegativeCount').textContent = counts.negative;

      renderChart(container.querySelector('#myEmotionChart'), 'doughnut', {labels:['ê¸ì •','ë¶€ì •','ì¤‘ë¦½'], datasets:[{data:Object.values(counts), backgroundColor:['#4CAF50','#F44336','#FFC107']}]}, {responsive:true, maintainAspectRatio:false});

      const daysInMonth = new Date(year, month, 0).getDate();
      const dailyTrends = Array(daysInMonth).fill(null).map((_,i)=>{
        const dayStr = `${monthString}-${String(i+1).padStart(2,'0')}`;
        const dayData = studentMonth.find(d=> d.date===dayStr);
        if (!dayData) return null;
        const c = getEmotionType(dayData.emotion, dayData);
        if (c==='positive') return 1; if (c==='negative') return -1; return 0;
      });
      renderChart(container.querySelector('#myTrendChart'),'line',{labels:Array.from({length:daysInMonth},(_,i)=>i+1), datasets:[{label:'ê°ì • ë³€í™”', data:dailyTrends, borderColor:'#667eea', backgroundColor:'#667eea20', fill:true, tension:0.1, spanGaps:true}]},{responsive:true, maintainAspectRatio:false, scales:{x:{title:{display:true, text:`${month}ì›”`}}, y:{ticks:{callback:v=> v===1?'ê¸ì •':(v===-1?'ë¶€ì •':(v===0?'ì¤‘ë¦½':null))}, min:-1.5, max:1.5}}});

      const topBox = container.querySelector('#myTopEmotions');
      topBox.innerHTML='';
      const emotionCounts = studentMonth.reduce((acc,c)=> (acc[c.emotion]=(acc[c.emotion]||0)+1, acc), {});
      const sorted = Object.entries(emotionCounts).sort((a,b)=> b[1]-a[1]).slice(0,5);
      if (sorted.length){
        sorted.forEach(([emotion,count],i)=>{
          const emoji = studentAll.find(d=> d.emotion===emotion)?.emoji || DEFAULT_EMOJIS[getEmotionType(emotion)];
          topBox.innerHTML += `<div class="flex items-center justify-between text-gray-700 border-b pb-2"><span>${i+1}. ${emoji} ${emotion}</span><span class="font-bold">${count}íšŒ</span></div>`;
        });
      }else topBox.innerHTML='<p class="text-gray-500">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';

      const candyContainer = container.querySelector('#candyContainer');
      candyContainer.innerHTML='';
      if (studentMonth.length){
        const jarW = 400*1.09, jarH = 500*1.09;
        const candySize = 126;
        const offsetX = (candyContainer.offsetWidth - jarW)/2;
        const offsetY = (candyContainer.offsetHeight - jarH)/2;
        const stackW = candySize*0.7;
        const maxPerRow = Math.floor((jarW*0.8)/stackW);
        const stackH = candySize*0.3;

        studentMonth.forEach((entry, idx)=>{
          const candy = document.createElement('div');
          candy.className = 'w-28 h-28 rounded-full flex items-center justify-center text-7xl absolute falling-candy';
          candy.textContent = entry.emoji;
          candy.title = `${entry.date}: ${entry.emotion}`;
          const row = Math.floor(idx / maxPerRow);
          const col = idx % maxPerRow;
          let bottom = offsetY + (row*stackH) + (Math.random()*5-2.5);
          let left = offsetX + (jarW*0.1) + (col*stackW) + (row%2===1 ? stackW/2 : 0) + (Math.random()*10-5);
          if (left + candySize > offsetX + jarW*0.9) left -= stackW/2;
          candy.style.left = `${left}px`; candy.style.bottom=`${bottom}px`;
          candy.style.animationDelay = `${idx*0.15}s`;
          candy.style.setProperty('--final-rotate', `${Math.random()*360}deg`);
          candy.onmouseenter = (e)=>{
            const r = e.target.getBoundingClientRect();
            tooltip.innerHTML = `<strong>${entry.date}</strong><br><span>${entry.emotion} ${entry.emoji}</span><br><span class="text-sm">${entry.reason}</span>`;
            tooltip.classList.add('show');
            tooltip.style.left = `${r.left + r.width/2 - tooltip.offsetWidth/2}px`;
            tooltip.style.top = `${r.top - tooltip.offsetHeight - 5}px`;
          };
          candy.onmouseleave = ()=> tooltip.classList.remove('show');
          candyContainer.appendChild(candy);
        });
      }else{
        candyContainer.innerHTML = '<p class="text-gray-500">ì„ íƒí•œ ë‹¬ì— ê¸°ë¡ëœ ê°ì • ì‚¬íƒ•ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
      }

      const records = container.querySelector('#myRecentRecords');
      records.innerHTML='';
      if (studentMonth.length){
        studentMonth.slice().sort((a,b)=> b.date.localeCompare(a.date)).forEach(entry=>{
          records.innerHTML += `
            <div class="bg-gray-50 p-4 rounded-xl shadow-sm border-l-4 ${entry.category==='positive'?'border-green-500': entry.category==='negative'?'border-red-500':'border-gray-500'}">
              <p class="font-semibold text-gray-800">${entry.date} Â· ${entry.emotion} ${entry.emoji}</p>
              <p class="text-sm text-gray-600 mt-1 whitespace-pre-wrap">${entry.reason}</p>
            </div>`;
        });
      }else records.innerHTML='<p class="text-gray-500">ì„ íƒí•œ ë‹¬ì˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    }

    function renderStudentReport(studentNumber, isTeacherView=true){
      currentStudentForReport = studentNumber;
      _showPage('studentReportPage');
      document.getElementById('studentReportNumber').textContent = `${studentNumber}ë²ˆ í•™ìƒì˜ ë¦¬í¬íŠ¸`;
      const monthPicker = document.getElementById('studentReportMonth');
      if (!monthPicker.dataset.listenerAttached){
        monthPicker.addEventListener('change', ()=> renderStudentReport(studentNumber, isTeacherView));
        monthPicker.dataset.listenerAttached='true';
      }
      const today = new Date();
      const defMonth = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
      monthPicker.value = monthPicker.value || defMonth;

      document.getElementById('dashboardButton').classList.toggle('hidden', !isTeacherView);
      document.getElementById('mainPageButton').classList.toggle('hidden', isTeacherView);

      renderStudentReportContent('#studentReportPage', studentNumber, monthPicker.value);

      const adviceBox = document.querySelector('#studentReportPage > .max-w-4xl > .bg-white.rounded-2xl.shadow-lg.p-6.mb-6:last-child');
      if (adviceBox){
        if (isTeacherView) adviceBox.classList.add('hidden');
        else{
          adviceBox.classList.remove('hidden');
          const btn = document.getElementById('generateAdviceBtn');
          const aiAdviceEl = document.getElementById('aiAdvice');
          if (aiAdviceEl) aiAdviceEl.innerHTML = '<p class="text-sm text-gray-500">ë²„íŠ¼ì„ ëˆŒëŸ¬ ì„ ìƒë‹˜ì˜ ê²©ë ¤ ë©”ì‹œì§€ë¥¼ ìƒì„±í•´ ë³´ì„¸ìš”.</p>';
          if (btn){ btn.disabled=false; btn.textContent='ì¡°ì–¸ ìƒì„±í•˜ê¸°'; }
        }
      }
    }
    window.renderStudentReport = renderStudentReport;

    async function fetchAIAdvice(){
      const studentNumber = currentStudentForReport;
      if (!studentNumber) return showToast('í•™ìƒ ë²ˆí˜¸ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      if (!API_KEY) return showToast('Gemini API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.');

      const btn = document.getElementById('generateAdviceBtn');
      const aiAdviceEl = document.getElementById('aiAdvice');
      btn.disabled=true; btn.textContent='ì¡°ì–¸ ë¶„ì„ ì¤‘...';
      aiAdviceEl.innerHTML = '<div class="loader mx-auto"></div><p class="text-center text-purple-700 mt-2">í•™ìƒì˜ ê°ì • ê¸°ë¡ì„ ë¶„ì„í•˜ëŠ” ì¤‘...</p>';

      const studentData = getAllData().filter(d=> d.studentNumber===studentNumber);
      if (!studentData.length){
        aiAdviceEl.innerHTML = '<p class="text-red-600 font-semibold">ì•„ì§ ì´ í•™ìƒì˜ ê¸°ë¡ì´ ì—†ì–´ ì¡°ì–¸ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
        btn.disabled=false; btn.textContent='ì¡°ì–¸ ìƒì„±í•˜ê¸°'; return;
      }
      const recent = studentData.slice(-5).map(e=>`[${e.date} ${e.emotion}] ${e.reason}`).join('\n');
      const totals = studentData.reduce((acc,c)=> (acc[getEmotionType(c.emotion,c)]++, acc), {positive:0,negative:0,neutral:0});
      const prompt = `ë‹¹ì‹ ì€ ì´ˆë“± ë‹´ì„ì…ë‹ˆë‹¤. ì•„ë˜ëŠ” ${studentNumber}ë²ˆ í•™ìƒì˜ ê°ì • í†µê³„ì™€ ìµœê·¼ 5ê°œ ê¸°ë¡ì…ë‹ˆë‹¤. í•™ìƒì—ê²Œ í˜ì´ ë˜ëŠ” ì§§ì€ í•œêµ­ì–´ ì¡°ì–¸(ìµœëŒ€ 3ë¬¸ì¥)ë§Œ ì‘ì„±í•˜ì„¸ìš”.
<í†µê³„> ì „ì²´:${studentData.length} ê¸ì •:${totals.positive} ë¶€ì •:${totals.negative} ì¤‘ë¦½:${totals.neutral}
<ìµœê·¼>
${recent}
ì¡°ì–¸:`;
      const advice = await callGeminiAPI(prompt);
      aiAdviceEl.innerHTML = advice ? `<p class="whitespace-pre-wrap">${advice}</p>` : '<p class="text-red-600 font-semibold">AI ì¡°ì–¸ ìƒì„± ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</p>';
      btn.disabled=false; btn.textContent='ì¡°ì–¸ ë‹¤ì‹œ ìƒì„±í•˜ê¸°';
    }
    window.fetchAIAdvice = fetchAIAdvice;

    /*** ====== ëŒ€ì‹œë³´ë“œ í”„ë ˆì„ ====== ***/
    function renderTeacherDashboard(){
      const datePicker = document.getElementById('dashboardDate');
      const monthPicker = document.getElementById('dashboardMonth');
      if (!datePicker.value) datePicker.value = getTodayDateString();
      const t = new Date();
      if (!monthPicker.value) monthPicker.value = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}`;
      if (!datePicker.dataset.listenerAttached){ datePicker.addEventListener('change', ()=>{renderDailyReport(); renderStudentListForDashboard();}); datePicker.dataset.listenerAttached='true'; }
      if (!monthPicker.dataset.listenerAttached){ monthPicker.addEventListener('change', renderMonthlyReport); monthPicker.dataset.listenerAttached='true'; }
      const active = document.querySelector('.tab-button.active')?.id || 'dailyTab';
      switchDashboardTab(active==='monthlyTab'?'monthly' : active==='notesTab'?'notes':'daily');
      if (active!=='notesTab') renderStudentListForDashboard();
    }

    /*** ====== í•™ìƒ ë¡œê·¸ì¸ í¼ ====== ***/
    const studentLoginForm = document.getElementById('studentLoginForm');
    studentLoginForm?.addEventListener('submit', (e)=>{
      e.preventDefault();
      const num = document.getElementById('studentLoginNumber').value;
      const pw = document.getElementById('studentLoginPassword').value;
      const err = document.getElementById('studentLoginError');
      if (!num || !pw){ err.textContent='ë²ˆí˜¸ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.'; err.classList.remove('hidden'); return; }
      const SECRET = 572, MULT=17;
      const expected = ((Number(num)*MULT)+SECRET).toString().slice(-4).padStart(4,'0');
      if (pw===expected){ err.classList.add('hidden'); studentLoginForm.reset(); renderStudentReport(num,false); }
      else { err.textContent='ë²ˆí˜¸ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'; err.classList.remove('hidden'); }
    });

    /*** ====== ì´ˆê¸°í™” ====== ***/
    document.getElementById('currentDate').textContent = getTodayDateString();
    populateForms();
    syncDataFromGAS().then(()=>{ /* ì´ˆê¸° ë™ê¸°í™” ì™„ë£Œ */ });
    showPage('mainPage');
    const dashboardDate = document.getElementById('dashboardDate');
    if (dashboardDate) dashboardDate.value = getTodayDateString();
    const today = new Date();
    const dashboardMonth = document.getElementById('dashboardMonth');
    if (dashboardMonth) dashboardMonth.value = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
  });
  </script>
</body>
</html>
