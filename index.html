<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ìš°ë¦¬ë°˜ ê°ì •ì¼ê¸°</title>

  <!-- Tailwind & Chart.js -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* í°íŠ¸ */
    @import url('https://fonts.googleapis.com/css2?family=Gowun+Batang:wght@400;700&display=swap');
    body { font-family: 'Gowun Batang', serif; }

    .emotion-card:hover { transform: translateY(-2px); }
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px);} to { opacity: 1; transform: translateY(0);} }

    .floating-emotion {
      position: absolute; font-size: 2.5rem; cursor: pointer;
      transition: all 0.3s ease; animation: float 6s ease-in-out infinite; z-index: 10;
    }
    .floating-emotion:hover { transform: scale(1.3); z-index: 20; }
    @keyframes float {
      0%,100%{ transform: translateY(0) rotate(0deg);}
      25%{ transform: translateY(-10px) rotate(2deg);}
      50%{ transform: translateY(-5px) rotate(-1deg);}
      75%{ transform: translateY(-15px) rotate(1deg);}
    }

    /* íˆ´íŒ (ì‚ì¹¨ ì œê±° & í™”ë©´ ê³ ì •) */
    .tooltip{
      position: fixed; background: rgba(255,255,255,.95); color:#333;
      padding:12px 16px; border-radius:12px; border:1px solid #ddd; font-size:14px;
      white-space: normal; max-width: 300px; z-index:30; pointer-events:none;
      opacity:0; transform: translateY(10px); box-shadow: 0 4px 15px rgba(0,0,0,.1);
      transition: opacity .3s, transform .3s;
    }
    .tooltip.show{ opacity:1; transform: translateY(0); }
    .tooltip::after{ content:none; }

    .chart-container{ position:relative; height:300px; width:100%; }

    .tab-button{ transition: all .3s ease; }
    .tab-button.active{
      background:#fff; color:#4c51bf; border-color:#e0e7ff;
      box-shadow:0 2px 4px rgba(0,0,0,.05);
    }

    .loader{
      border:4px solid #f3f3f3; border-top:4px solid #667eea; border-radius:50%;
      width:30px; height:30px; animation: spin 1s linear infinite; margin:20px auto;
    }
    @keyframes spin{ 0%{transform: rotate(0)} 100%{transform: rotate(360deg)} }

    /* ì‚¬íƒ•(ì´ëª¨ì§€) ë‚™í•˜ ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes fallAndSettle{
      0%{ opacity:0; transform: translateY(-500px) rotate(-180deg); }
      60%{ opacity:1; transform: translateY(0) rotate(var(--final-rotate));}
      75%{ transform: translateY(-10px) rotate(var(--final-rotate));}
      95%{ transform: translateY(0) rotate(var(--final-rotate));}
      100%{ opacity:1; transform: translateY(0) rotate(var(--final-rotate));}
    }
    .falling-candy{ animation: fallAndSettle 6s ease-out forwards; }
  </style>

  <script>
    /* =========================
       ìƒìˆ˜ / ì „ì—­ ìƒíƒœ
       ========================= */
    // âœ… ì‘ë™ ì¤‘ì¸ GAS Web App URL ë¡œ êµì²´í•˜ì„¸ìš”
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwXACgqFbq9KL6VV0C5mrY2z9buQ1EIo8sXggck9RcdcLQkrad646ccx5WdaOJPoLsjIA/exec";

    let allDataCache = [];
    let dataLoaded = false;

    const DB_NAME = 'emotionDiaryDB_v2';
    const PENDING_DELETES = 'emotionDiary_pendingDeletes';
    const TEACHER_PASSWORD = 'teacher572';

    // (ì„ íƒ) Gemini API ì‚¬ìš© ì‹œ ì„¤ì •
    const API_KEY = ""; // í•„ìš” ì‹œ í‚¤ ì…ë ¥

    // í•™ìƒ ë²ˆí˜¸ ëª©ë¡
    const STUDENT_NUMBERS = ["2","3","4","5","6","7","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","30"];

    // ê°ì •/ì´ëª¨ì§€ ì‚¬ì „
    const EMOTIONS = {
      positive:{'ê¸°ì¨':'ğŸ˜Š','ì„¤ë ˜':'ğŸ¤—','ë§Œì¡±':'ğŸ™‚','í‰ì˜¨í•¨':'ğŸ˜‡','ê°ì‚¬':'ğŸ¥°','ìì‹ ê°':'ğŸ˜','í¬ë§':'ğŸ˜Œ','ì¦ê±°ì›€':'ğŸ˜„','ì‚¬ë‘':'ğŸ˜','ë¿Œë“¯í•¨':'ğŸ¤©'},
      negative:{'ìŠ¬í””':'ğŸ˜¢','ë¶„ë…¸':'ğŸ˜ ','ì¢Œì ˆ':'ğŸ˜','ë‘ë ¤ì›€':'ğŸ˜¨','ë¶ˆì•ˆ':'ğŸ˜°','ì™¸ë¡œì›€':'ğŸ˜”','ì‹¤ë§':'ğŸ˜•','í›„íšŒ':'ğŸ˜£','ì§ˆíˆ¬':'ğŸ˜’','ì§œì¦':'ğŸ˜¤'},
      neutral:{'í˜¼ë€':'ğŸ˜µ','ë†€ëŒ':'ğŸ˜²','ê¸´ì¥':'ğŸ˜¬','ë¬´ê¸°ë ¥':'ğŸ˜‘','ë‹µë‹µí•¨':'ğŸ˜–','ì–µìš¸í•¨':'ğŸ˜¤','ë¶€ë„ëŸ¬ì›€':'ğŸ˜³','ì˜ì‹¬':'ğŸ¤”','í”¼ê³¤í•¨':'ğŸ˜´','ì„œìš´í•¨':'ğŸ™'}
    };
    const DEFAULT_EMOJIS = { positive:'ğŸ˜Š', negative:'ğŸ˜Ÿ', neutral:'ğŸ˜' };

    let chartInstances = {};
    let currentStudentForReport = null;
    let pendingCustomEmotion = {};

    const pages = ['mainPage','studentPage','friendsPage','teacherLogin','teacherDashboard','studentReportPage','studentLogin','noteToTeacherPage'];

    let toastTimeout=null, undoTimeout=null, lastDeletedEntry=null;

    /* DOM í•¸ë“¤ */
    const tooltip = (typeof document !== 'undefined') ? document.getElementById('tooltip') : null;
    const toastEl = (typeof document !== 'undefined') ? document.getElementById('toast') : null;

    /* =========================
       ìœ í‹¸
       ========================= */
    const getTodayDateString = () => {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    };

    const getEmotionType = (emotion, entry=null) => {
      if (entry && entry.category) return entry.category;
      for (const type in EMOTIONS){
        if (EMOTIONS[type][emotion]) return type;
      }
      return 'neutral';
    };

    function showToast(message, actionText=null, actionCallback=null, expiryCallback=null){
      if (!toastEl) return;
      clearTimeout(toastTimeout); clearTimeout(undoTimeout);
      const undoBtn = actionText && actionCallback ? `<button id="undoButton" class="ml-4 font-bold underline text-blue-800">${actionText}</button>` : '';
      toastEl.innerHTML = `<span>${message}</span>${undoBtn}`;
      toastEl.classList.remove('hidden','opacity-0');
      if (actionCallback){
        document.getElementById('undoButton')?.addEventListener('click', ()=>{
          clearTimeout(toastTimeout); clearTimeout(undoTimeout); actionCallback();
        });
        undoTimeout = setTimeout(()=>{ if (expiryCallback) expiryCallback(); }, 5000);
      }
      const hideDelay = actionCallback ? 5500 : 3000;
      toastTimeout = setTimeout(()=>{
        toastEl.classList.add('opacity-0');
        setTimeout(()=> toastEl.classList.add('hidden'), 300);
      }, hideDelay);
    }

    /* =========================
       ë¡œì»¬ ìºì‹œ
       ========================= */
    const getAllData = () => {
      if (dataLoaded){
        return allDataCache.map(entry => ({
          ...entry,
          id: String(entry.id),
          synced: entry.synced === true,
          date: (entry.date || (entry.timestamp ? entry.timestamp.split('T')[0] : getTodayDateString())),
          studentNumber: (entry.studentNumber || entry.name),
          reason: (entry.reason || entry.content),
          category: (entry.category || entry.tag)
        }));
      }
      const localData = localStorage.getItem(DB_NAME);
      const arr = localData ? JSON.parse(localData) : [];
      return arr.map(entry => ({
        ...entry,
        id: String(entry.id),
        synced: entry.synced === true,
        date: (entry.date || (entry.timestamp ? entry.timestamp.split('T')[0] : getTodayDateString())),
        studentNumber: (entry.studentNumber || entry.name),
        reason: (entry.reason || entry.content),
        category: (entry.category || entry.tag)
      }));
    };

    const saveDataLocally = (data) => {
      const dataToSave = data.map(entry => ({
        id: String(entry.id),
        synced: entry.synced === true,
        date: (entry.date || (entry.timestamp ? entry.timestamp.split('T')[0] : getTodayDateString())),
        studentNumber: (entry.studentNumber || entry.name),
        emotion: entry.emotion,
        emoji: entry.emoji,
        reason: (entry.reason || entry.content),
        category: (entry.category || entry.tag)
      }));
      localStorage.setItem(DB_NAME, JSON.stringify(dataToSave));
      allDataCache = dataToSave;
      dataLoaded = true;
    };

    /* =========================
       GAS í†µì‹ 
       ========================= */
    async function syncDataFromGAS(isForce=false){
      if (!isForce && dataLoaded) return true;
      const btn = document.getElementById('refreshDataBtn');
      if (btn){ btn.disabled = true; btn.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...'; }

      try {
        const res = await fetch(GAS_URL + '?action=readAll', { mode:'cors' });
        const result = await res.json();
        if (res.ok && Array.isArray(result)){
          const normalized = result.map(entry=>({
            id: String(entry.id),
            date: entry.timestamp ? entry.timestamp.split('T')[0] : getTodayDateString(),
            studentNumber: String(entry.name),
            emotion: entry.emotion,
            emoji: entry.emoji,
            reason: entry.content,
            category: entry.tag,
            synced: true
          }));
          saveDataLocally(normalized);
          await flushPendingDeletes();
          return true;
        } else {
          console.error('GAS ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', result);
          showToast('ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ! ë¡œì»¬ ìºì‹œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.');
          allDataCache = getAllData(); dataLoaded = true; return false;
        }
      } catch (e){
        console.error('Fetch Error (ReadAll):', e);
        showToast('ì„œë²„ í†µì‹  ì˜¤ë¥˜ë¡œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¡œì»¬ ìºì‹œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.');
        allDataCache = getAllData(); dataLoaded = true; return false;
      } finally {
        if (btn){ btn.disabled = false; btn.textContent = 'ìƒˆë¡œê³ ì¹¨'; }
      }
    }

    function enqueuePendingDelete(idStr){
      try{
        const q = JSON.parse(localStorage.getItem(PENDING_DELETES)||'[]');
        if (!q.includes(idStr)) q.push(idStr);
        localStorage.setItem(PENDING_DELETES, JSON.stringify(q));
      }catch{}
    }

    async function flushPendingDeletes(){
      const q = JSON.parse(localStorage.getItem(PENDING_DELETES)||'[]');
      if (!q.length) return;
      const remains = [];
      for (const idStr of q){
        try{
          const res = await fetch(GAS_URL, {
            method:'POST', mode:'cors',
            headers:{'Content-Type':'text/plain;charset=utf-8'},
            body: JSON.stringify({ action:'delete', id:idStr, id_numeric:(idStr.match(/\d+/)?.[0] ?? null) })
          });
          const result = await res.json();
          const ok = res.ok && result.status === 'success';
          if (!ok){
            if (!(result.message && result.message.includes('ì‚­ì œí•  IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'))){
              remains.push(idStr);
            }
          }
        } catch {
          remains.push(idStr);
        }
      }
      localStorage.setItem(PENDING_DELETES, JSON.stringify(remains));
    }

    /* =========================
       ì°¨íŠ¸ ë„ìš°ë¯¸
       ========================= */
    function renderChart(canvasOrId, type, data, options){
      let el = null;
      if (typeof canvasOrId === 'string'){
        el = document.getElementById(canvasOrId) || document.querySelector(canvasOrId);
      } else if (canvasOrId instanceof HTMLCanvasElement){
        el = canvasOrId;
      }
      if (!el){ console.error('Canvas not found:', canvasOrId); return; }
      const key = el.id || el.dataset.chartId || (el.dataset.chartId = `chart-${Math.random()}`);
      if (chartInstances[key]) chartInstances[key].destroy();
      const ctx = el.getContext('2d');
      chartInstances[key] = new Chart(ctx, { type, data, options });
    }

    /* =========================
       í˜ì´ì§€ ì „í™˜ / í¼ ì±„ìš°ê¸°
       ========================= */
    function showPage(pageId){
      pages.forEach(pid=>{
        const el = document.getElementById(pid);
        if (el){ el.classList.add('hidden'); el.classList.remove('fade-in'); }
      });
      const target = document.getElementById(pageId);
      if (!target){ console.error('No page:', pageId); return; }
      target.classList.remove('hidden'); target.classList.add('fade-in');
      window.scrollTo(0,0);

      if (pageId === 'friendsPage'){
        syncDataFromGAS(true).then(()=> renderFloatingEmotions());
      }
      if (pageId === 'teacherDashboard') renderTeacherDashboard();
      if (['studentLogin','studentPage','noteToTeacherPage'].includes(pageId)) populateForms();
    }

    function populateForms(){
      const numSelect = document.getElementById('studentNumber');
      const loginNum = document.getElementById('studentLoginNumber');
      const noteNum = document.getElementById('noteStudentNumber');
      const opts = ['<option value="">ë²ˆí˜¸ ì„ íƒ</option>'].concat(
        STUDENT_NUMBERS.map(n=> `<option value="${n}">${n}ë²ˆ</option>`)
      ).join('');
      if (numSelect) numSelect.innerHTML = opts;
      if (loginNum) loginNum.innerHTML = opts;
      if (noteNum) noteNum.innerHTML = opts;

      // ì´ëª¨í‹°ì½˜ ì¹¸ ì±„ìš°ê¸°
      Object.entries(EMOTIONS).forEach(([category, emotions])=>{
        const container = document.getElementById(`${category}Emotions`);
        if (!container) return;
        container.innerHTML = '';
        const bg = category==='positive' ? 'bg-green-50 hover:bg-green-100'
                 : category==='negative' ? 'bg-red-50 hover:bg-red-100'
                 : 'bg-gray-50 hover:bg-gray-100';
        for (const [emotion,emoji] of Object.entries(emotions)){
          container.innerHTML += `
            <div class="emotion-card ${bg} p-3 rounded-lg cursor-pointer text-center text-xs"
                 onclick="selectEmotion('${emotion}','${emoji}','${category}', this)">
              <div class="text-2xl mb-1">${emoji}</div>
              <div class="font-medium">${emotion}</div>
            </div>`;
        }
      });
    }

    function selectEmotion(emotion,emoji,category,el){
      document.querySelectorAll('.emotion-card').forEach(x=> x.classList.remove('ring-2','ring-blue-500'));
      if (el) el.classList.add('ring-2','ring-blue-500');
      document.getElementById('selectedEmotion').value = emotion;
      document.getElementById('selectedEmoji').value = emoji;
      document.getElementById('selectedCategory').value = category;
    }
    function showCustomEmotionInput(){ document.getElementById('customEmotionContainer').classList.remove('hidden'); }
    function hideCustomEmotionInput(){ document.getElementById('customEmotionContainer').classList.add('hidden'); }

    async function callGeminiAPI(prompt){
      if (!API_KEY) return null;
      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
      try{
        let response; let delay = 1000;
        for (let i=0;i<5;i++){
          response = await fetch(url, {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ contents:[{ parts:[{ text: prompt }]}] })
          });
          if (response.ok) break;
          if (response.status===429 || response.status>=500){
            await new Promise(r=> setTimeout(r, delay)); delay *= 2;
          } else {
            return null;
          }
        }
        if (!response.ok) return null;
        const result = await response.json();
        return result.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || null;
      } catch { return null; }
    }

    async function handleCustomEmotion(){
      const inputEl = document.getElementById('customEmotionInput');
      const text = inputEl.value.trim();
      if (!text) return showToast('ê°ì •ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      const btn = inputEl.nextElementSibling;
      btn.disabled = true; btn.textContent = '...';

      pendingCustomEmotion = { text, emoji: null };

      const prompt = `ë‹¤ìŒ í•œêµ­ì–´ ê°ì •ì„ ë¶„ì„í•´ì„œ ê°€ì¥ ì–´ìš¸ë¦¬ëŠ” ëŒ€í‘œ ì–¼êµ´ í‘œì • ì´ëª¨ì§€(emoji)ì™€ ê°ì •ì˜ ê¸ì •/ë¶€ì •/ì¤‘ë¦½ ë¶„ë¥˜ë¥¼ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ ì£¼ì„¸ìš”. categoryëŠ” 'positive', 'negative', 'neutral' ì¤‘ í•˜ë‚˜ì—¬ì•¼ í•©ë‹ˆë‹¤. ë‹¤ë¥¸ ì„¤ëª… ì—†ì´ JSON ê°ì²´ë§Œ ì‘ë‹µí•´ì•¼ í•©ë‹ˆë‹¤. í˜•ì‹: {"emoji": "...", "category": "..."}\n\nê°ì •: "${text}"`;
      const resp = await callGeminiAPI(prompt);
      btn.disabled = false; btn.textContent = 'í™•ì¸';

      if (resp){
        try{
          const cleaned = resp.replace(/```json\n?/,'').replace(/```$/,'');
          const obj = JSON.parse(cleaned);
          if (obj.emoji && obj.category && /\p{Emoji}/u.test(obj.emoji)){
            pendingCustomEmotion.emoji = obj.emoji.slice(0,2);
            return setCustomCategory(obj.category);
          }
        } catch {}
      }
      document.getElementById('fallbackEmotionText').textContent = `"${text}"`;
      document.getElementById('categoryModal').classList.remove('hidden');
    }

    async function setCustomCategory(category){
      const text = pendingCustomEmotion.text;
      let emoji = pendingCustomEmotion.emoji;
      if (!emoji){
        const rec = await callGeminiAPI(`ë‹¤ìŒ í•œêµ­ì–´ ê°ì •ì— ì–´ìš¸ë¦¬ëŠ” ì–¼êµ´ ì´ëª¨ì§€ í•˜ë‚˜ë§Œ ì‘ë‹µ: "${text}"`);
        if (rec && /\p{Emoji}/u.test(rec)) emoji = rec.slice(0,2);
        else emoji = DEFAULT_EMOJIS[category];
      }
      selectEmotion(text, emoji, category, null);
      showToast(`'${text} ${emoji}' ê°ì •ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.`);
      document.getElementById('categoryModal').classList.add('hidden');
      pendingCustomEmotion = {};
    }

    /* =========================
       ì œì¶œ/ì €ì¥ ì²˜ë¦¬
       ========================= */
    async function onEmotionSubmit(e){
      e.preventDefault();
      const today = getTodayDateString();
      const studentNumber = document.getElementById('studentNumber').value;
      const selectedEmotion = document.getElementById('selectedEmotion').value;
      const selectedEmoji = document.getElementById('selectedEmoji').value;
      const selectedCategory = document.getElementById('selectedCategory').value || 'neutral';
      const reason = document.getElementById('emotionReason').value.trim();

      if (!studentNumber) return showToast('ë²ˆí˜¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
      if (!selectedEmotion) return showToast('ê°ì •ì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
      if (!reason) return showToast('ê°ì •ì˜ ì´ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');

      if (getAllData().find(d=> d.date===today && d.studentNumber===studentNumber)){
        return showToast('ì´ë¯¸ ì˜¤ëŠ˜ ê°ì •ì¼ê¸°ë¥¼ ì‘ì„±í–ˆì–´ìš”!');
      }

      // ì‹œíŠ¸ í¬ë§·
      const newEntryForGAS = {
        id: Date.now(),
        timestamp: new Date().toISOString(),
        name: studentNumber,
        emotion: selectedEmotion,
        tag: selectedCategory,
        content: reason,
        emoji: selectedEmoji
      };
      // ë‚´ë¶€ ìºì‹œ í¬ë§·
      const newEntryInternal = {
        id: newEntryForGAS.id,
        date: today,
        studentNumber,
        emotion: selectedEmotion,
        emoji: selectedEmoji,
        reason,
        category: selectedCategory,
        synced: false
      };

      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true; submitBtn.textContent = 'ì €ì¥ ì¤‘...';
      let serverSuccess = false;

      try{
        const res = await fetch(GAS_URL, {
          method:'POST', mode:'cors',
          headers:{'Content-Type':'text/plain;charset=utf-8'},
          body: JSON.stringify({ action:'create', data: newEntryForGAS })
        });
        const txt = await res.text();
        let result;
        try{ if (!txt) throw new Error('EMPTY'); result = JSON.parse(txt); }
        catch{ result = { status:'error', message:'ì‘ë‹µ íŒŒì‹± ì˜¤ë¥˜' }; }

        if (res.ok && result.status === 'success'){
          const serverId = String(result.id ?? newEntryForGAS.id);
          const entry = { ...newEntryInternal, id: serverId, synced: true };
          allDataCache.push(entry);
          serverSuccess = true;
          const msgs = [
            "ì˜¤ëŠ˜ë„ í˜ë‚´ì„¸ìš”! ë©‹ì§„ í•˜ë£¨ê°€ ë  ê±°ì˜ˆìš”. í™”ì´íŒ…!",
            "ì•„ì¹¨ë¶€í„° ê¸°ë¡í•˜ëŠ” ë‹¹ì‹ , ì •ë§ ë©‹ì ¸ìš”! ì‘ì›í•©ë‹ˆë‹¤!",
            "ì¢‹ì€ ì‹œì‘ì´ì—ìš”! ì˜¤ëŠ˜ í•˜ë£¨ë„ ê¸ì • ì—ë„ˆì§€ ê°€ë“í•˜ê¸¸!",
            "ê°ì‚¬í•©ë‹ˆë‹¤! ë‹¹ì‹ ì˜ í•˜ë£¨ë¥¼ ì‘ì›í• ê²Œìš”. í™”ì´íŒ…!",
            "ê¸°ë¡ ì™„ë£Œ! ì˜¤ëŠ˜ í•˜ë£¨ë„ ë°˜ì§ë°˜ì§ ë¹›ë‚˜ê¸¸ ë°”ë¼ìš”."
          ];
          showToast(msgs[Math.floor(Math.random()*msgs.length)]);
        } else {
          allDataCache.push(newEntryInternal);
          showToast(`ì €ì¥ ì‹¤íŒ¨: ${result.message || 'ì„œë²„ ì˜¤ë¥˜. êµì‚¬ì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.'}`);
        }
      } catch (err){
        allDataCache.push(newEntryInternal);
        showToast('ì„œë²„ í†µì‹  ì˜¤ë¥˜! ê¸°ë¡ì„ ë¡œì»¬ì— ì„ì‹œ ì €ì¥í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
      } finally {
        submitBtn.disabled = false; submitBtn.textContent = 'ğŸ’¾ ê°ì •ì¼ê¸° ì €ì¥í•˜ê¸°';
        saveDataLocally(allDataCache);
        e.target.reset();
        document.querySelectorAll('.emotion-card').forEach(el=> el.classList.remove('ring-2','ring-blue-500'));
        if (serverSuccess) showPage('mainPage');
      }
    }

    async function onSendNote(e){
      e.preventDefault();
      const studentNumber = document.getElementById('noteStudentNumber').value;
      const content = document.getElementById('noteContent').value.trim();
      if (!studentNumber || !content) return showToast('ë²ˆí˜¸ ì„ íƒê³¼ ìª½ì§€ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');

      const entry = { timestamp:new Date().toISOString(), name:studentNumber, content };
      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true; btn.textContent = 'ì „ì†¡ ì¤‘...';

      try{
        const res = await fetch(GAS_URL, {
          method:'POST', mode:'cors',
          headers:{'Content-Type':'text/plain;charset=utf-8'},
          body: JSON.stringify({ action:'sendNote', data: entry })
        });
        const txt = await res.text();
        let result; try{ if (!txt) throw new Error('EMPTY'); result = JSON.parse(txt);} catch{ result = {status:'error'}; }
        if (res.ok && result.status==='success'){
          showToast('ìª½ì§€ê°€ ì„ ìƒë‹˜ê»˜ ì„±ê³µì ìœ¼ë¡œ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤! (ë¹„ë°€ ë³´ì¥)');
          e.target.reset(); showPage('mainPage');
        } else {
          showToast('ìª½ì§€ ì „ì†¡ ì‹¤íŒ¨: ì„œë²„ ì˜¤ë¥˜. GAS ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
        }
      } catch {
        showToast('ì„œë²„ í†µì‹  ì˜¤ë¥˜ë¡œ ìª½ì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      } finally {
        btn.disabled = false; btn.textContent = 'ğŸ’Œ ìª½ì§€ ì „ì†¡í•˜ê¸°';
      }
    }

    /* =========================
       ì¹œêµ¬ë“¤ í˜ì´ì§€
       ========================= */
    function renderFloatingEmotions(){
      const container = document.getElementById('floatingEmotions');
      container.innerHTML = `
        <div class="text-center py-10">
          <div class="loader mx-auto"></div>
          <p class="text-gray-600 mt-4">ì¹œêµ¬ë“¤ì˜ ê°ì • ê¸°ë¡ì„ ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>`;
      const todays = getAllData().filter(d=> d.date === getTodayDateString());
      if (!todays.length){
        container.innerHTML = `<div class="text-center text-gray-500 py-20">ì•„ì§ ì¼ê¸°ë¥¼ ì“´ ì¹œêµ¬ê°€ ì—†ì–´ìš”.</div>`;
        return;
      }
      container.innerHTML = '';
      const positions = [];
      const size = 48;
      const W = container.offsetWidth, H = container.offsetHeight;

      todays.forEach(entry=>{
        const el = document.createElement('div');
        el.className = 'floating-emotion';
        el.textContent = entry.emoji;

        let left, top, overlaps, attempts=0;
        do{
          overlaps = false;
          left = Math.random()*(W-size);
          top  = Math.random()*(H-size);
          for (const pos of positions){
            if (left < pos.right && left+size > pos.left && top < pos.bottom && top+size > pos.top){ overlaps=true; break; }
          }
          attempts++;
        } while (overlaps && attempts < 100);

        positions.push({ left, top, right:left+size, bottom:top+size });
        el.style.left = `${left}px`; el.style.top = `${top}px`; el.style.animationDelay = `${Math.random()*5}s`;

        const showDetail = (e)=>{
          const rect = e.target.getBoundingClientRect();
          tooltip.innerHTML = `<strong>${entry.studentNumber}ë²ˆ (${entry.emotion})</strong><br><span class="text-sm">${entry.reason}</span>`;
          tooltip.classList.add('show');
          let w = tooltip.offsetWidth, h = tooltip.offsetHeight;
          let L = rect.left + rect.width/2 - w/2;
          let T = rect.top - h - 10;
          if (L < 10) L = 10;
          if (L + w > window.innerWidth - 10) L = window.innerWidth - w - 10;
          if (T < 10) T = 10;
          tooltip.style.left = `${L}px`; tooltip.style.top = `${T}px`;
        };
        const hideDetail = ()=> tooltip.classList.remove('show');

        el.onmouseenter = showDetail; el.onmouseleave = hideDetail;
        let t = null;
        el.addEventListener('touchstart',(e)=>{
          e.preventDefault(); showDetail({ target: el, getBoundingClientRect:()=> el.getBoundingClientRect(), touches:e.touches });
          t = setTimeout(hideDetail, 3000);
        });
        el.addEventListener('touchend', ()=>{ clearTimeout(t); hideDetail(); });
        el.addEventListener('touchcancel', ()=>{ clearTimeout(t); hideDetail(); });

        container.appendChild(el);
      });
    }

    /* =========================
       êµì‚¬ ëŒ€ì‹œë³´ë“œ / ì‚­ì œ
       ========================= */
    function handleTeacherLogin(ev){
      if (ev && ev.preventDefault) ev.preventDefault();
      const pw = document.getElementById('teacherPassword');
      if (pw.value === TEACHER_PASSWORD){
        document.getElementById('loginError').classList.add('hidden'); pw.value='';
        showPage('teacherDashboard');
      } else {
        document.getElementById('loginError').classList.remove('hidden');
      }
      return false;
    }
    function logoutTeacher(){ showPage('mainPage'); }

    async function clearLocalCache(){
      localStorage.removeItem(DB_NAME);
      localStorage.removeItem(PENDING_DELETES);
      allDataCache = []; dataLoaded = false;
      showToast('ë¸Œë¼ìš°ì € ìºì‹œë¥¼ ì‚­ì œí•˜ê³  ì„œë²„ì—ì„œ ìµœì‹  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤...');
      await syncDataFromGAS(true);
      if (document.getElementById('teacherDashboard').classList.contains('hidden')) showPage('mainPage');
      else renderTeacherDashboard();
    }

    function switchDashboardTab(tab){
      document.getElementById('dailyTab').classList.toggle('active', tab==='daily');
      document.getElementById('monthlyTab').classList.toggle('active', tab==='monthly');
      document.getElementById('notesTab').classList.toggle('active', tab==='notes');

      document.getElementById('dailyReportContent').classList.toggle('hidden', tab!=='daily');
      document.getElementById('monthlyReportContent').classList.toggle('hidden', tab!=='monthly');
      document.getElementById('notesContent').classList.toggle('hidden', tab!=='notes');

      document.getElementById('dashboardDate').classList.toggle('hidden', tab!=='daily');
      document.getElementById('dashboardMonth').classList.toggle('hidden', tab!=='monthly');

      if (tab==='daily'){ renderDailyReport(); renderStudentListForDashboard(); }
      if (tab==='monthly') renderMonthlyReport();
      if (tab==='notes') renderTeacherNotes();
    }

    function renderTeacherDashboard(){
      const datePicker = document.getElementById('dashboardDate');
      const monthPicker = document.getElementById('dashboardMonth');
      datePicker.value = datePicker.value || getTodayDateString();
      const today = new Date();
      monthPicker.value = monthPicker.value || `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;

      if (!datePicker.dataset.listenerAttached){
        datePicker.addEventListener('change', ()=>{ renderDailyReport(); renderStudentListForDashboard(); });
        datePicker.dataset.listenerAttached = 'true';
      }
      if (!monthPicker.dataset.listenerAttached){
        monthPicker.addEventListener('change', renderMonthlyReport);
        monthPicker.dataset.listenerAttached = 'true';
      }
      const activeId = document.querySelector('.tab-button.active')?.id;
      switchDashboardTab(activeId==='monthlyTab' ? 'monthly' : (activeId==='notesTab' ? 'notes' : 'daily'));
      if (document.querySelector('.tab-button.active')?.id!=='notesTab') renderStudentListForDashboard();
    }

    function handleListClick(e){
      if (e.target.classList.contains('delete-btn')){
        const rawId = e.target.dataset.id;
        deleteEntry(rawId);
      }
    }

    async function deleteEntry(id){
      const idStr = String(id);
      if (!idStr){ showToast('ì‚­ì œ ì˜¤ë¥˜: IDê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.'); return; }
      const btn = document.querySelector(`button[data-id="${idStr}"]`);
      if (btn){ btn.disabled = true; btn.textContent = '...'; }

      const idx = allDataCache.findIndex(e=> String(e.id)===idStr);
      if (idx === -1){
        showToast('ì‚­ì œ ì˜¤ë¥˜: í•´ë‹¹ ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        if (btn){ btn.disabled=false; btn.textContent='ì‚­ì œ'; }
        return;
      }

      lastDeletedEntry = allDataCache.splice(idx,1)[0];
      saveDataLocally(allDataCache);
      refreshAfterDelete();

      showToast('ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.','ë˜ëŒë¦¬ê¸°', ()=> undoDelete(), ()=> confirmDelete());
    }

    function undoDelete(){
      if (!lastDeletedEntry) return;
      allDataCache.push(lastDeletedEntry);
      allDataCache.sort((a,b)=> a.date.localeCompare(b.date));
      saveDataLocally(allDataCache);
      refreshAfterDelete();
      showToast('ì‚­ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
      lastDeletedEntry=null; clearTimeout(undoTimeout);
    }

    async function confirmDelete(){
      if (!lastDeletedEntry) return;
      const entry = lastDeletedEntry;
      lastDeletedEntry = null;
      if (entry.synced !== true) return; // ë¡œì»¬-onlyëŠ” ë

      try{
        const res = await fetch(GAS_URL, {
          method:'POST', mode:'cors',
          headers:{'Content-Type':'text/plain;charset=utf-8'},
          body: JSON.stringify({ action:'delete', id: entry.id, id_numeric:(String(entry.id).match(/\d+/)?.[0] ?? null)})
        });
        let result={}; try{ const t = await res.text(); result = t? JSON.parse(t):{}; } catch {}
        if (!(res.ok && result.status==='success')) enqueuePendingDelete(String(entry.id));
      } catch {
        enqueuePendingDelete(String(entry.id));
      }
    }

    function refreshAfterDelete(){
      if (!document.getElementById('teacherDashboard').classList.contains('hidden') &&
          document.getElementById('dailyTab').classList.contains('active')){
        renderDailyReport(); renderStudentListForDashboard();
      } else if (!document.getElementById('studentReportPage').classList.contains('hidden') && currentStudentForReport){
        renderStudentReport(currentStudentForReport);
      }
    }

    function renderDailyReport(){
      const selectedDate = document.getElementById('dashboardDate').value;
      document.getElementById('dailyDistributionTitle').textContent = `${selectedDate} ê°ì • ë¶„í¬`;
      document.getElementById('dailyEntriesTitle').textContent = `${selectedDate}ì˜ ê¸°ë¡`;

      const daily = getAllData().filter(d=> d.date===selectedDate);
      const counts = { positive:0, negative:0, neutral:0 };
      daily.forEach(e=> counts[getEmotionType(e.emotion,e)]++);

      document.getElementById('todaySubmissionCount').textContent = `${daily.length} / ${STUDENT_NUMBERS.length}`;
      document.getElementById('todayPositiveCount').textContent = counts.positive;
      document.getElementById('todayNegativeCount').textContent = counts.negative;

      renderChart('dailyDistributionChart','pie',{
        labels:['ê¸ì •','ë¶€ì •','ì¤‘ë¦½'],
        datasets:[{ data:Object.values(counts), backgroundColor:['#4CAF50','#F44336','#FFC107']}]
      }, { responsive:true, maintainAspectRatio:false });

      const list = document.getElementById('dailyEntriesList');
      list.innerHTML = daily.length ? '' : '<p class="text-gray-500">ì„ íƒí•œ ë‚ ì§œì— ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
      daily.forEach(entry=>{
        list.innerHTML += `
          <div class="border-b pb-3 flex items-center">
            <div class="flex-grow">
              <p class="font-bold">${entry.emoji} ${entry.studentNumber}ë²ˆ - <span class="font-medium">${entry.emotion}</span></p>
              <p class="text-sm text-gray-600 pl-7">${entry.reason}</p>
            </div>
            <button data-id="${String(entry.id)}"
              class="delete-btn bg-red-100 text-red-600 hover:bg-red-200 text-xs font-bold py-1 px-2 rounded-md">
              ì‚­ì œ
            </button>
          </div>`;
      });
      list.removeEventListener('click', handleListClick);
      list.addEventListener('click', handleListClick);
      renderStudentListForDashboard();
    }

    function renderMonthlyReport(){
      const monthString = document.getElementById('dashboardMonth').value;
      const [y,m] = monthString.split('-').map(Number);
      const monthData = getAllData().filter(d=> d.date.startsWith(monthString));
      const days = new Date(y,m,0).getDate();

      const counts = { positive:0, negative:0, neutral:0 };
      monthData.forEach(e=> counts[getEmotionType(e.emotion,e)]++);
      document.getElementById('monthlyPositiveCount').textContent = counts.positive;
      document.getElementById('monthlyNeutralCount').textContent = counts.neutral;
      document.getElementById('monthlyNegativeCount').textContent = counts.negative;

      renderChart('monthlyDistributionChart','doughnut',{
        labels:['ê¸ì •','ë¶€ì •','ì¤‘ë¦½'],
        datasets:[{ data:Object.values(counts), backgroundColor:['#4CAF50','#F44336','#FFC107']}]
      }, { responsive:true, maintainAspectRatio:false });

      // ê°„ë‹¨ ì¶”ì´(ìŠ¤íƒ ì˜ˆì‹œ ëŒ€ì‹  placeholder)
      const labels = Array.from({length:days},(_,i)=> i+1);
      const dailyPos = labels.map(day=>{
        const ds = monthData.filter(d=> d.date === `${monthString}-${String(day).padStart(2,'0')}`);
        return ds.filter(d=> getEmotionType(d.emotion,d)==='positive').length;
      });
      const dailyNeu = labels.map(day=>{
        const ds = monthData.filter(d=> d.date === `${monthString}-${String(day).padStart(2,'0')}`);
        return ds.filter(d=> getEmotionType(d.emotion,d)==='neutral').length;
      });
      const dailyNeg = labels.map(day=>{
        const ds = monthData.filter(d=> d.date === `${monthString}-${String(day).padStart(2,'0')}`);
        return ds.filter(d=> getEmotionType(d.emotion,d)==='negative').length;
      });

      renderChart('monthlyTrendChart','bar',{
        labels,
        datasets:[
          { label:'ê¸ì •', data:dailyPos, backgroundColor:'#4CAF50' },
          { label:'ì¤‘ë¦½', data:dailyNeu, backgroundColor:'#FFC107' },
          { label:'ë¶€ì •', data:dailyNeg, backgroundColor:'#F44336' }
        ]
      }, { responsive:true, maintainAspectRatio:false, scales:{ x:{ stacked:true }, y:{ stacked:true, beginAtZero:true } } });
    }

    function renderStudentListForDashboard(){
      const box = document.getElementById('studentReportLinks'); if (!box) return;
      box.innerHTML = '';
      const selectedDate = document.getElementById('dashboardDate').value;
      const submitted = getAllData().filter(d=> d.date===selectedDate).map(d=> d.studentNumber);
      STUDENT_NUMBERS.sort((a,b)=> parseInt(a)-parseInt(b)).forEach(num=>{
        const ok = submitted.includes(num);
        const cls = ok ? 'bg-blue-200 hover:bg-blue-300 text-blue-800' : 'bg-gray-100 hover:bg-gray-200 text-gray-700';
        box.innerHTML += `<button onclick="renderStudentReport('${num}', true)" class="${cls} font-medium py-2 px-3 rounded-lg transition">${num}ë²ˆ</button>`;
      });
    }

    async function refreshDashboardData(){
      const ok = await syncDataFromGAS(true);
      if (ok){ renderTeacherDashboard(); showToast('ëŒ€ì‹œë³´ë“œê°€ ìµœì‹  ê¸°ë¡ìœ¼ë¡œ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤.'); }
    }

    async function renderTeacherNotes(){
      const list = document.getElementById('notesList');
      const err = document.getElementById('notesLoadingError');
      list.innerHTML = '<div class="text-center py-10"><div class="loader mx-auto"></div><p class="text-gray-600 mt-4">ìª½ì§€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>';
      err.classList.add('hidden');
      try{
        const res = await fetch(GAS_URL + '?action=readNotes', { mode:'cors' });
        const result = await res.json();
        if (res.ok && Array.isArray(result)){
          list.innerHTML = '';
          if (!result.length){
            list.innerHTML = '<p class="text-gray-500 text-center py-10">ë„ì°©í•œ ìª½ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'; return;
          }
          result.slice().reverse().forEach(note=>{
            const ts = new Date(note.timestamp).toLocaleString('ko-KR',{year:'2-digit',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
            list.innerHTML += `
              <div class="bg-gray-50 p-4 rounded-xl shadow-md border border-gray-200">
                <div class="flex justify-between items-start mb-2 border-b pb-2">
                  <span class="font-bold text-lg text-gray-800">ğŸ’Œ ${note.name}ë²ˆ í•™ìƒ</span>
                  <span class="text-xs text-gray-500">${ts}</span>
                </div>
                <p class="text-gray-700 whitespace-pre-wrap">${note.content}</p>
              </div>`;
          });
        } else {
          list.innerHTML=''; err.classList.remove('hidden');
        }
      } catch {
        list.innerHTML=''; err.classList.remove('hidden'); err.textContent='ì„œë²„ í†µì‹  ì˜¤ë¥˜: ìª½ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
      }
    }

    /* =========================
       í•™ìƒ ë¦¬í¬íŠ¸ (ì œëª©ì— ì›” í‘œì‹œ ê³ ì •)
       ========================= */
    async function renderStudentReportContent(containerSelector, studentNumber, monthString){
      const container = document.querySelector(containerSelector);
      if (!container){ console.error('Container not found:', containerSelector); return; }

      const studentAll = getAllData().filter(d=> d.studentNumber===studentNumber);
      const studentMonth = studentAll.filter(d=> d.date.startsWith(monthString));

      const [year, month] = monthString.split('-').map(Number);
      const monthTitle = `${year}ë…„ ${month}ì›”`;
      const monthLabel = `${month}ì›”`;

      // ìƒë‹¨ ì œëª©ë“¤
      container.querySelector('#candyJarTitle').textContent = `ğŸ¬  (${monthTitle})ì˜ ê°ì • ë³´ê´€í•¨`;
      container.querySelector('#monthlyRecordsTitle').textContent = `${monthTitle}ì˜ ì „ì²´ ê¸°ë¡`;

      // âœ… ìš”ì²­ ì‚¬í•­: "(ì„ íƒí•œ ë‹¬)ì˜ ê°ì •ë¶„í¬/ê°ì •ë³€í™”" â†’ "11ì›”ì˜ ê°ì •ë¶„í¬/ê°ì •ë³€í™”"
      const emotionTitleEl = container.querySelector('#myEmotionTitle');
      const trendTitleEl   = container.querySelector('#myTrendTitle');
      if (emotionTitleEl) emotionTitleEl.textContent = `${monthLabel}ì˜ ê°ì •ë¶„í¬`;
      if (trendTitleEl)   trendTitleEl.textContent   = `${monthLabel}ì˜ ê°ì •ë³€í™”`;

      // í†µê³„
      const totalMonthRecords = studentMonth.length;
      const counts = { positive:0, negative:0, neutral:0 };
      studentMonth.forEach(e=> counts[getEmotionType(e.emotion,e)]++);

      container.querySelector('#myTotalRecords').textContent = totalMonthRecords;
      container.querySelector('#myPositiveCount').textContent = counts.positive;
      container.querySelector('#myNeutralCount').textContent  = counts.neutral;
      container.querySelector('#myNegativeCount').textContent = counts.negative;

      renderChart(container.querySelector('#myEmotionChart'),'doughnut',{
        labels:['ê¸ì •','ë¶€ì •','ì¤‘ë¦½'],
        datasets:[{ data:Object.values(counts), backgroundColor:['#4CAF50','#F44336','#FFC107']}]
      }, { responsive:true, maintainAspectRatio:false });

      // ê°ì • ë³€í™”(ë¼ì¸)
      const daysInMonth = new Date(year, month, 0).getDate();
      const dailyTrends = Array.from({length:daysInMonth},(_,i)=>{
        const dayStr = `${monthString}-${String(i+1).padStart(2,'0')}`;
        const dayData = studentMonth.find(d=> d.date===dayStr);
        if (!dayData) return null;
        const c = getEmotionType(dayData.emotion, dayData);
        if (c==='positive') return 1;
        if (c==='negative') return -1;
        return 0;
      });

      renderChart(container.querySelector('#myTrendChart'),'line',{
        labels: Array.from({length:daysInMonth},(_,i)=> i+1),
        datasets:[{
          label:'ê°ì • ë³€í™”', data: dailyTrends, borderColor:'#667eea', backgroundColor:'#667eea20', fill:true, tension:.1, spanGaps:true
        }]
      }, {
        responsive:true, maintainAspectRatio:false,
        scales:{
          x:{ title:{ display:true, text:`${month}ì›”` }},
          y:{ min:-1.5, max:1.5, ticks:{ callback:(v)=> v===1?'ê¸ì •': v===0?'ì¤‘ë¦½': v===-1?'ë¶€ì •': '' } }
        }
      });

      // TOP5 (í•´ë‹¹ ì›” ê¸°ì¤€)
      const topBox = container.querySelector('#myTopEmotions'); topBox.innerHTML='';
      const emoCounts = studentMonth.reduce((acc,c)=> (acc[c.emotion]=(acc[c.emotion]||0)+1, acc),{});
      const sorted = Object.entries(emoCounts).sort((a,b)=> b[1]-a[1]).slice(0,5);
      if (sorted.length){
        sorted.forEach(([emo,count],i)=>{
          const emoji = (studentAll.find(d=> d.emotion===emo)?.emoji) || DEFAULT_EMOJIS[getEmotionType(emo)];
          topBox.innerHTML += `<div class="flex items-center justify-between text-gray-700 border-b pb-2"><span>${i+1}. ${emoji} ${emo}</span><span class="font-bold">${count}íšŒ</span></div>`;
        });
      } else {
        topBox.innerHTML = '<p class="text-gray-500">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
      }

      // ê°ì • ì‚¬íƒ• ë³‘ (í•´ë‹¹ ì›”)
      const candyContainer = container.querySelector('#candyContainer');
      candyContainer.innerHTML = '';
      if (studentMonth.length){
        const jarW = 400*1.09, jarH = 500*1.09;
        const candySize = 126;
        const offX = (candyContainer.offsetWidth - jarW)/2;
        const offY = (candyContainer.offsetHeight - jarH)/2;
        const stackW = candySize*0.7, maxPerRow = Math.floor((jarW*0.8)/stackW);
        const stackH = candySize*0.3;

        studentMonth.forEach((entry,idx)=>{
          const candy = document.createElement('div');
          candy.className = 'w-28 h-28 rounded-full flex items-center justify-center text-7xl absolute falling-candy';
          candy.textContent = entry.emoji;
          candy.title = `${entry.date}: ${entry.emotion}`;

          const row = Math.floor(idx / maxPerRow);
          const col = idx % maxPerRow;
          let bottom = offY + (row*stackH) + (Math.random()*5 - 2.5);
          let left   = offX + (jarW*0.1) + (col*stackW) + (row%2===1 ? stackW/2 : 0) + (Math.random()*10 - 5);
          if (left + candySize > offX + jarW*0.9) left -= stackW/2;

          candy.style.left = `${left}px`; candy.style.bottom = `${bottom}px`;
          candy.style.animationDelay = `${idx * 0.15}s`;
          candy.style.setProperty('--final-rotate', `${Math.random()*360}deg`);

          candy.onmouseenter = (e)=>{
            tooltip.innerHTML = `<strong>${entry.date}</strong><br><span>${entry.emotion} ${entry.emoji}</span><br><span class="text-sm">${entry.reason}</span>`;
            tooltip.classList.add('show');
            const r = e.target.getBoundingClientRect();
            tooltip.style.left = `${r.left + r.width/2 - tooltip.offsetWidth/2}px`;
            tooltip.style.top  = `${r.top - tooltip.offsetHeight - 5}px`;
          };
          candy.onmouseleave = ()=> tooltip.classList.remove('show');
          candyContainer.appendChild(candy);
        });
      } else {
        candyContainer.innerHTML = '<p class="text-gray-500">ì„ íƒí•œ ë‹¬ì— ê¸°ë¡ëœ ê°ì • ì‚¬íƒ•ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
      }

      // í•´ë‹¹ ë‹¬ ê¸°ë¡ ëª©ë¡
      const rec = container.querySelector('#myRecentRecords');
      rec.innerHTML = '';
      if (studentMonth.length){
        studentMonth.slice().sort((a,b)=> b.date.localeCompare(a.date)).forEach(e=>{
          rec.innerHTML += `
            <div class="bg-gray-50 p-4 rounded-xl shadow-sm border-l-4 ${e.category==='positive'?'border-green-500': e.category==='negative'?'border-red-500':'border-gray-500'}">
              <p class="font-semibold text-gray-800">${e.date} &middot; ${e.emotion} ${e.emoji}</p>
              <p class="text-sm text-gray-600 mt-1 whitespace-pre-wrap">${e.reason}</p>
            </div>`;
        });
      } else {
        rec.innerHTML = '<p class="text-gray-500">ì„ íƒí•œ ë‹¬ì˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
      }
    }

    function renderStudentReport(studentNumber, isTeacherView=true){
      currentStudentForReport = studentNumber;
      showPage('studentReportPage');

      document.getElementById('studentReportNumber').textContent = `${studentNumber}ë²ˆ í•™ìƒì˜ ë¦¬í¬íŠ¸`;

      const monthPicker = document.getElementById('studentReportMonth');
      if (!monthPicker.dataset.listenerAttached){
        monthPicker.addEventListener('change', ()=> renderStudentReport(studentNumber, isTeacherView));
        monthPicker.dataset.listenerAttached = 'true';
      }
      const today = new Date();
      const defMonth = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
      monthPicker.value = monthPicker.value || defMonth;
      const selectedMonth = monthPicker.value;

      document.getElementById('dashboardButton').classList.toggle('hidden', !isTeacherView);
      document.getElementById('mainPageButton').classList.toggle('hidden', isTeacherView);

      renderStudentReportContent('#studentReportPage', studentNumber, selectedMonth);

      const adviceBox = document.getElementById('aiAdvice');
      const adviceBtn = document.getElementById('generateAdviceBtn');
      const adviceContainer = document.querySelector('#studentReportPage > .max-w-4xl > .bg-white.rounded-2xl.shadow-lg.p-6.mb-6:last-child');
      if (adviceContainer){
        if (isTeacherView){
          adviceContainer.classList.add('hidden');
        } else {
          adviceContainer.classList.remove('hidden');
          if (adviceBox) adviceBox.innerHTML = '<p class="text-sm text-gray-500">ë²„íŠ¼ì„ ëˆŒëŸ¬ ì„ ìƒë‹˜ì˜ ê²©ë ¤ ë©”ì‹œì§€ë¥¼ ìƒì„±í•´ ë³´ì„¸ìš”.</p>';
          if (adviceBtn){ adviceBtn.disabled = false; adviceBtn.textContent = 'ì¡°ì–¸ ìƒì„±í•˜ê¸°'; }
        }
      }
    }

    async function fetchAIAdvice(){
      const studentNumber = currentStudentForReport;
      if (!studentNumber) return showToast('í•™ìƒ ë²ˆí˜¸ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      if (!API_KEY) return showToast('Gemini API í‚¤ë¥¼ ì„¤ì •í•´ì•¼ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ìš”.');

      const btn = document.getElementById('generateAdviceBtn');
      const el  = document.getElementById('aiAdvice');
      btn.disabled = true; btn.textContent = 'ì¡°ì–¸ ë¶„ì„ ì¤‘...';
      el.innerHTML = '<div class="loader mx-auto"></div><p class="text-center text-purple-700 mt-2">í•™ìƒì˜ ê°ì • ê¸°ë¡ì„ ë¶„ì„í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>';

      const data = getAllData().filter(d=> d.studentNumber===studentNumber);
      if (!data.length){
        el.innerHTML = '<p class="text-red-600 font-semibold">ì•„ì§ ì´ í•™ìƒì˜ ê¸°ë¡ì´ ì—†ì–´ ì¡°ì–¸ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
        btn.disabled=false; btn.textContent='ì¡°ì–¸ ìƒì„±í•˜ê¸°'; return;
      }
      const recent5 = data.slice(-5).map(e=> `[${e.date} ${e.emotion}] ${e.reason}`).join('\n');
      const total = data.reduce((acc,c)=> (acc[getEmotionType(c.emotion,c)]++, acc), {positive:0,negative:0,neutral:0});
      const prompt = `ë‹¹ì‹ ì€ ì´ˆë“±í•™ìƒì˜ ë‹´ì„ ì„ ìƒë‹˜ì…ë‹ˆë‹¤. ì•„ë˜ëŠ” ${studentNumber}ë²ˆ í•™ìƒì˜ ìµœê·¼ ê°ì •ì¼ê¸° ê¸°ë¡ê³¼ ì „ì²´ì ì¸ ê°ì • í†µê³„ì…ë‹ˆë‹¤. ì´ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•™ìƒì—ê²Œ í˜ì´ ë˜ê³  ê²©ë ¤ê°€ ë˜ëŠ” ê¸ì •ì ì´ê³  ë”°ëœ»í•œ **ì§§ì€ ì¡°ì–¸** í•œ ë§ˆë””ë¥¼ í•œêµ­ì–´ë¡œ ì‘ì„±í•´ ì£¼ì„¸ìš”. ì¡°ì–¸ì€ ë°˜ë“œì‹œ 3ë¬¸ì¥ ì´ë‚´ë¡œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

<í•™ìƒ ê°ì • í†µê³„>
- ì „ì²´ ê¸°ë¡: ${data.length}ê±´
- ê¸ì •: ${total.positive}íšŒ, ë¶€ì •: ${total.negative}íšŒ, ì¤‘ë¦½: ${total.neutral}íšŒ

<ìµœê·¼ 5ì¼ê°„ì˜ ê¸°ë¡ (ìµœì‹ ìˆœ)>
${recent5}

ì„ ìƒë‹˜ì˜ ì¡°ì–¸:`;
      const advice = await callGeminiAPI(prompt);
      el.innerHTML = advice ? `<p class="whitespace-pre-wrap">${advice}</p>`
                            : '<p class="text-red-600 font-semibold">AI ì¡°ì–¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</p>';
      btn.disabled=false; btn.textContent='ì¡°ì–¸ ë‹¤ì‹œ ìƒì„±í•˜ê¸°';
    }

    /* =========================
       í•™ìƒ ë¡œê·¸ì¸
       ========================= */
    function handleStudentLogin(e){
      e.preventDefault();
      const num = document.getElementById('studentLoginNumber').value;
      const pw  = document.getElementById('studentLoginPassword').value;
      const err = document.getElementById('studentLoginError');
      if (!num || !pw){ err.textContent='ë²ˆí˜¸ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.'; err.classList.remove('hidden'); return; }

      const SECRET=572, MULT=17;
      const expected = ((Number(num)*MULT)+SECRET).toString().slice(-4).padStart(4,'0');
      if (pw === expected){
        err.classList.add('hidden');
        document.getElementById('studentLoginForm').reset();
        renderStudentReport(num, false);
      } else {
        err.textContent='ë²ˆí˜¸ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
        err.classList.remove('hidden');
      }
    }

    /* =========================
       ì´ˆê¸°í™”
       ========================= */
    document.addEventListener('DOMContentLoaded', async ()=>{
      document.getElementById('currentDate').textContent = getTodayDateString();
      populateForms();
      await syncDataFromGAS();
      showPage('mainPage');

      // í¼ ë¦¬ìŠ¤ë„ˆ
      const emotionForm = document.getElementById('emotionForm');
      if (emotionForm) emotionForm.addEventListener('submit', onEmotionSubmit);

      const noteForm = document.getElementById('noteForm');
      if (noteForm) noteForm.addEventListener('submit', onSendNote);

      const studentLoginForm = document.getElementById('studentLoginForm');
      if (studentLoginForm) studentLoginForm.addEventListener('submit', handleStudentLogin);

      // ëŒ€ì‹œë³´ë“œ ê¸°ë³¸ ë‚ ì§œ/ì›”
      const d = document.getElementById('dashboardDate'); if (d) d.value = getTodayDateString();
      const m = document.getElementById('dashboardMonth');
      if (m){ const t = new Date(); m.value = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}`; }
    });
  </script>
</head>

<body class="bg-gradient-to-br from-blue-50 to-purple-50 min-h-screen">
  <div id="appContainer">
    <!-- ë©”ì¸ -->
    <div id="mainPage" class="container mx-auto px-4 pt-24 pb-16">
      <div class="text-center mb-12 fade-in">
        <h1 class="text-4xl font-bold text-gray-800 mb-4">ğŸ“ ìš°ë¦¬ë°˜ ê°ì •ì¼ê¸°</h1>
        <p class="text-lg text-gray-600">ë§¤ì¼ë§¤ì¼ ë‚´ ë§ˆìŒì„ ê¸°ë¡í•´ë³´ì„¸ìš”</p>
        <div class="text-sm text-gray-500 mt-2" id="currentDate"></div>
      </div>

      <div class="max-w-md mx-auto space-y-6">
        <button onclick="showPage('studentPage')" class="w-full bg-gradient-to-r from-blue-100 to-indigo-100 hover:from-blue-200 hover:to-indigo-200 text-indigo-700 font-semibold py-6 px-8 rounded-2xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
          <div class="text-3xl mb-2">ğŸ§¸</div>
          <div class="text-xl">í•™ìƒìš©</div>
          <div class="text-sm opacity-90 mt-1">ê°ì •ì¼ê¸° ì‘ì„±í•˜ê¸°</div>
        </button>

        <button onclick="showPage('friendsPage')" class="w-full bg-gradient-to-r from-green-100 to-emerald-100 hover:from-green-200 hover:to-emerald-200 text-green-800 font-semibold py-6 px-8 rounded-2xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
          <div class="text-3xl mb-2">ğŸ‘«</div>
          <div class="text-xl">ì¹œêµ¬ë“¤ ê°ì • í™•ì¸í•˜ê¸°</div>
          <div class="text-sm opacity-90 mt-1">ì˜¤ëŠ˜ ì¹œêµ¬ë“¤ì˜ ê¸°ë¶„ì€?</div>
        </button>
      </div>

      <p class="text-center text-sm text-gray-500 mt-20">made by í•´ì†”ì´ˆ ì‹¬ìŒ¤ ğŸ’œ ì˜¤ìƒ‰ì¹ ë°˜</p>

      <button onclick="showPage('studentLogin')" class="fixed bottom-40 right-6 bg-gradient-to-br from-blue-300 to-indigo-400 text-white w-16 h-16 rounded-full shadow-lg hover:shadow-xl transform hover:scale-110 transition-all duration-200 z-50 flex items-center justify-center">
        <div class="text-2xl">ğŸ“Š</div>
      </button>

      <button onclick="showPage('noteToTeacherPage')" class="fixed right-6 bg-gradient-to-br from-yellow-200 to-gray-300 text-gray-700 w-16 h-16 rounded-full shadow-lg hover:shadow-xl transform hover:scale-110 transition-all duration-200 z-50 flex items-center justify-center" style="bottom: 92px;">
        <div class="text-2xl">ğŸ’Œ</div>
      </button>

      <button onclick="showPage('teacherLogin')" class="fixed bottom-6 right-6 bg-gradient-to-br from-purple-300 to-pink-400 text-white w-16 h-16 rounded-full shadow-lg hover:shadow-xl transform hover:scale-110 transition-all duration-200 z-50 flex items-center justify-center">
        <div class="text-2xl">ğŸ‘©â€ğŸ«</div>
      </button>
    </div>

    <!-- í•™ìƒ ì‘ì„± -->
    <div id="studentPage" class="hidden container mx-auto px-4 py-8">
      <div class="max-w-2xl mx-auto">
        <div class="bg-white rounded-3xl shadow-xl p-8 fade-in">
          <div class="flex items-center justify-between mb-8">
            <h2 class="text-3xl font-bold text-gray-800">ğŸ“ ê°ì •ì¼ê¸° ì‘ì„±</h2>
            <button onclick="showPage('mainPage')" class="text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
          </div>

          <form id="emotionForm" class="space-y-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ë²ˆí˜¸</label>
              <select id="studentNumber" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white">
                <option value="">ë²ˆí˜¸ ì„ íƒ</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-4">ì˜¤ëŠ˜ì˜ ê°ì •</label>

              <div class="mb-6">
                <h4 class="text-sm font-semibold text-green-700 mb-3 flex items-center"><span class="mr-2">ğŸŒ¿</span>ê¸ì •ì ì¸ ê°ì •</h4>
                <div id="positiveEmotions" class="grid grid-cols-5 gap-2"></div>
              </div>
              <div class="mb-6">
                <h4 class="text-sm font-semibold text-red-700 mb-3 flex items-center"><span class="mr-2">ğŸŒ§</span>ë¶€ì •ì ì¸ ê°ì •</h4>
                <div id="negativeEmotions" class="grid grid-cols-5 gap-2"></div>
              </div>
              <div class="mb-6">
                <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center"><span class="mr-2">ğŸŒ—</span>ì¤‘ë¦½Â·ë³µí•© ê°ì •</h4>
                <div id="neutralEmotions" class="grid grid-cols-5 gap-2"></div>
              </div>

              <div class="mb-4">
                <button type="button" onclick="showCustomEmotionInput()" class="w-full bg-blue-50 hover:bg-blue-100 border-2 border-dashed border-blue-300 text-blue-700 font-medium py-3 px-4 rounded-xl transition-all duration-200">
                  âœï¸ ì§ì ‘ ì…ë ¥í•˜ê¸°
                </button>
              </div>
              <div id="customEmotionContainer" class="hidden mb-4">
                <div class="flex gap-2">
                  <input type="text" id="customEmotionInput" placeholder="ê°ì •ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì‹ ë‚¨)" class="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500">
                  <button type="button" onclick="handleCustomEmotion()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-xl">í™•ì¸</button>
                  <button type="button" onclick="hideCustomEmotionInput()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-xl">ì·¨ì†Œ</button>
                </div>
              </div>

              <input type="hidden" id="selectedEmotion" required>
              <input type="hidden" id="selectedEmoji" required>
              <input type="hidden" id="selectedCategory">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ê°ì •ì˜ ì´ìœ </label>
              <textarea id="emotionReason" rows="4" required placeholder="ì˜¤ëŠ˜ ì´ëŸ° ê°ì •ì„ ëŠë‚€ ì´ìœ ë¥¼ ìì„¸íˆ ì ì–´ì£¼ì„¸ìš”..." class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
            </div>

            <div class="space-y-3">
              <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 text-white font-semibold py-4 px-6 rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">ğŸ’¾ ê°ì •ì¼ê¸° ì €ì¥í•˜ê¸°</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- ìª½ì§€ ë³´ë‚´ê¸° -->
    <div id="noteToTeacherPage" class="hidden container mx-auto px-4 py-8">
      <div class="max-w-2xl mx-auto">
        <div class="bg-white rounded-3xl shadow-xl p-8 fade-in">
          <div class="flex items-center justify-between mb-8">
            <h2 class="text-3xl font-bold text-gray-800">ğŸ’Œ ì„ ìƒë‹˜ê»˜ ìª½ì§€ ë³´ë‚´ê¸°</h2>
            <button onclick="showPage('mainPage')" class="text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
          </div>
          <p class="text-gray-600 mb-6">ì„ ìƒë‹˜ê»˜ í•˜ê³  ì‹¶ì€ ì´ì•¼ê¸°, ë¹„ë°€ìŠ¤ëŸ¬ìš´ ê³ ë¯¼ ë“±ì„ ì ì–´ì£¼ì„¸ìš”. ì„ ìƒë‹˜ë§Œ ë³¼ ìˆ˜ ìˆì–´ìš”!</p>

          <form id="noteForm" class="space-y-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ë²ˆí˜¸</label>
              <select id="noteStudentNumber" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent bg-white">
                <option value="">ë²ˆí˜¸ ì„ íƒ</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ìª½ì§€ ë‚´ìš©</label>
              <textarea id="noteContent" rows="6" required placeholder="ì„ ìƒë‹˜ê»˜ ì „í•  ìª½ì§€ ë‚´ìš©ì„ ì‘ì„±í•´ì£¼ì„¸ìš”..." class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 resize-none"></textarea>
            </div>

            <div class="space-y-3">
              <button type="submit" class="w-full bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 text-white font-semibold py-4 px-6 rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">ğŸ’Œ ìª½ì§€ ì „ì†¡í•˜ê¸°</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- ì¹œêµ¬ë“¤ ê°ì • -->
    <div id="friendsPage" class="hidden container mx-auto px-4 py-8">
      <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-3xl shadow-xl p-8 fade-in">
          <div class="flex items-center justify-between mb-8">
            <h2 class="text-3xl font-bold text-gray-800">ğŸ‘« ì¹œêµ¬ë“¤ ê°ì • í™•ì¸í•˜ê¸°</h2>
            <button onclick="showPage('mainPage')" class="text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
          </div>
          <div class="relative bg-gradient-to-br from-blue-100 to-purple-100 rounded-3xl p-8 min-h-[24rem] overflow-hidden">
            <div class="text-center mb-6">
              <h3 class="text-xl font-bold text-gray-800">ğŸŒˆ ìš°ë¦¬ë°˜ ì¹œêµ¬ë“¤ì˜ ê°ì •</h3>
              <p class="text-sm text-gray-600 mt-2">ì´ëª¨í‹°ì½˜ì„ í„°ì¹˜í•´ë³´ì„¸ìš”!</p>
            </div>
            <div id="floatingEmotions" class="relative w-full h-80"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- í•™ìƒ ë¡œê·¸ì¸ -->
    <div id="studentLogin" class="hidden container mx-auto px-4 py-8">
      <div class="flex items-center justify-center min-h-screen">
        <div class="max-w-md w-full">
          <div class="bg-white rounded-3xl shadow-xl p-8 fade-in">
            <div class="flex items-center justify-between mb-8">
              <h2 class="text-2xl font-bold text-gray-800">ğŸ“Š ë‚´ ê°ì • ë¦¬í¬íŠ¸</h2>
              <button onclick="showPage('mainPage')" class="text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
            </div>
            <form id="studentLoginForm" class="space-y-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ë²ˆí˜¸</label>
                <select id="studentLoginNumber" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white">
                  <option value="">ë²ˆí˜¸ ì„ íƒ</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ë¹„ë°€ë²ˆí˜¸ (4ìë¦¬)</label>
                <input type="password" id="studentLoginPassword" required maxlength="4" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500" placeholder="ì„ ìƒë‹˜ê»˜ ë°›ì€ 4ìë¦¬ ìˆ«ì">
              </div>
              <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 text-white font-semibold py-4 px-6 rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition">ë¡œê·¸ì¸</button>
            </form>
            <div id="studentLoginError" class="hidden mt-4 p-3 bg-red-100 border border-red-300 text-red-700 rounded-xl text-sm text-center">ë²ˆí˜¸ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- êµì‚¬ ë¡œê·¸ì¸ -->
    <div id="teacherLogin" class="hidden container mx-auto px-4 py-8">
      <div class="flex items-center justify-center min-h-screen">
        <div class="max-w-md w-full">
          <div class="bg-white rounded-3xl shadow-xl p-8 fade-in">
            <div class="flex items-center justify-between mb-8">
              <h2 class="text-2xl font-bold text-gray-800">ğŸ” êµì‚¬ ë¡œê·¸ì¸</h2>
              <button onclick="showPage('mainPage')" class="text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
            </div>
            <form id="teacherLoginForm" class="space-y-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="teacherPassword" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500">
              </div>
              <button type="submit" onclick="handleTeacherLogin(event)" class="w-full bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 text-white font-semibold py-4 px-6 rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition">ë¡œê·¸ì¸</button>
            </form>
            <div id="loginError" class="hidden mt-4 p-3 bg-red-100 border border-red-300 text-red-700 rounded-xl text-sm text-center">ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- êµì‚¬ ëŒ€ì‹œë³´ë“œ -->
    <div id="teacherDashboard" class="hidden container mx-auto px-4 py-8">
      <div class="max-w-7xl mx-auto">
        <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
          <h1 class="text-3xl font-bold text-gray-800">ğŸ‘©â€ğŸ« êµì‚¬ ëŒ€ì‹œë³´ë“œ</h1>
          <div class="flex items-center gap-4">
            <input type="date" id="dashboardDate" class="px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <input type="month" id="dashboardMonth" class="hidden px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <button id="refreshDataBtn" onclick="refreshDashboardData()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">ìƒˆë¡œê³ ì¹¨</button>
            <button onclick="clearLocalCache()" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">ë¡œì»¬ ìºì‹œ ì‚­ì œ</button>
            <button onclick="logoutTeacher()" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">ë¡œê·¸ì•„ì›ƒ</button>
          </div>
        </div>

        <div class="border-b border-gray-200 mb-6">
          <nav class="-mb-px flex gap-4" aria-label="Tabs">
            <button onclick="switchDashboardTab('daily')"   id="dailyTab"   class="tab-button whitespace-nowrap py-3 px-5 font-semibold text-gray-500 hover:text-indigo-600 border-b-2 border-transparent">ì¼ë³„ ë¦¬í¬íŠ¸</button>
            <button onclick="switchDashboardTab('monthly')" id="monthlyTab" class="tab-button whitespace-nowrap py-3 px-5 font-semibold text-gray-500 hover:text-indigo-600 border-b-2 border-transparent">ì›”ë³„ ë¦¬í¬íŠ¸</button>
            <button onclick="switchDashboardTab('notes')"   id="notesTab"   class="tab-button whitespace-nowrap py-3 px-5 font-semibold text-gray-500 hover:text-indigo-600 border-b-2 border-transparent">í•™ìƒ ìª½ì§€í•¨</button>
          </nav>
        </div>

        <div id="dailyReportContent">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-2xl shadow-lg"><h3 class="font-bold text-gray-600">ê¸°ë¡í•œ í•™ìƒ</h3><p id="todaySubmissionCount" class="text-3xl font-bold text-blue-600"></p></div>
            <div class="bg-white p-6 rounded-2xl shadow-lg"><h3 class="font-bold text-gray-600">ê¸ì • ê°ì •</h3><p id="todayPositiveCount" class="text-3xl font-bold text-green-600"></p></div>
            <div class="bg-white p-6 rounded-2xl shadow-lg"><h3 class="font-bold text-gray-600">ë¶€ì • ê°ì •</h3><p id="todayNegativeCount" class="text-3xl font-bold text-red-600"></p></div>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-2xl shadow-lg">
              <h2 id="dailyDistributionTitle" class="text-xl font-bold mb-4"></h2>
              <div class="chart-container"><canvas id="dailyDistributionChart"></canvas></div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-lg">
              <h2 id="dailyEntriesTitle" class="text-xl font-bold mb-4"></h2>
              <div id="dailyEntriesList" class="space-y-4 max-h-96 overflow-y-auto pr-2"></div>
            </div>
          </div>

          <div class="bg-white p-6 rounded-2xl shadow-lg mt-8">
            <h2 class="text-xl font-bold mb-4">í•™ìƒë³„ ë¦¬í¬íŠ¸ (í•™ìƒ í´ë¦­í•˜ì—¬ ì´ë™)</h2>
            <div id="studentReportLinks" class="grid grid-cols-6 gap-2"></div>
          </div>
        </div>

        <div id="monthlyReportContent" class="hidden">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-2xl shadow-lg"><h3 class="font-bold text-gray-600">ì›” ê¸ì • ê°ì •</h3><p id="monthlyPositiveCount" class="text-3xl font-bold text-green-600"></p></div>
            <div class="bg-white p-6 rounded-2xl shadow-lg"><h3 class="font-bold text-gray-600">ì›” ì¤‘ë¦½ ê°ì •</h3><p id="monthlyNeutralCount" class="text-3xl font-bold text-yellow-600"></p></div>
            <div class="bg-white p-6 rounded-2xl shadow-lg"><h3 class="font-bold text-gray-600">ì›” ë¶€ì • ê°ì •</h3><p id="monthlyNegativeCount" class="text-3xl font-bold text-red-600"></p></div>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-2xl shadow-lg">
              <h2 class="text-xl font-bold mb-4">ì›”ë³„ ê°ì • ë¶„í¬</h2>
              <div class="chart-container"><canvas id="monthlyDistributionChart"></canvas></div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-lg">
              <h2 class="text-xl font-bold mb-4">ì¼ë³„ ê°ì • ì¶”ì´</h2>
              <div class="chart-container"><canvas id="monthlyTrendChart"></canvas></div>
            </div>
          </div>
        </div>

        <div id="notesContent" class="hidden">
          <div class="bg-white p-6 rounded-2xl shadow-lg">
            <h2 class="text-xl font-bold mb-4">ğŸ“® ë„ì°©í•œ ìª½ì§€ (ìµœì‹ ìˆœ)</h2>
            <div id="notesList" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
              <div class="text-center text-gray-500 py-10">ë¡œë”© ì¤‘...</div>
            </div>
            <div id="notesLoadingError" class="hidden text-red-500 text-center mt-4">ìª½ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- í•™ìƒ ë¦¬í¬íŠ¸ -->
    <div id="studentReportPage" class="hidden container mx-auto px-4 py-8">
      <div class="max-w-4xl mx-auto">
        <div id="studentReportHeader">
          <div class="flex flex-wrap justify-between items-center mb-8 gap-4">
            <div>
              <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ“Š í•™ìƒ ê°ì • ë¦¬í¬íŠ¸</h1>
              <p id="studentReportNumber" class="text-xl text-gray-600"></p>
            </div>
            <div class="flex items-center gap-4">
              <input type="month" id="studentReportMonth" class="px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
              <div id="reportActionButtons" class="flex gap-2">
                <button id="dashboardButton" onclick="showPage('teacherDashboard')" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">ëŒ€ì‹œë³´ë“œë¡œ</button>
                <button id="mainPageButton" onclick="showPage('mainPage')" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg">ë©”ì¸ìœ¼ë¡œ</button>
              </div>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-blue-50 rounded-xl p-4 text-center">
              <div class="text-sm text-gray-600">ì´ ê¸°ë¡ ìˆ˜</div>
              <div id="myTotalRecords" class="text-2xl font-bold text-blue-600">0</div>
            </div>
            <div class="bg-green-50 rounded-xl p-4 text-center">
              <div class="text-sm text-gray-600">ê¸ì •</div>
              <div id="myPositiveCount" class="text-2xl font-bold text-green-600">0</div>
            </div>
            <div class="bg-gray-100 rounded-xl p-4 text-center">
              <div class="text-sm text-gray-600">ì¤‘ë¦½</div>
              <div id="myNeutralCount" class="text-2xl font-bold text-gray-600">0</div>
            </div>
            <div class="bg-red-50 rounded-xl p-4 text-center">
              <div class="text-sm text-gray-600">ë¶€ì •</div>
              <div id="myNegativeCount" class="text-2xl font-bold text-red-600">0</div>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg p-6 mt-6">
          <h3 id="candyJarTitle" class="text-xl font-bold text-gray-800 mb-6">ğŸ¬ (ì„ íƒí•œ ë‹¬)ì˜ ê°ì • ë³´ê´€í•¨</h3>
          <div class="relative w-full h-[45rem] flex items-center justify-center bg-gray-50 rounded-2xl p-4 overflow-hidden">
            <!-- ìœ ë¦¬ë³‘ ì´ë¯¸ì§€ëŠ” ê°™ì€ í´ë”ì— jar.png íŒŒì¼ì´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤ -->
            <div class="absolute inset-0 bg-contain bg-no-repeat bg-center" style="background-image:url('jar.png'); transform: scale(1.09);"></div>
            <div id="candyContainer" class="w-full h-full relative overflow-hidden pt-10"></div>
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg p-6 mt-6">
          <h3 id="monthlyRecordsTitle" class="text-xl font-bold text-gray-800 mb-6">ì„ íƒí•œ ë‹¬ì˜ ì „ì²´ ê¸°ë¡</h3>
          <div id="myRecentRecords" class="space-y-4 max-h-96 overflow-y-auto"></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6 mt-6">
          <div class="bg-white rounded-2xl shadow-lg p-6">
            <h3 id="myEmotionTitle" class="text-xl font-bold text-gray-800 mb-4">ì„ íƒí•œ ë‹¬ì˜ ê°ì •ë¶„í¬</h3>
            <div class="chart-container"><canvas id="myEmotionChart"></canvas></div>
          </div>
          <div class="bg-white rounded-2xl shadow-lg p-6">
            <h3 id="myTrendTitle" class="text-xl font-bold text-gray-800 mb-4">ì„ íƒí•œ ë‹¬ì˜ ê°ì •ë³€í™”</h3>
            <div class="chart-container"><canvas id="myTrendChart"></canvas></div>
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
          <h3 class="text-xl font-bold text-gray-800 mb-6">ğŸ† ìì£¼ ëŠë¼ëŠ” ê°ì • TOP 5 (ì „ì²´)</h3>
          <div id="myTopEmotions" class="space-y-3"></div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
          <h3 class="text-xl font-bold text-gray-800 mb-6">ğŸ’– ì„ ìƒë‹˜ì˜ í•œ ë§ˆë””</h3>
          <div class="mb-4">
            <button id="generateAdviceBtn" onclick="fetchAIAdvice()" class="w-full bg-gradient-to-r from-purple-500 to-indigo-500 text-white font-semibold py-3 px-5 rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
              ì¡°ì–¸ ìƒì„±í•˜ê¸°
            </button>
          </div>
          <div id="aiAdvice" class="p-4 bg-purple-50 rounded-lg text-purple-800 min-h-[50px]">
            <p class="text-sm text-gray-500">ë²„íŠ¼ì„ ëˆŒëŸ¬ ì„ ìƒë‹˜ì˜ ê²©ë ¤ ë©”ì‹œì§€ë¥¼ ìƒì„±í•´ ë³´ì„¸ìš”.</p>
          </div>
        </div>
      </div>
    </div>

    <div id="sharedReportPage" class="hidden"></div>
  </div>

  <!-- ëª¨ë‹¬/íˆ´íŒ/í† ìŠ¤íŠ¸ -->
  <div id="categoryModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[1001]">
    <div class="bg-white p-8 rounded-2xl shadow-xl text-center w-full max-w-sm m-4">
      <h3 class="font-bold text-xl mb-4">ì´ ê°ì •ì€ ì–´ë–¤ ì¢…ë¥˜ì¸ê°€ìš”?</h3>
      <p id="fallbackEmotionText" class="mb-6 text-gray-600"></p>
      <div class="flex justify-center gap-3">
        <button onclick="setCustomCategory('positive')" class="flex-1 bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg font-semibold transition">ê¸ì •</button>
        <button onclick="setCustomCategory('negative')" class="flex-1 bg-red-500 hover:bg-red-600 text-white px-4 py-3 rounded-lg font-semibold transition">ë¶€ì •</button>
        <button onclick="setCustomCategory('neutral')" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-lg font-semibold transition">ì¤‘ë¦½</button>
      </div>
    </div>
  </div>

  <div id="tooltip" class="tooltip"></div>
  <div id="toast" class="hidden fixed bottom-5 left-1/2 -translate-x-1/2 bg-yellow-400 text-gray-800 font-semibold py-3 px-6 rounded-lg shadow-xl transform transition-all duration-300 opacity-0"></div>
</body>
</html>
